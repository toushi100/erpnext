!function(){"use strict";"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var t,e=(function(t,e){var i;t.exports=i={attachTo:function(t,e){if(void 0!==t.scannerDetectionData)throw new Error("onScan.js is already initialized for DOM element "+t);var n={onScan:function(t,e){},onScanError:function(t){},onKeyProcess:function(t,e){},onKeyDetect:function(t,e){},onPaste:function(t,e){},keyCodeMapper:function(t){return i.decodeKeyEvent(t)},onScanButtonLongPress:function(){},scanButtonKeyCode:!1,scanButtonLongPressTime:500,timeBeforeScanTest:100,avgTimeByChar:30,minLength:6,suffixKeyCodes:[9,13],prefixKeyCodes:[],ignoreIfFocusOn:!1,stopPropagation:!1,preventDefault:!1,captureEvents:!1,reactToKeydown:!0,reactToPaste:!1,singleScanQty:1};return e=this._mergeOptions(n,e),t.scannerDetectionData={options:e,vars:{firstCharTime:0,lastCharTime:0,accumulatedString:"",testTimer:!1,longPressTimeStart:0,longPressed:!1}},!0===e.reactToPaste&&t.addEventListener("paste",this._handlePaste,e.captureEvents),!1!==e.scanButtonKeyCode&&t.addEventListener("keyup",this._handleKeyUp,e.captureEvents),!0!==e.reactToKeydown&&!1===e.scanButtonKeyCode||t.addEventListener("keydown",this._handleKeyDown,e.captureEvents),this},detachFrom:function(t){t.scannerDetectionData.options.reactToPaste&&t.removeEventListener("paste",this._handlePaste),!1!==t.scannerDetectionData.options.scanButtonKeyCode&&t.removeEventListener("keyup",this._handleKeyUp),t.removeEventListener("keydown",this._handleKeyDown),t.scannerDetectionData=void 0},getOptions:function(t){return t.scannerDetectionData.options},setOptions:function(t,e){switch(t.scannerDetectionData.options.reactToPaste){case!0:!1===e.reactToPaste&&t.removeEventListener("paste",this._handlePaste);break;case!1:!0===e.reactToPaste&&t.addEventListener("paste",this._handlePaste)}switch(t.scannerDetectionData.options.scanButtonKeyCode){case!1:!1!==e.scanButtonKeyCode&&t.addEventListener("keyup",this._handleKeyUp);break;default:!1===e.scanButtonKeyCode&&t.removeEventListener("keyup",this._handleKeyUp)}return t.scannerDetectionData.options=this._mergeOptions(t.scannerDetectionData.options,e),this._reinitialize(t),this},decodeKeyEvent:function(t){var e=this._getNormalizedKeyNum(t);switch(!0){case e>=48&&e<=90:case e>=106&&e<=111:if(void 0!==t.key&&""!==t.key)return t.key;var i=String.fromCharCode(e);switch(t.shiftKey){case!1:i=i.toLowerCase();break;case!0:i=i.toUpperCase()}return i;case e>=96&&e<=105:return e-96+0}return""},simulate:function(t,e){return this._reinitialize(t),Array.isArray(e)?e.forEach(function(t){var e={};"object"!=typeof t&&"function"!=typeof t||null===t?e.keyCode=parseInt(t):e=t;var i=new KeyboardEvent("keydown",e);document.dispatchEvent(i)}):this._validateScanCode(t,e),this},_reinitialize:function(t){var e=t.scannerDetectionData.vars;e.firstCharTime=0,e.lastCharTime=0,e.accumulatedString=""},_isFocusOnIgnoredElement:function(t){var e=t.scannerDetectionData.options.ignoreIfFocusOn;if(!e)return!1;var i=document.activeElement;if(Array.isArray(e)){for(var n=0;n<e.length;n++)if(!0===i.matches(e[n]))return!0}else if(i.matches(e))return!0;return!1},_validateScanCode:function(t,e){var n,a=t.scannerDetectionData,s=a.options,o=a.options.singleScanQty,r=a.vars.firstCharTime,c=a.vars.lastCharTime,d={};switch(!0){case e.length<s.minLength:d={message:"Receieved code is shorter then minimal length"};break;case c-r>e.length*s.avgTimeByChar:d={message:"Receieved code was not entered in time"};break;default:return s.onScan.call(t,e,o),n=new CustomEvent("scan",{detail:{scanCode:e,qty:o}}),t.dispatchEvent(n),i._reinitialize(t),!0}return d.scanCode=e,d.scanDuration=c-r,d.avgTimeByChar=s.avgTimeByChar,d.minLength=s.minLength,s.onScanError.call(t,d),n=new CustomEvent("scanError",{detail:d}),t.dispatchEvent(n),i._reinitialize(t),!1},_mergeOptions:function(t,e){var i,n={};for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i]);for(i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i]);return n},_getNormalizedKeyNum:function(t){return t.which||t.keyCode},_handleKeyDown:function(t){var e=i._getNormalizedKeyNum(t),n=this.scannerDetectionData.options,a=this.scannerDetectionData.vars,s=!1;if(!1!==n.onKeyDetect.call(this,e,t)&&!i._isFocusOnIgnoredElement(this))if(!1===n.scanButtonKeyCode||e!=n.scanButtonKeyCode){switch(!0){case a.firstCharTime&&-1!==n.suffixKeyCodes.indexOf(e):t.preventDefault(),t.stopImmediatePropagation(),s=!0;break;case!a.firstCharTime&&-1!==n.prefixKeyCodes.indexOf(e):t.preventDefault(),t.stopImmediatePropagation(),s=!1;break;default:var o=n.keyCodeMapper.call(this,t);if(null===o)return;a.accumulatedString+=o,n.preventDefault&&t.preventDefault(),n.stopPropagation&&t.stopImmediatePropagation(),s=!1}a.firstCharTime||(a.firstCharTime=Date.now()),a.lastCharTime=Date.now(),a.testTimer&&clearTimeout(a.testTimer),s?(i._validateScanCode(this,a.accumulatedString),a.testTimer=!1):a.testTimer=setTimeout(i._validateScanCode,n.timeBeforeScanTest,this,a.accumulatedString),n.onKeyProcess.call(this,o,t)}else a.longPressed||(a.longPressTimer=setTimeout(n.onScanButtonLongPress,n.scanButtonLongPressTime,this),a.longPressed=!0)},_handlePaste:function(t){var e=this.scannerDetectionData.options,n=this.scannerDetectionData.vars,a=(event.clipboardData||window.clipboardData).getData("text");i._isFocusOnIgnoredElement(this)||(t.preventDefault(),e.stopPropagation&&t.stopImmediatePropagation(),e.onPaste.call(this,a,event),n.firstCharTime=0,n.lastCharTime=0,i._validateScanCode(this,a))},_handleKeyUp:function(t){if(!i._isFocusOnIgnoredElement(this)){var e=i._getNormalizedKeyNum(t);e==this.scannerDetectionData.options.scanButtonKeyCode&&(clearTimeout(this.scannerDetectionData.vars.longPressTimer),this.scannerDetectionData.vars.longPressed=!1)}},isScanInProgressFor:function(t){return t.scannerDetectionData.vars.firstCharTime>0},isAttachedTo:function(t){return void 0!==t.scannerDetectionData}}}(t={exports:{}},t.exports),t.exports);erpnext.PointOfSale.ItemSelector=class{constructor(t){t.frm;var e=t.wrapper,i=t.events,n=t.pos_profile,a=t.settings;this.wrapper=e,this.events=i,this.pos_profile=n,this.hide_images=a.hide_images,this.auto_add_item=a.auto_add_item_to_cart,this.inti_component()}inti_component(){this.prepare_dom(),this.make_search_bar(),this.load_items_data(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="items-selector">\n\t\t\t\t<div class="filter-section">\n\t\t\t\t\t<div class="label">All Items</div>\n\t\t\t\t\t<div class="search-field"></div>\n\t\t\t\t\t<div class="item-group-field"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="items-container"></div>\n\t\t\t</section>'),this.$component=this.wrapper.find(".items-selector"),this.$items_container=this.$component.find(".items-container")}async load_items_data(){var t=this;if(!this.item_group){var e=await frappe.db.get_value("Item Group",{lft:1,is_group:1},"name");this.parent_item_group=e.message.name}if(!this.price_list){var i=await frappe.db.get_value("POS Profile",this.pos_profile,"selling_price_list");this.price_list=i.message.selling_price_list}this.get_items({}).then(function(e){var i=e.message;t.render_item_list(i.items)})}get_items(t){var e=t.start;void 0===e&&(e=0);var i=t.page_length;void 0===i&&(i=40);var n=t.search_term;void 0===n&&(n="");var a=this.events.get_frm().doc,s=a&&a.selling_price_list||this.price_list,o=this.item_group,r=this.pos_profile;return!o&&(o=this.parent_item_group),frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.get_items",freeze:!0,args:{start:e,page_length:i,price_list:s,item_group:o,search_term:n,pos_profile:r}})}render_item_list(t){var e=this;this.$items_container.html(""),t.forEach(function(t){var i=e.get_item_html(t);e.$items_container.append(i)})}get_item_html(t){var e=this,i=t.item_image,n=t.serial_no,a=t.batch_no,s=(t.barcode,t.actual_qty),o=t.stock_uom,r=t.price_list_rate,c=s>10?"green":s<=0?"red":"orange",d=flt(r,2)%1!=0?2:0,_=s;return Math.round(_)>999&&(_=(_=Math.round(_)/1e3).toFixed(1)+"K"),'<div class="item-wrapper"\n\t\t\t\tdata-item-code="'+escape(t.item_code)+'" data-serial-no="'+escape(n)+'"\n\t\t\t\tdata-batch-no="'+escape(a)+'" data-uom="'+escape(o)+'"\n\t\t\t\tdata-rate="'+escape(r)+'"\n\t\t\t\ttitle="'+t.item_name+'">\n\n\t\t\t\t'+(!e.hide_images&&i?'<div class="item-qty-pill">\n\t\t\t\t\t\t\t<span class="indicator-pill whitespace-nowrap '+c+'">'+_+'</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="flex items-center justify-center h-32 border-b-grey text-6xl text-grey-100">\n\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\tonerror="cur_pos.item_selector.handle_broken_image(this)"\n\t\t\t\t\t\t\t\tclass="h-full" src="'+i+'"\n\t\t\t\t\t\t\t\talt="'+frappe.get_abbr(t.item_name)+'"\n\t\t\t\t\t\t\t\tstyle="object-fit: cover;">\n\t\t\t\t\t\t</div>':'<div class="item-qty-pill">\n\t\t\t\t\t\t\t<span class="indicator-pill whitespace-nowrap '+c+'">'+_+'</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="item-display abbr">'+frappe.get_abbr(t.item_name)+"</div>")+'\n\n\t\t\t\t<div class="item-detail">\n\t\t\t\t\t<div class="item-name">\n\t\t\t\t\t\t'+frappe.ellipsis(t.item_name,18)+'\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="item-rate">'+(format_currency(r,t.currency,d)||0)+"</div>\n\t\t\t\t</div>\n\t\t\t</div>"}handle_broken_image(t){var e=$(t).attr("alt");$(t).parent().replaceWith('<div class="item-display abbr">'+e+"</div>")}make_search_bar(){var t=this,e=t.events.get_frm().doc;this.$component.find(".search-field").html(""),this.$component.find(".item-group-field").html(""),this.search_field=frappe.ui.form.make_control({df:{label:__("Search"),fieldtype:"Data",placeholder:__("Search by item code, serial number or barcode")},parent:this.$component.find(".search-field"),render_input:!0}),this.item_group_field=frappe.ui.form.make_control({df:{label:__("Item Group"),fieldtype:"Link",options:"Item Group",placeholder:__("Select item group"),onchange:function(){t.item_group=this.value,!t.item_group&&(t.item_group=t.parent_item_group),t.filter_items()},get_query:function(){return{query:"erpnext.selling.page.point_of_sale.point_of_sale.item_group_query",filters:{pos_profile:e?e.pos_profile:""}}}},parent:this.$component.find(".item-group-field"),render_input:!0}),this.search_field.toggle_label(!1),this.item_group_field.toggle_label(!1)}set_search_value(t){$(this.search_field.$input[0]).val(t).trigger("input")}bind_events(){var t=this,i=this;window.onScan=e,e.decodeKeyEvent=function(t){var e=this._getNormalizedKeyNum(t);switch(!0){case e>=48&&e<=90:case e>=106&&e<=111:case e>=160&&e<=164||170==e:case e>=186&&e<=194:case e>=219&&e<=222:case 32==e:if(void 0!==t.key&&""!==t.key)return t.key;var i=String.fromCharCode(e);switch(t.shiftKey){case!1:i=i.toLowerCase();break;case!0:i=i.toUpperCase()}return i;case e>=96&&e<=105:return e-96+0}return""},e.attachTo(document,{onScan:function(e){t.search_field&&t.$component.is(":visible")&&(t.search_field.set_focus(),t.set_search_value(e),t.barcode_scanned=!0)}}),this.$component.on("click",".item-wrapper",function(){var t=$(this),e=unescape(t.attr("data-item-code")),n=unescape(t.attr("data-batch-no")),a=unescape(t.attr("data-serial-no")),s=unescape(t.attr("data-uom")),o=unescape(t.attr("data-rate"));n="undefined"===n?void 0:n,a="undefined"===a?void 0:a,s="undefined"===s?void 0:s,o="undefined"===o?void 0:o,i.events.item_selected({field:"qty",value:"+1",item:{item_code:e,batch_no:n,serial_no:a,uom:s,rate:o}}),i.set_search_value("")}),this.search_field.$input.on("input",function(e){clearTimeout(t.last_search),t.last_search=setTimeout(function(){var i=e.target.value;t.filter_items({search_term:i})},300)})}attach_shortcuts(){var t=this,e=frappe.utils.is_mac()?"⌘":"Ctrl";this.search_field.parent.attr("title",e+"+I"),frappe.ui.keys.add_shortcut({shortcut:"ctrl+i",action:function(){return t.search_field.set_focus()},condition:function(){return t.$component.is(":visible")},description:__("Focus on search input"),ignore_inputs:!0,page:cur_page.page.page}),this.item_group_field.parent.attr("title",e+"+G"),frappe.ui.keys.add_shortcut({shortcut:"ctrl+g",action:function(){return t.item_group_field.set_focus()},condition:function(){return t.$component.is(":visible")},description:__("Focus on Item Group filter"),ignore_inputs:!0,page:cur_page.page.page}),frappe.ui.keys.on("enter",function(){t.$component.is(":visible")&&""!==t.search_field.get_value()&&(1==t.items.length?(t.$items_container.find(".item-wrapper").click(),frappe.utils.play_sound("submit"),$(t.search_field.$input[0]).val("").trigger("input")):0==t.items.length&&t.barcode_scanned&&(frappe.show_alert({message:__("No items found. Scan barcode again."),indicator:"orange"}),frappe.utils.play_sound("error"),t.barcode_scanned=!1,$(t.search_field.$input[0]).val("").trigger("input")))})}filter_items(t){var e=this;void 0===t&&(t={});var i=t.search_term;if(void 0===i&&(i=""),i&&(i=i.toLowerCase(),this.search_index=this.search_index||{},this.search_index[i])){var n=this.search_index[i];return this.items=n,this.render_item_list(n),void(this.auto_add_item&&1==this.items.length&&this.add_filtered_item_to_cart())}this.get_items({search_term:i}).then(function(t){var n=t.message,a=n.items,s=(n.serial_no,n.batch_no,n.barcode);i&&!s&&(e.search_index[i]=a),e.items=a,e.render_item_list(a),e.auto_add_item&&1==e.items.length&&e.add_filtered_item_to_cart()})}add_filtered_item_to_cart(){this.$items_container.find(".item-wrapper").click()}resize_selector(t){t?this.$component.find(".filter-section").css("grid-template-columns","repeat(1, minmax(0, 1fr))"):this.$component.find(".filter-section").css("grid-template-columns","repeat(12, minmax(0, 1fr))"),t?this.$component.find(".search-field").css("margin","var(--margin-sm) 0px"):this.$component.find(".search-field").css("margin","0px var(--margin-sm)"),t?this.$component.css("grid-column","span 2 / span 2"):this.$component.css("grid-column","span 6 / span 6"),t?this.$items_container.css("grid-template-columns","repeat(1, minmax(0, 1fr))"):this.$items_container.css("grid-template-columns","repeat(4, minmax(0, 1fr))")}toggle_component(t){t?this.$component.css("display","flex"):this.$component.css("display","none")}},erpnext.PointOfSale.ItemCart=class{constructor(t){var e=t.wrapper,i=t.events,n=t.settings;this.wrapper=e,this.events=i,this.customer_info=void 0,this.hide_images=n.hide_images,this.allowed_customer_groups=n.customer_groups,this.allow_rate_change=n.allow_rate_change,this.allow_discount_change=n.allow_discount_change,this.init_component()}init_component(){this.prepare_dom(),this.init_child_components(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="customer-cart-container"></section>'),this.$component=this.wrapper.find(".customer-cart-container")}init_child_components(){this.init_customer_selector(),this.init_cart_components()}init_customer_selector(){this.$component.append('<div class="customer-section"></div>'),this.$customer_section=this.$component.find(".customer-section"),this.make_customer_selector()}reset_customer_selector(){this.events.get_frm().set_value("customer",""),this.make_customer_selector(),this.customer_field.set_focus()}init_cart_components(){this.$component.append('<div class="cart-container">\n\t\t\t\t<div class="abs-cart-container">\n\t\t\t\t\t<div class="cart-label">Item Cart</div>\n\t\t\t\t\t<div class="cart-header">\n\t\t\t\t\t\t<div class="name-header">Item</div>\n\t\t\t\t\t\t<div class="qty-header">Qty</div>\n\t\t\t\t\t\t<div class="rate-amount-header">Amount</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="cart-items-section"></div>\n\t\t\t\t\t<div class="cart-totals-section"></div>\n\t\t\t\t\t<div class="numpad-section"></div>\n\t\t\t\t</div>\n\t\t\t</div>'),this.$cart_container=this.$component.find(".cart-container"),this.make_cart_totals_section(),this.make_cart_items_section(),this.make_cart_numpad()}make_cart_items_section(){this.$cart_header=this.$component.find(".cart-header"),this.$cart_items_wrapper=this.$component.find(".cart-items-section"),this.make_no_items_placeholder()}make_no_items_placeholder(){this.$cart_header.css("display","none"),this.$cart_items_wrapper.html('<div class="no-item-wrapper">No items in cart</div>')}get_discount_icon(){return'<svg class="discount-icon" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t<path d="M19 15.6213C19 15.2235 19.158 14.842 19.4393 14.5607L20.9393 13.0607C21.5251 12.4749 21.5251 11.5251 20.9393 10.9393L19.4393 9.43934C19.158 9.15804 19 8.7765 19 8.37868V6.5C19 5.67157 18.3284 5 17.5 5H15.6213C15.2235 5 14.842 4.84196 14.5607 4.56066L13.0607 3.06066C12.4749 2.47487 11.5251 2.47487 10.9393 3.06066L9.43934 4.56066C9.15804 4.84196 8.7765 5 8.37868 5H6.5C5.67157 5 5 5.67157 5 6.5V8.37868C5 8.7765 4.84196 9.15804 4.56066 9.43934L3.06066 10.9393C2.47487 11.5251 2.47487 12.4749 3.06066 13.0607L4.56066 14.5607C4.84196 14.842 5 15.2235 5 15.6213V17.5C5 18.3284 5.67157 19 6.5 19H8.37868C8.7765 19 9.15804 19.158 9.43934 19.4393L10.9393 20.9393C11.5251 21.5251 12.4749 21.5251 13.0607 20.9393L14.5607 19.4393C14.842 19.158 15.2235 19 15.6213 19H17.5C18.3284 19 19 18.3284 19 17.5V15.6213Z" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>\n\t\t\t\t<path d="M15 9L9 15" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>\n\t\t\t\t<path d="M10.5 9.5C10.5 10.0523 10.0523 10.5 9.5 10.5C8.94772 10.5 8.5 10.0523 8.5 9.5C8.5 8.94772 8.94772 8.5 9.5 8.5C10.0523 8.5 10.5 8.94772 10.5 9.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>\n\t\t\t\t<path d="M15.5 14.5C15.5 15.0523 15.0523 15.5 14.5 15.5C13.9477 15.5 13.5 15.0523 13.5 14.5C13.5 13.9477 13.9477 13.5 14.5 13.5C15.0523 13.5 15.5 13.9477 15.5 14.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>\n\t\t\t</svg>'}make_cart_totals_section(){this.$totals_section=this.$component.find(".cart-totals-section"),this.$totals_section.append('<div class="add-discount-wrapper">\n\t\t\t\t'+this.get_discount_icon()+' Add Discount\n\t\t\t</div>\n\t\t\t<div class="net-total-container">\n\t\t\t\t<div class="net-total-label">Net Total</div>\n\t\t\t\t<div class="net-total-value">0.00</div>\n\t\t\t</div>\n\t\t\t<div class="taxes-container"></div>\n\t\t\t<div class="grand-total-container">\n\t\t\t\t<div>Grand Total</div>\n\t\t\t\t<div>0.00</div>\n\t\t\t</div>\n\t\t\t<div class="checkout-btn">Checkout</div>\n\t\t\t<div class="edit-cart-btn">Edit Cart</div>'),this.$add_discount_elem=this.$component.find(".add-discount-wrapper")}make_cart_numpad(){this.$numpad_section=this.$component.find(".numpad-section"),this.number_pad=new erpnext.PointOfSale.NumberPad({wrapper:this.$numpad_section,events:{numpad_event:this.on_numpad_event.bind(this)},cols:5,keys:[[1,2,3,"Quantity"],[4,5,6,"Discount"],[7,8,9,"Rate"],[".",0,"Delete","Remove"]],css_classes:[["","","","col-span-2"],["","","","col-span-2"],["","","","col-span-2"],["","","","col-span-2 remove-btn"]],fieldnames_map:{Quantity:"qty",Discount:"discount_percentage"}}),this.$numpad_section.prepend('<div class="numpad-totals">\n\t\t\t\t<span class="numpad-net-total"></span>\n\t\t\t\t<span class="numpad-grand-total"></span>\n\t\t\t</div>'),this.$numpad_section.append('<div class="numpad-btn checkout-btn" data-button-value="checkout">Checkout</div>')}bind_events(){var t=this,e=this;this.$customer_section.on("click",".reset-customer-btn",function(){e.reset_customer_selector()}),this.$customer_section.on("click",".close-details-btn",function(){e.toggle_customer_info(!1)}),this.$customer_section.on("click",".customer-display",function(t){if(!$(t.target).closest(".reset-customer-btn").length){var i=e.$cart_container.is(":visible");e.toggle_customer_info(i)}}),this.$cart_items_wrapper.on("click",".cart-item-wrapper",function(){var t=$(this);e.toggle_item_highlight(this),!e.$totals_section.find(".edit-cart-btn").is(":visible")||e.$totals_section.find(".edit-cart-btn").click();var i=unescape(t.attr("data-row-name"));e.events.cart_item_clicked({name:i}),this.numpad_value=""}),this.$component.on("click",".checkout-btn",function(){-1!=$(this).attr("style").indexOf("--blue-500")&&(e.events.checkout(),e.toggle_checkout_btn(!1),e.allow_discount_change&&e.$add_discount_elem.removeClass("d-none"))}),this.$totals_section.on("click",".edit-cart-btn",function(){t.events.edit_cart(),t.toggle_checkout_btn(!0)}),this.$component.on("click",".add-discount-wrapper",function(){var e=t.$add_discount_elem.find(".edit-discount-btn").length;t.discount_field&&!e||t.show_discount_control()}),frappe.ui.form.on("POS Invoice","paid_amount",function(e){t.update_totals_section(e)})}attach_shortcuts(){for(var t=this,e=0,i=this.number_pad.keys;e<i.length;e+=1)for(var n=function(){var e=o[s];if("string"==typeof e){var i="ctrl+"+frappe.scrub(String(e))[0];"Delete"===e&&(i="ctrl+backspace"),"Remove"===e&&(i="shift+ctrl+backspace"),"."===e&&(i="ctrl+>");var n=t.number_pad.fieldnames[e]?t.number_pad.fieldnames[e]:"string"==typeof e?frappe.scrub(e):e,a=i.split("+").map(frappe.utils.to_title_case).join("+");a=frappe.utils.is_mac()?a.replace("Ctrl","⌘"):a,t.$numpad_section.find('.numpad-btn[data-button-value="'+n+'"]').attr("title",a),frappe.ui.keys.on(""+i,function(){t.$component.is(":visible")&&t.item_is_selected&&t.$numpad_section.is(":visible")&&t.$numpad_section.find('.numpad-btn[data-button-value="'+n+'"]').click()})}},a=i[e],s=0,o=a;s<o.length;s+=1)n();var r=frappe.utils.is_mac()?"⌘":"Ctrl";this.$component.find(".checkout-btn").attr("title",r+"+Enter"),frappe.ui.keys.add_shortcut({shortcut:"ctrl+enter",action:function(){return t.$component.find(".checkout-btn").click()},condition:function(){return t.$component.is(":visible")&&!t.$totals_section.find(".edit-cart-btn").is(":visible")},description:__("Checkout Order / Submit Order / New Order"),ignore_inputs:!0,page:cur_page.page.page}),this.$component.find(".edit-cart-btn").attr("title",r+"+E"),frappe.ui.keys.on("ctrl+e",function(){var e=t.$component.is(":visible"),i=!t.$totals_section.find(".checkout-btn").is("visible");e&&i&&t.$component.find(".edit-cart-btn").click()}),this.$component.find(".add-discount-wrapper").attr("title",r+"+D"),frappe.ui.keys.add_shortcut({shortcut:"ctrl+d",action:function(){return t.$component.find(".add-discount-wrapper").click()},condition:function(){return t.$add_discount_elem.is(":visible")},description:__("Add Order Discount"),ignore_inputs:!0,page:cur_page.page.page}),frappe.ui.keys.on("escape",function(){t.$component.is(":visible")&&t.discount_field&&t.discount_field.parent.is(":visible")&&t.discount_field.set_value(0)})}toggle_item_highlight(t){var e=$(t),i="background-color:var(--gray-50);"==e.attr("style");!t||i?(this.item_is_selected=!1,this.$cart_container.find(".cart-item-wrapper").css("background-color","")):(e.css("background-color","var(--gray-50)"),this.item_is_selected=!0,this.$cart_container.find(".cart-item-wrapper").not(t).css("background-color",""))}make_customer_selector(){this.$customer_section.html('\n\t\t\t<div class="customer-field"></div>\n\t\t');var t=this,e={query:"erpnext.controllers.queries.customer_query"},i=this.allowed_customer_groups||[];i.length&&(e.filters={customer_group:["in",i]}),this.customer_field=frappe.ui.form.make_control({df:{label:__("Customer"),fieldtype:"Link",options:"Customer",placeholder:__("Search by customer name, phone, email."),get_query:function(){return e},onchange:function(){var e=this;if(this.value){var i=t.events.get_frm();frappe.dom.freeze(),frappe.model.set_value(i.doc.doctype,i.doc.name,"customer",this.value),i.script_manager.trigger("customer",i.doc.doctype,i.doc.name).then(function(){frappe.run_serially([function(){return t.fetch_customer_details(e.value)},function(){return t.events.customer_details_updated(t.customer_info)},function(){return t.update_customer_section()},function(){return t.update_totals_section()},function(){return frappe.dom.unfreeze()}])})}}},parent:this.$customer_section.find(".customer-field"),render_input:!0}),this.customer_field.toggle_label(!1)}fetch_customer_details(t){var e=this;return t?new Promise(function(i){frappe.db.get_value("Customer",t,["email_id","mobile_no","image","loyalty_program"]).then(function(n){var a=n.message,s=a.loyalty_program;s?frappe.call({method:"erpnext.accounts.doctype.loyalty_program.loyalty_program.get_loyalty_program_details_with_points",args:{customer:t,loyalty_program:s,silent:!0},callback:function(n){var s=n.message,o=s.loyalty_points,r=s.conversion_factor;n.exc||(e.customer_info=Object.assign({},a,{customer:t,loyalty_points:o,conversion_factor:r}),i())}}):(e.customer_info=Object.assign({},a,{customer:t}),i())})}):new Promise(function(t){e.customer_info={},t()})}show_discount_control(){this.$add_discount_elem.css({padding:"0px",border:"none"}),this.$add_discount_elem.html('<div class="add-discount-field"></div>');var t=this,e=t.events.get_frm(),i=e.doc.additional_discount_percentage;this.discount_field=frappe.ui.form.make_control({df:{label:__("Discount"),fieldtype:"Data",placeholder:i?i+"%":__("Enter discount percentage."),input_class:"input-xs",onchange:function(){0!=flt(this.value)?(frappe.model.set_value(e.doc.doctype,e.doc.name,"additional_discount_percentage",flt(this.value)),t.hide_discount_control(this.value)):(frappe.model.set_value(e.doc.doctype,e.doc.name,"additional_discount_percentage",0),t.$add_discount_elem.css({border:"1px dashed var(--gray-500)",padding:"var(--padding-sm) var(--padding-md)"}),t.$add_discount_elem.html(t.get_discount_icon()+" Add Discount"),t.discount_field=void 0)}},parent:this.$add_discount_elem.find(".add-discount-field"),render_input:!0}),this.discount_field.toggle_label(!1),this.discount_field.set_focus()}hide_discount_control(t){t?(this.$add_discount_elem.css({border:"1px dashed var(--dark-green-500)",padding:"var(--padding-sm) var(--padding-md)"}),this.$add_discount_elem.html('<div class="edit-discount-btn">\n\t\t\t\t\t'+this.get_discount_icon()+" Additional&nbsp;"+String(t).bold()+"% discount applied\n\t\t\t\t</div>")):(this.$add_discount_elem.css({padding:"0px",border:"none"}),this.$add_discount_elem.html('<div class="add-discount-field"></div>'))}update_customer_section(){var t=this.customer_info||{},e=t.customer,i=t.email_id;void 0===i&&(i="");var n=t.mobile_no;void 0===n&&(n="");t.image;e?this.$customer_section.html('<div class="customer-details">\n\t\t\t\t\t<div class="customer-display">\n\t\t\t\t\t\t'+this.get_customer_image()+'\n\t\t\t\t\t\t<div class="customer-name-desc">\n\t\t\t\t\t\t\t<div class="customer-name">'+e+"</div>\n\t\t\t\t\t\t\t"+(i||n?i&&!n?'<div class="customer-desc">'+i+"</div>":n&&!i?'<div class="customer-desc">'+n+"</div>":'<div class="customer-desc">'+i+" - "+n+"</div>":'<div class="customer-desc">Click to add email / phone</div>')+'\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="reset-customer-btn" data-customer="'+escape(e)+'">\n\t\t\t\t\t\t\t<svg width="32" height="32" viewBox="0 0 14 14" fill="none">\n\t\t\t\t\t\t\t\t<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>'):this.reset_customer_selector()}get_customer_image(){var t=this.customer_info||{},e=t.customer,i=t.image;return i?'<div class="customer-image"><img src="'+i+'" alt="'+i+'""></div>':'<div class="customer-image customer-abbr">'+frappe.get_abbr(e)+"</div>"}update_totals_section(t){t||(t=this.events.get_frm()),this.render_net_total(t.doc.net_total);var e=cint(frappe.sys_defaults.disable_rounded_total)?t.doc.grand_total:t.doc.rounded_total;this.render_grand_total(e),this.render_taxes(t.doc.taxes)}render_net_total(t){var e=this.events.get_frm().doc.currency;this.$totals_section.find(".net-total-container").html("<div>Net Total</div><div>"+format_currency(t,e)+"</div>"),this.$numpad_section.find(".numpad-net-total").html("<div>Net Total: <span>"+format_currency(t,e)+"</span></div>")}render_grand_total(t){var e=this.events.get_frm().doc.currency;this.$totals_section.find(".grand-total-container").html("<div>Grand Total</div><div>"+format_currency(t,e)+"</div>"),this.$numpad_section.find(".numpad-grand-total").html("<div>Grand Total: <span>"+format_currency(t,e)+"</span></div>")}render_taxes(t){if(t.length){var e=this.events.get_frm().doc.currency,i=t.map(function(t){return'<div class="tax-row">\n\t\t\t\t\t<div class="tax-label">'+(/[0-9]+/.test(t.description)?t.description:t.description+" @ "+t.rate+"%")+'</div>\n\t\t\t\t\t<div class="tax-value">'+format_currency(t.tax_amount_after_discount_amount,e)+"</div>\n\t\t\t\t</div>"}).join("");this.$totals_section.find(".taxes-container").css("display","flex").html(i)}else this.$totals_section.find(".taxes-container").css("display","none").html("")}get_cart_item(t){var e=t.name,i='.cart-item-wrapper[data-row-name="'+escape(e)+'"]';return this.$cart_items_wrapper.find(i)}get_item_from_frm(t){return this.events.get_frm().doc.items.find(function(e){return e.name==t.name})}update_item_html(t,e){var i=this.get_cart_item(t);if(e)i&&i.next().remove()&&i.remove();else{var n=this.get_item_from_frm(t);this.render_cart_item(n,i)}var a=this.$cart_items_wrapper.find(".cart-item-wrapper").length;this.highlight_checkout_btn(a>0),this.update_empty_cart_section(a)}render_cart_item(t,e){var i,n,a=this.events.get_frm().doc.currency,s=this;e.length||(this.$cart_items_wrapper.append('<div class="cart-item-wrapper" data-row-name="'+escape(t.name)+'"></div>\n\t\t\t\t<div class="seperator"></div>'),e=this.get_cart_item(t)),e.html((i=t.image,n=t.item_name,(!s.hide_images&&i?'\n\t\t\t\t\t<div class="item-image">\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tonerror="cur_pos.cart.handle_broken_image(this)"\n\t\t\t\t\t\t\tsrc="'+i+'" alt="'+frappe.get_abbr(n)+'"">\n\t\t\t\t\t</div>':'<div class="item-image item-abbr">'+frappe.get_abbr(n)+"</div>")+'\n\t\t\t<div class="item-name-desc">\n\t\t\t\t<div class="item-name">\n\t\t\t\t\t'+t.item_name+"\n\t\t\t\t</div>\n\t\t\t\t"+function(){if(t.description){if(-1!=t.description.indexOf("<div>"))try{t.description=$(t.description).text()}catch(e){t.description=t.description.replace(/<div>/g," ").replace(/<\/div>/g," ").replace(/ +/g," ")}return t.description=frappe.ellipsis(t.description,45),'<div class="item-desc">'+t.description+"</div>"}return""}()+"\n\t\t\t</div>\n\t\t\t"+(t.rate&&t.amount&&t.rate!==t.amount?'\n\t\t\t\t\t<div class="item-qty-rate">\n\t\t\t\t\t\t<div class="item-qty"><span>'+(t.qty||0)+'</span></div>\n\t\t\t\t\t\t<div class="item-rate-amount">\n\t\t\t\t\t\t\t<div class="item-rate">'+format_currency(t.amount,a)+'</div>\n\t\t\t\t\t\t\t<div class="item-amount">'+format_currency(t.rate,a)+"</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>":'\n\t\t\t\t\t<div class="item-qty-rate">\n\t\t\t\t\t\t<div class="item-qty"><span>'+(t.qty||0)+'</span></div>\n\t\t\t\t\t\t<div class="item-rate-amount">\n\t\t\t\t\t\t\t<div class="item-rate">'+format_currency(t.rate,a)+"</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>"))),function(){var t=Array.from(s.$cart_items_wrapper.find(".item-rate-amount"));s.$cart_header.find(".rate-amount-header").css("width",""),s.$cart_items_wrapper.find(".item-rate-amount").css("width","");var e=t.reduce(function(t,e){return $(e).width()>t&&(t=$(e).width()),t},0);1==(e+=1)&&(e="");s.$cart_header.find(".rate-amount-header").css("width",e),s.$cart_items_wrapper.find(".item-rate-amount").css("width",e)}()}handle_broken_image(t){var e=$(t).attr("alt");$(t).parent().replaceWith('<div class="item-image item-abbr">'+e+"</div>")}update_selector_value_in_cart_item(t,e,i){this.get_cart_item(i).attr("data-"+t,escape(e))}toggle_checkout_btn(t){t?(this.$totals_section.find(".checkout-btn").css("display","flex"),this.$totals_section.find(".edit-cart-btn").css("display","none")):(this.$totals_section.find(".checkout-btn").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","flex"))}highlight_checkout_btn(t){t?(this.$add_discount_elem.css("display","flex"),this.$cart_container.find(".checkout-btn").css({"background-color":"var(--blue-500)"})):(this.$add_discount_elem.css("display","none"),this.$cart_container.find(".checkout-btn").css({"background-color":"var(--blue-200)"}))}update_empty_cart_section(t){var e=this.$cart_items_wrapper.find(".no-item-wrapper");t>0&&e&&e.remove()&&this.$cart_header.css("display","flex"),0===t&&!e.length&&this.make_no_items_placeholder()}on_numpad_event(t){var e=t.attr("data-button-value"),i=["qty","discount_percentage","rate"].includes(e),n=!i||("rate"==e&&this.allow_rate_change||"discount_percentage"==e&&this.allow_discount_change||"qty"==e),a=this.prev_action===e,s=!this.prev_action,o=this.prev_action&&this.prev_action!=e;if(i){if(!n){var r="rate"==e?"Rate".bold():"Discount".bold(),c=__("Editing {0} is not allowed as per POS Profile settings",[r]);return frappe.show_alert({indicator:"red",message:c}),void frappe.utils.play_sound("error")}s||o?this.prev_action=e:a&&(this.prev_action=void 0),this.numpad_value=""}else{if("checkout"===e)return this.prev_action=void 0,this.toggle_item_highlight(),void this.events.numpad_event(void 0,e);if("remove"===e)return this.prev_action=void 0,this.toggle_item_highlight(),void this.events.numpad_event(void 0,e);this.numpad_value="delete"===e?this.numpad_value.slice(0,-1):this.numpad_value+e,this.numpad_value=this.numpad_value||0}if(!i&&s)return frappe.show_alert({indicator:"red",message:__("Please select a field to edit from numpad")}),void frappe.utils.play_sound("error");flt(this.numpad_value)>100&&"discount_percentage"===this.prev_action&&(frappe.show_alert({message:__("Discount cannot be greater than 100%"),indicator:"orange"}),frappe.utils.play_sound("error"),this.numpad_value=e),this.highlight_numpad_btn(t,e),this.events.numpad_event(this.numpad_value,this.prev_action)}highlight_numpad_btn(t,e){var i=t.hasClass("highlighted-numpad-btn"),n=["qty","discount_percentage","rate","done"].includes(e);(i||t.addClass("highlighted-numpad-btn"),this.prev_action===e&&i&&t.removeClass("highlighted-numpad-btn"),this.prev_action&&this.prev_action!==e&&n)&&$("[data-button-value='"+this.prev_action+"']").removeClass("highlighted-numpad-btn");n&&"done"!==e||setTimeout(function(){t.removeClass("highlighted-numpad-btn")},200)}toggle_numpad(t){t?(this.$totals_section.css("display","none"),this.$numpad_section.css("display","flex")):(this.$totals_section.css("display","flex"),this.$numpad_section.css("display","none")),this.reset_numpad()}reset_numpad(){this.numpad_value="",this.prev_action=void 0,this.$numpad_section.find(".highlighted-numpad-btn").removeClass("highlighted-numpad-btn")}toggle_numpad_field_edit(t){["qty","discount_percentage","rate"].includes(t)&&this.$numpad_section.find('[data-button-value="'+t+'"]').click()}toggle_customer_info(t){if(t){var e=(this.customer_info||{}).customer;this.$cart_container.css("display","none"),this.$customer_section.css({height:"100%","padding-top":"0px"}),this.$customer_section.find(".customer-details").html('<div class="header">\n\t\t\t\t\t<div class="label">Contact Details</div>\n\t\t\t\t\t<div class="close-details-btn">\n\t\t\t\t\t\t<svg width="32" height="32" viewBox="0 0 14 14" fill="none">\n\t\t\t\t\t\t\t<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="customer-display">\n\t\t\t\t\t'+this.get_customer_image()+'\n\t\t\t\t\t<div class="customer-name-desc">\n\t\t\t\t\t\t<div class="customer-name">'+e+'</div>\n\t\t\t\t\t\t<div class="customer-desc"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="customer-fields-container">\n\t\t\t\t\t<div class="email_id-field"></div>\n\t\t\t\t\t<div class="mobile_no-field"></div>\n\t\t\t\t\t<div class="loyalty_program-field"></div>\n\t\t\t\t\t<div class="loyalty_points-field"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="transactions-label">Recent Transactions</div>'),this.$customer_section.append('<div class="customer-transactions"></div>'),this.render_customer_fields(),this.fetch_customer_transactions()}else this.$cart_container.css("display","flex"),this.$customer_section.css({height:"","padding-top":""}),this.update_customer_section()}render_customer_fields(){var t=this,e=this.$customer_section.find(".customer-fields-container"),i=[{fieldname:"email_id",label:__("Email"),fieldtype:"Data",options:"email",placeholder:__("Enter customer's email")},{fieldname:"mobile_no",label:__("Phone Number"),fieldtype:"Data",placeholder:__("Enter customer's phone number")},{fieldname:"loyalty_program",label:__("Loyalty Program"),fieldtype:"Link",options:"Loyalty Program",placeholder:__("Select Loyalty Program")},{fieldname:"loyalty_points",label:__("Loyalty Points"),fieldtype:"Data",read_only:1}],n=this;function a(){var t=this,e=n.customer_info[this.df.fieldname],i=n.customer_info.customer;this.value&&e!=this.value&&"loyalty_points"!=this.df.fieldname&&frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.set_customer_info",args:{fieldname:this.df.fieldname,customer:i,value:this.value},callback:function(e){e.exc||(n.customer_info[t.df.fieldname]=t.value,frappe.show_alert({message:__("Customer contact updated successfully."),indicator:"green"}),frappe.utils.play_sound("submit"))}})}i.forEach(function(i){t["customer_"+i.fieldname+"_field"]=frappe.ui.form.make_control({df:Object.assign({},i,{onchange:a}),parent:e.find("."+i.fieldname+"-field"),render_input:!0}),t["customer_"+i.fieldname+"_field"].set_value(t.customer_info[i.fieldname])})}fetch_customer_transactions(){var t=this;frappe.db.get_list("POS Invoice",{filters:{customer:this.customer_info.customer,docstatus:1},fields:["name","grand_total","status","posting_date","posting_time","currency"],limit:20}).then(function(e){var i=t.$customer_section.find(".customer-transactions");if(e.length){var n=moment(e[0].posting_date+" "+e[0].posting_time).fromNow();t.$customer_section.find(".customer-desc").html("Last transacted "+n),e.forEach(function(t){var e=moment(t.posting_date+" "+t.posting_time).format("Do MMMM, h:mma");i.append('<div class="invoice-wrapper" data-invoice-name="'+escape(t.name)+'">\n\t\t\t\t\t\t<div class="invoice-name-date">\n\t\t\t\t\t\t\t<div class="invoice-name">'+t.name+'</div>\n\t\t\t\t\t\t\t<div class="invoice-date">'+e+'</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="invoice-total-status">\n\t\t\t\t\t\t\t<div class="invoice-total">\n\t\t\t\t\t\t\t\t'+(format_currency(t.grand_total,t.currency,0)||0)+'\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="invoice-status">\n\t\t\t\t\t\t\t\t<span class="indicator-pill whitespace-nowrap '+{Paid:"green",Draft:"red",Return:"gray",Consolidated:"blue"}[t.status]+'">\n\t\t\t\t\t\t\t\t\t<span>'+t.status+'</span>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="seperator"></div>')})}else i.html('<div class="no-transactions-placeholder">No recent transactions found</div>')})}attach_refresh_field_event(t){var e=this;$(t.wrapper).off("refresh-fields"),$(t.wrapper).on("refresh-fields",function(){t.doc.items.length&&t.doc.items.forEach(function(t){e.update_item_html(t)}),e.update_totals_section(t)})}load_invoice(){var t=this,e=this.events.get_frm();this.attach_refresh_field_event(e),this.fetch_customer_details(e.doc.customer).then(function(){t.events.customer_details_updated(t.customer_info),t.update_customer_section()}),this.$cart_items_wrapper.html(""),e.doc.items.length?e.doc.items.forEach(function(e){t.update_item_html(e)}):(this.make_no_items_placeholder(),this.highlight_checkout_btn(!1)),this.update_totals_section(e),1===e.doc.docstatus?(this.$totals_section.find(".checkout-btn").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","none")):(this.$totals_section.find(".checkout-btn").css("display","flex"),this.$totals_section.find(".edit-cart-btn").css("display","none")),this.toggle_component(!0)}toggle_component(t){t?this.$component.css("display","flex"):this.$component.css("display","none")}},erpnext.PointOfSale.ItemDetails=class{constructor(t){var e=t.wrapper,i=t.events,n=t.settings;this.wrapper=e,this.events=i,this.hide_images=n.hide_images,this.allow_rate_change=n.allow_rate_change,this.allow_discount_change=n.allow_discount_change,this.current_item={},this.init_component()}init_component(){this.prepare_dom(),this.init_child_components(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="item-details-container"></section>'),this.$component=this.wrapper.find(".item-details-container")}init_child_components(){this.$component.html('<div class="item-details-header">\n\t\t\t\t<div class="label">Item Details</div>\n\t\t\t\t<div class="close-btn">\n\t\t\t\t\t<svg width="32" height="32" viewBox="0 0 14 14" fill="none">\n\t\t\t\t\t\t<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>\n\t\t\t\t\t</svg>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="item-display">\n\t\t\t\t<div class="item-name-desc-price">\n\t\t\t\t\t<div class="item-name"></div>\n\t\t\t\t\t<div class="item-desc"></div>\n\t\t\t\t\t<div class="item-price"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="item-image"></div>\n\t\t\t</div>\n\t\t\t<div class="discount-section"></div>\n\t\t\t<div class="form-container"></div>'),this.$item_name=this.$component.find(".item-name"),this.$item_description=this.$component.find(".item-desc"),this.$item_price=this.$component.find(".item-price"),this.$item_image=this.$component.find(".item-image"),this.$form_container=this.$component.find(".form-container"),this.$dicount_section=this.$component.find(".discount-section")}compare_with_current_item(t){return t&&t.name==this.current_item.name}toggle_item_details_section(t){var e=!this.compare_with_current_item(t),i=!Boolean(t)||!e;this.events.toggle_item_selector(!i),this.toggle_component(!i),t&&e?(this.doctype=t.doctype,this.item_meta=frappe.get_meta(this.doctype),this.name=t.name,this.item_row=t,this.currency=this.events.get_frm().doc.currency,this.current_item=t,this.render_dom(t),this.render_discount_dom(t),this.render_form(t),this.events.highlight_cart_item(t)):(this.validate_serial_batch_item(),this.current_item={})}validate_serial_batch_item(){var t=this,e=this.events.get_frm().doc.items.find(function(e){return e.name===t.name});if(e){var i=e.has_serial_no,n=e.has_batch_no,a=!e.serial_no,s=!e.batch_no;(i&&a||n&&s||i&&n&&(s||a))&&(frappe.show_alert({message:__("Item will be removed since no serial / batch no selected."),indicator:"orange"}),frappe.utils.play_sound("cancel"),this.events.remove_item_from_cart())}}render_dom(t){var e=t.item_name,i=t.description,n=t.image,a=t.price_list_rate;this.$item_name.html(e),this.$item_description.html(i?i=-1===i.indexOf("...")&&i.length>140?i.substr(0,139)+"...":i:""),this.$item_price.html(format_currency(a,this.currency)),!this.hide_images&&n?this.$item_image.html('<img\n\t\t\t\t\tonerror="cur_pos.item_details.handle_broken_image(this)"\n\t\t\t\t\tclass="h-full" src="'+n+'"\n\t\t\t\t\talt="'+frappe.get_abbr(e)+'"\n\t\t\t\t\tstyle="object-fit: cover;">'):this.$item_image.html('<div class="item-abbr">'+frappe.get_abbr(e)+"</div>")}handle_broken_image(t){var e=$(t).attr("alt");$(t).replaceWith('<div class="item-abbr">'+e+"</div>")}render_discount_dom(t){t.discount_percentage?(this.$dicount_section.html('<div class="item-rate">'+format_currency(t.price_list_rate,this.currency)+'</div>\n\t\t\t\t<div class="item-discount">'+t.discount_percentage+"% off</div>"),this.$item_price.html(format_currency(t.rate,this.currency))):this.$dicount_section.html("")}render_form(t){var e=this,i=this.get_form_fields(t);this.$form_container.html(""),i.forEach(function(i,n){e.$form_container.append('<div class="'+i+'-control" data-fieldname="'+i+'"></div>');var a=e.item_meta.fields.find(function(t){return t.fieldname===i});"discount_percentage"===i&&(a.label=__("Discount (%)"));var s=e;e[i+"_control"]=frappe.ui.form.make_control({df:Object.assign({},a,{onchange:function(){s.events.form_updated(s.current_item,i,this.value)}}),parent:e.$form_container.find("."+i+"-control"),render_input:!0}),e[i+"_control"].set_value(t[i])}),this.make_auto_serial_selection_btn(t),this.bind_custom_control_change_event()}get_form_fields(t){var e=["qty","uom","rate","conversion_factor","discount_percentage","warehouse","actual_qty","price_list_rate"];return t.has_serial_no&&e.push("serial_no"),t.has_batch_no&&e.push("batch_no"),e}make_auto_serial_selection_btn(t){t.has_serial_no&&(t.has_batch_no||this.$form_container.append('<div class="grid-filler no-select"></div>'),this.$form_container.append('<div class="btn btn-sm btn-secondary auto-fetch-btn">Auto Fetch Serial Numbers</div>'),this.$form_container.find(".serial_no-control").find("textarea").css("height","6rem"))}bind_custom_control_change_event(){var t=this,e=this;this.rate_control&&(this.rate_control.df.onchange=function(){(this.value||0===flt(this.value))&&e.events.form_updated(e.current_item,"rate",this.value).then(function(){var t=frappe.get_doc(e.doctype,e.name),i=e.events.get_frm().doc;e.$item_price.html(format_currency(t.rate,i.currency)),e.render_discount_dom(t)})},this.rate_control.df.read_only=!this.allow_rate_change,this.rate_control.refresh()),this.discount_percentage_control&&!this.allow_discount_change&&(this.discount_percentage_control.df.read_only=1,this.discount_percentage_control.refresh()),this.warehouse_control&&(this.warehouse_control.df.reqd=1,this.warehouse_control.df.onchange=function(){var t=this;this.value&&e.events.form_updated(e.current_item,"warehouse",this.value).then(function(){e.item_stock_map=e.events.get_item_stock_map();var i=e.item_stock_map[e.item_row.item_code][t.value];if(void 0===i)e.events.get_available_stock(e.item_row.item_code,t.value).then(function(){e.warehouse_control.set_value(t.value)});else if(0===i){e.warehouse_control.set_value("");var n=e.item_row.item_code.bold(),a=t.value.bold();frappe.throw(__("Item Code: {0} is not available under warehouse {1}.",[n,a]))}e.actual_qty_control.set_value(i)})},this.warehouse_control.df.get_query=function(){return{filters:{company:t.events.get_frm().doc.company}}},this.warehouse_control.refresh()),this.serial_no_control&&(this.serial_no_control.df.reqd=1,this.serial_no_control.df.onchange=async function(){!e.current_item.batch_no&&await e.auto_update_batch_no(),e.events.form_updated(e.current_item,"serial_no",this.value)},this.serial_no_control.refresh()),this.batch_no_control&&(this.batch_no_control.df.reqd=1,this.batch_no_control.df.get_query=function(){return{query:"erpnext.controllers.queries.get_batch_no",filters:{item_code:e.item_row.item_code,warehouse:e.item_row.warehouse,posting_date:e.events.get_frm().doc.posting_date}}},this.batch_no_control.refresh()),this.uom_control&&(this.uom_control.df.onchange=function(){e.events.form_updated(e.current_item,"uom",this.value);var t=frappe.get_doc(e.doctype,e.name);e.conversion_factor_control.df.read_only=t.stock_uom==this.value,e.conversion_factor_control.refresh()}),frappe.model.on("POS Invoice Item","*",function(e,i,n){var a=t[e+"_control"];t.compare_with_current_item(n)&&a&&a.get_value()!==i&&(a.set_value(i),cur_pos.update_cart_html(n))})}async auto_update_batch_no(){if(this.serial_no_control&&this.batch_no_control){var t=this.serial_no_control.get_value().split("\n").filter(function(t){return t});if(!t.length)return;var e=(await frappe.db.get_list("Serial No",{filters:{name:["in",t]},fields:["batch_no","name"]})).reduce(function(t,e){return t[e.batch_no]||(t[e.batch_no]=[]),t[e.batch_no]=t[e.batch_no].concat([e.name]),t},{}),i=Object.keys(e)[0],n=e[i].join("\n"),a=t.length!==e[i].length;this.batch_no_control.get_value()!=i&&await this.batch_no_control.set_value(i),a&&(this.serial_no_control.set_value(n),this.qty_control.set_value(e[i].length),delete e[i],this.events.clone_new_batch_item_in_frm(e,this.current_item))}}bind_events(){var t=this;this.bind_auto_serial_fetch_event(),this.bind_fields_to_numpad_fields(),this.$component.on("click",".close-btn",function(){t.events.close_item_details()})}attach_shortcuts(){var t=this;this.wrapper.find(".close-btn").attr("title","Esc"),frappe.ui.keys.on("escape",function(){t.$component.is(":visible")&&t.events.close_item_details()})}bind_fields_to_numpad_fields(){var t=this;this.$form_container.on("click",".input-with-feedback",function(){var e=$(this).attr("data-fieldname");this.last_field_focused!=e&&(t.events.item_field_focused(e),this.last_field_focused=e)})}bind_auto_serial_fetch_event(){var t=this;this.$form_container.on("click",".auto-fetch-btn",function(){t.batch_no_control&&t.batch_no_control.set_value("");var e=t.qty_control.get_value(),i=t.conversion_factor_control.get_value(),n=t.item_row.has_batch_no?t.events.get_frm().doc.posting_date:"",a=frappe.call({method:"erpnext.stock.doctype.serial_no.serial_no.auto_fetch_serial_number",args:{qty:e*i,item_code:t.current_item.item_code,warehouse:t.warehouse_control.get_value()||"",batch_nos:t.current_item.batch_no||"",posting_date:n,for_doctype:"POS Invoice"}});a.then(function(i){var n=i.message,s=n.length;if(s)s<e&&(frappe.msgprint(__("Fetched only {0} available serial numbers.",[s])),t.qty_control.set_value(s));else{var o=t.warehouse_control.get_value().bold(),r=t.current_item.item_code.bold();frappe.msgprint(__("Serial numbers unavailable for Item {0} under warehouse {1}. Please try changing warehouse.",[r,o]))}a=n.join("\n"),t.serial_no_control.set_value(a)})})}toggle_component(t){t?this.$component.css("display","flex"):this.$component.css("display","none")}},erpnext.PointOfSale.NumberPad=class{constructor(t){var e=t.wrapper,i=t.events,n=t.cols,a=t.keys,s=t.css_classes,o=t.fieldnames_map;this.wrapper=e,this.events=i,this.cols=n,this.keys=a,this.css_classes=s||[],this.fieldnames=o||{},this.init_component()}init_component(){this.prepare_dom(),this.bind_events()}prepare_dom(){this.cols;var t=this.keys,e=this.css_classes,i=this.fieldnames;this.wrapper.html('<div class="numpad-container">\n\t\t\t\t'+t.reduce(function(t,n,a){return t+n.reduce(function(t,n,s){return t+'<div class="numpad-btn '+(e&&e[a]?e[a][s]:"")+'" data-button-value="'+(i&&i[n]?i[n]:"string"==typeof n?frappe.scrub(n):n)+'">'+n+"</div>"},"")},"")+"\n\t\t\t</div>")}bind_events(){var t=this;this.wrapper.on("click",".numpad-btn",function(){var e=$(this);t.events.numpad_event(e)})}},erpnext.PointOfSale.Payment=class{constructor(t){var e=t.events,i=t.wrapper;this.wrapper=i,this.events=e,this.init_component()}init_component(){this.prepare_dom(),this.initialize_numpad(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="payment-container">\n\t\t\t\t<div class="section-label payment-section">Payment Method</div>\n\t\t\t\t<div class="payment-modes"></div>\n\t\t\t\t<div class="fields-numpad-container">\n\t\t\t\t\t<div class="fields-section">\n\t\t\t\t\t\t<div class="section-label">Additional Information</div>\n\t\t\t\t\t\t<div class="invoice-fields"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="number-pad"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="totals-section">\n\t\t\t\t\t<div class="totals"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="submit-order-btn">Complete Order</div>\n\t\t\t</section>'),this.$component=this.wrapper.find(".payment-container"),this.$payment_modes=this.$component.find(".payment-modes"),this.$totals_section=this.$component.find(".totals-section"),this.$totals=this.$component.find(".totals"),this.$numpad=this.$component.find(".number-pad"),this.$invoice_fields_section=this.$component.find(".fields-section")}make_invoice_fields_control(){var t=this;frappe.db.get_doc("POS Settings",void 0).then(function(e){var i=e.invoice_fields;if(i.length){t.$invoice_fields=t.$invoice_fields_section.find(".invoice-fields"),t.$invoice_fields.html("");var n=t.events.get_frm();i.forEach(function(e){t.$invoice_fields.append('<div class="invoice_detail_field '+e.fieldname+'-field" data-fieldname="'+e.fieldname+'"></div>');var i={onchange:function(){n.set_value(this.df.fieldname,this.get_value())}};"Button"==e.fieldtype&&(i={click:function(){n.script_manager.has_handlers(e.fieldname,n.doc.doctype)&&n.script_manager.trigger(e.fieldname,n.doc.doctype,n.doc.docname)}}),t[e.fieldname+"_field"]=frappe.ui.form.make_control({df:Object.assign({},e,i),parent:t.$invoice_fields.find("."+e.fieldname+"-field"),render_input:!0}),t[e.fieldname+"_field"].set_value(n.doc[e.fieldname])})}})}initialize_numpad(){var t=this;this.number_pad=new erpnext.PointOfSale.NumberPad({wrapper:this.$numpad,events:{numpad_event:function(e){t.on_numpad_clicked(e)}},cols:3,keys:[[1,2,3],[4,5,6],[7,8,9],[".",0,"Delete"]]}),this.numpad_value=""}on_numpad_clicked(t){var e=t.attr("data-button-value");!function(t){t.addClass("shadow-base-inner bg-selected"),setTimeout(function(){t.removeClass("shadow-base-inner bg-selected")},100)}(t),this.numpad_value="delete"===e?this.numpad_value.slice(0,-1):this.numpad_value+e,this.selected_mode.$input.get(0).focus(),this.selected_mode.set_value(this.numpad_value)}bind_events(){var t=this,e=this;this.$payment_modes.on("click",".mode-of-payment",function(t){var i=$(this);if($(t.target).is(i)){var n=i.offset().left-e.$payment_modes.offset().left+e.$payment_modes.scrollLeft();e.$payment_modes.animate({scrollLeft:n});var a=i.attr("data-mode");$(".mode-of-payment-control").css("display","none"),$(".cash-shortcuts").css("display","none"),e.$payment_modes.find(".pay-amount").css("display","inline"),e.$payment_modes.find(".loyalty-amount-name").css("display","none"),$(".mode-of-payment").removeClass("border-primary"),i.hasClass("border-primary")?(i.removeClass("border-primary"),e.selected_mode=""):(i.addClass("border-primary"),i.find(".mode-of-payment-control").css("display","flex"),i.find(".cash-shortcuts").css("display","grid"),e.$payment_modes.find("."+a+"-amount").css("display","none"),e.$payment_modes.find("."+a+"-name").css("display","inline"),e.selected_mode=e[a+"_control"],e.selected_mode&&e.selected_mode.$input.get(0).focus(),e.auto_set_remaining_amount())}}),frappe.ui.form.on("POS Invoice","contact_mobile",function(e){var i=e.doc.contact_mobile,n=$(t.request_for_payment_field.$input[0]);i?n.removeClass("btn-default").addClass("btn-primary"):n.removeClass("btn-primary").addClass("btn-default")}),this.setup_listener_for_payments(),this.$payment_modes.on("click",".shortcut",function(){var t=$(this).attr("data-value");e.selected_mode.set_value(t)}),this.$component.on("click",".submit-order-btn",function(){var e=t.events.get_frm().doc,i=e.paid_amount,n=e.items;if(0==i||!n.length){var a=n.length?__("You cannot submit the order without payment."):__("You cannot submit empty order.");return frappe.show_alert({message:a,indicator:"orange"}),void frappe.utils.play_sound("error")}t.events.submit_invoice()}),frappe.ui.form.on("POS Invoice","paid_amount",function(e){t.update_totals_section(e.doc);var i=!t.$payment_modes.find(".cash-shortcuts").is(":visible");t.attach_cash_shortcuts(e.doc),!i&&t.$payment_modes.find(".cash-shortcuts").css("display","grid"),t.render_payment_mode_dom()}),frappe.ui.form.on("POS Invoice","loyalty_amount",function(e){var i=format_currency(e.doc.loyalty_amount,e.doc.currency);t.$payment_modes.find(".loyalty-amount-amount").html(i)}),frappe.ui.form.on("Sales Invoice Payment","amount",function(e,i,n){var a=locals[i][n],s=a.mode_of_payment.replace(/ +/g,"_").toLowerCase();t[s+"_control"]&&t[s+"_control"].get_value()!=a.amount&&t[s+"_control"].set_value(a.amount)})}setup_listener_for_payments(){var t=this;frappe.realtime.on("process_phone_payment",function(e){var i,n,a=t.events.get_frm().doc,s=(e.response,e.amount),o=e.success,r=e.failure_message;o?(n=__("Payment Received"),s>=(cint(frappe.sys_defaults.disable_rounded_total)?a.grand_total:a.rounded_total)?(frappe.dom.unfreeze(),i=__("Payment of {0} received successfully.",[format_currency(s,a.currency,0)]),t.events.submit_invoice(),cur_frm.reload_doc()):i=__("Payment of {0} received successfully. Waiting for other requests to complete...",[format_currency(s,a.currency,0)])):r&&(i=r,n=__("Payment Failed"));frappe.msgprint({message:i,title:n})})}auto_set_remaining_amount(){var t=this.events.get_frm().doc,e=(cint(frappe.sys_defaults.disable_rounded_total)?t.grand_total:t.rounded_total)-t.paid_amount;!(this.selected_mode?this.selected_mode.get_value():void 0)&&e>0&&this.selected_mode&&this.selected_mode.set_value(e)}attach_shortcuts(){var t=this,e=frappe.utils.is_mac()?"⌘":"Ctrl";this.$component.find(".submit-order-btn").attr("title",e+"+Enter"),frappe.ui.keys.on("ctrl+enter",function(){var e=t.$component.is(":visible"),i=t.$payment_modes.find(".border-primary");e&&i.length&&t.$component.find(".submit-order-btn").click()}),frappe.ui.keys.add_shortcut({shortcut:"tab",action:function(){var e=t.$component.is(":visible"),i=t.$payment_modes.find(".border-primary");if(i=i.length?i.attr("data-mode"):void 0){var n=Array.from(t.$payment_modes.find(".mode-of-payment")).map(function(t){return $(t).attr("data-mode")}),a=n.indexOf(i),s=(a+1)%n.length,o=t.$payment_modes.find('.mode-of-payment[data-mode="'+n[s]+'"]');e&&a!=s&&o.click()}},condition:function(){return t.$component.is(":visible")&&t.$payment_modes.find(".border-primary").length},description:__("Switch Between Payment Modes"),ignore_inputs:!0,page:cur_page.page.page})}toggle_numpad(){}render_payment_section(){this.render_payment_mode_dom(),this.make_invoice_fields_control(),this.update_totals_section(),this.focus_on_default_mop()}edit_cart(){this.events.toggle_other_sections(!1),this.toggle_component(!1)}checkout(){this.events.toggle_other_sections(!0),this.toggle_component(!0),this.render_payment_section()}toggle_remarks_control(){this.$remarks.find(".frappe-control").length?this.$remarks.html("+ Add Remark"):(this.$remarks.html(""),this.remark_control=frappe.ui.form.make_control({df:{label:__("Remark"),fieldtype:"Data",onchange:function(){}},parent:this.$totals_section.find(".remarks"),render_input:!0}),this.remark_control.set_value(""))}render_payment_mode_dom(){var t=this,e=this.events.get_frm().doc,i=e.payments,n=e.currency;this.$payment_modes.html(""+i.map(function(t,e){var i=t.mode_of_payment.replace(/ +/g,"_").toLowerCase(),a=t.type,s=t.amount>0?format_currency(t.amount,n):"";return'\n\t\t\t\t\t<div class="payment-mode-wrapper">\n\t\t\t\t\t\t<div class="mode-of-payment" data-mode="'+i+'" data-payment-type="'+a+'">\n\t\t\t\t\t\t\t'+t.mode_of_payment+'\n\t\t\t\t\t\t\t<div class="'+i+'-amount pay-amount">'+s+'</div>\n\t\t\t\t\t\t\t<div class="'+i+' mode-of-payment-control"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t'}).join("")),i.forEach(function(e){var i=e.mode_of_payment.replace(/ +/g,"_").toLowerCase(),a=t;t[i+"_control"]=frappe.ui.form.make_control({df:{label:e.mode_of_payment,fieldtype:"Currency",placeholder:__("Enter {0} amount.",[e.mode_of_payment]),onchange:function(){if(frappe.model.get_value(e.doctype,e.name,"amount")!=this.value){frappe.model.set_value(e.doctype,e.name,"amount",flt(this.value)).then(function(){return a.update_totals_section()});var t=format_currency(this.value,n);a.$payment_modes.find("."+i+"-amount").html(t)}}},parent:t.$payment_modes.find("."+i+".mode-of-payment-control"),render_input:!0}),t[i+"_control"].toggle_label(!1),t[i+"_control"].set_value(e.amount)}),this.render_loyalty_points_payment_mode(),this.attach_cash_shortcuts(e)}focus_on_default_mop(){var t=this;this.events.get_frm().doc.payments.forEach(function(e){var i=e.mode_of_payment.replace(/ +/g,"_").toLowerCase();e.default&&setTimeout(function(){t.$payment_modes.find("."+i+".mode-of-payment-control").parent().click()},500)})}attach_cash_shortcuts(t){var e=cint(frappe.sys_defaults.disable_rounded_total)?t.grand_total:t.rounded_total,i=t.currency,n=this.get_cash_shortcuts(flt(e));this.$payment_modes.find(".cash-shortcuts").remove();var a=n.map(function(t){return'<div class="shortcut" data-value="'+t+'">'+format_currency(t,i,0)+"</div>"}).join("");this.$payment_modes.find('[data-payment-type="Cash"]').find(".mode-of-payment-control").after('<div class="cash-shortcuts">'+a+"</div>")}get_cash_shortcuts(t){var e=[1,5,10],i=String(Math.round(t)).length;e=e.map(function(t){return t*Math.pow(10,i-2)});return e.reduce(function(e,i){var n=function(t,e){var i=Math.ceil(t/e)*e;return i===t?i+e:i}(t,i);return n=-1!=e.indexOf(n)?n+i:n,e.concat([n])},[])}render_loyalty_points_payment_mode(){var t=this,e=this.events.get_frm().doc,i=this.events.get_customer_details(),n=i.loyalty_program,a=i.loyalty_points,s=i.conversion_factor;if(this.$payment_modes.find('.mode-of-payment[data-mode="loyalty-amount"]').parent().remove(),n){var o,r,c;a?(c=flt(flt(a)*flt(s),precision("loyalty_amount",e)),o=__("You can redeem upto {0}.",[format_currency(c)]),r=!1):(o=__("You don't have enough points to redeem."),r=!0);this.$payment_modes.children().length;var d=e.loyalty_amount>0?format_currency(e.loyalty_amount,e.currency):"";this.$payment_modes.append('<div class="payment-mode-wrapper">\n\t\t\t\t<div class="mode-of-payment loyalty-card" data-mode="loyalty-amount" data-payment-type="loyalty-amount">\n\t\t\t\t\tRedeem Loyalty Points\n\t\t\t\t\t<div class="loyalty-amount-amount pay-amount">'+d+'</div>\n\t\t\t\t\t<div class="loyalty-amount-name">'+n+'</div>\n\t\t\t\t\t<div class="loyalty-amount mode-of-payment-control"></div>\n\t\t\t\t</div>\n\t\t\t</div>'),this["loyalty-amount_control"]=frappe.ui.form.make_control({df:{label:__("Redeem Loyalty Points"),fieldtype:"Currency",placeholder:__("Enter amount to be redeemed."),options:"company:currency",read_only:r,onchange:async function(){if(a){if(this.value>c)return frappe.show_alert({message:__("You cannot redeem more than {0}.",[format_currency(c)]),indicator:"red"}),frappe.utils.play_sound("submit"),void t["loyalty-amount_control"].set_value(0);var i=this.value>0?1:0;await frappe.model.set_value(e.doctype,e.name,"redeem_loyalty_points",i),frappe.model.set_value(e.doctype,e.name,"loyalty_points",parseInt(this.value/s))}},description:o},parent:this.$payment_modes.find(".loyalty-amount.mode-of-payment-control"),render_input:!0}),this["loyalty-amount_control"].toggle_label(!1)}}render_add_payment_method_dom(){0===this.events.get_frm().doc.docstatus&&this.$payment_modes.append('<div class="w-full pr-2">\n\t\t\t\t\t<div class="add-mode-of-payment w-half text-grey mb-4 no-select pointer">+ Add Payment Method</div>\n\t\t\t\t</div>')}update_totals_section(t){t||(t=this.events.get_frm().doc);var e=t.paid_amount,i=cint(frappe.sys_defaults.disable_rounded_total)?t.grand_total:t.rounded_total,n=i-t.paid_amount,a=t.change_amount||n<=0?-1*n:void 0,s=t.currency,o=a?__("Change"):__("To Be Paid");this.$totals.html('<div class="col">\n\t\t\t\t<div class="total-label">Grand Total</div>\n\t\t\t\t<div class="value">'+format_currency(i,s)+'</div>\n\t\t\t</div>\n\t\t\t<div class="seperator-y"></div>\n\t\t\t<div class="col">\n\t\t\t\t<div class="total-label">Paid Amount</div>\n\t\t\t\t<div class="value">'+format_currency(e,s)+'</div>\n\t\t\t</div>\n\t\t\t<div class="seperator-y"></div>\n\t\t\t<div class="col">\n\t\t\t\t<div class="total-label">'+o+'</div>\n\t\t\t\t<div class="value">'+format_currency(a||n,s)+"</div>\n\t\t\t</div>")}toggle_component(t){t?this.$component.css("display","flex"):this.$component.css("display","none")}},erpnext.PointOfSale.PastOrderList=class{constructor(t){var e=t.wrapper,i=t.events;this.wrapper=e,this.events=i,this.init_component()}init_component(){this.prepare_dom(),this.make_filter_section(),this.bind_events()}prepare_dom(){this.wrapper.append('<section class="past-order-list">\n\t\t\t\t<div class="filter-section">\n\t\t\t\t\t<div class="label">Recent Orders</div>\n\t\t\t\t\t<div class="search-field"></div>\n\t\t\t\t\t<div class="status-field"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="invoices-container"></div>\n\t\t\t</section>'),this.$component=this.wrapper.find(".past-order-list"),this.$invoices_container=this.$component.find(".invoices-container")}bind_events(){var t=this;this.search_field.$input.on("input",function(e){clearTimeout(t.last_search),t.last_search=setTimeout(function(){var i=e.target.value;t.refresh_list(i,t.status_field.get_value())},300)});var e=this;this.$invoices_container.on("click",".invoice-wrapper",function(){var t=unescape($(this).attr("data-invoice-name"));e.events.open_invoice_data(t)})}make_filter_section(){var t=this;this.search_field=frappe.ui.form.make_control({df:{label:__("Search"),fieldtype:"Data",placeholder:__("Search by invoice id or customer name")},parent:this.$component.find(".search-field"),render_input:!0}),this.status_field=frappe.ui.form.make_control({df:{label:__("Invoice Status"),fieldtype:"Select",options:"Draft\nPaid\nConsolidated\nReturn",placeholder:__("Filter by invoice status"),onchange:function(){t.$component.is(":visible")&&t.refresh_list()}},parent:this.$component.find(".status-field"),render_input:!0}),this.search_field.toggle_label(!1),this.status_field.toggle_label(!1),this.status_field.set_value("Draft")}refresh_list(){var t=this;frappe.dom.freeze(),this.events.reset_summary();var e=this.search_field.get_value(),i=this.status_field.get_value();return this.$invoices_container.html(""),frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.get_past_order_list",freeze:!0,args:{search_term:e,status:i},callback:function(e){frappe.dom.unfreeze(),e.message.forEach(function(e){var i=t.get_invoice_html(e);t.$invoices_container.append(i)})}})}get_invoice_html(t){var e=moment(t.posting_date+" "+t.posting_time).format("Do MMMM, h:mma");return'<div class="invoice-wrapper" data-invoice-name="'+escape(t.name)+'">\n\t\t\t\t<div class="invoice-name-date">\n\t\t\t\t\t<div class="invoice-name">'+t.name+'</div>\n\t\t\t\t\t<div class="invoice-date">\n\t\t\t\t\t\t<svg class="mr-2" width="12" height="12" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">\n\t\t\t\t\t\t\t<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t'+frappe.ellipsis(t.customer,20)+'\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="invoice-total-status">\n\t\t\t\t\t<div class="invoice-total">'+(format_currency(t.grand_total,t.currency,0)||0)+'</div>\n\t\t\t\t\t<div class="invoice-date">'+e+'</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="seperator"></div>'}toggle_component(t){t?this.$component.css("display","flex")&&this.refresh_list():this.$component.css("display","none")}},erpnext.PointOfSale.PastOrderSummary=class{constructor(t){var e=t.wrapper,i=t.events;this.wrapper=e,this.events=i,this.init_component()}init_component(){this.prepare_dom(),this.init_email_print_dialog(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="past-order-summary">\n\t\t\t\t<div class="no-summary-placeholder">\n\t\t\t\t\tSelect an invoice to load summary data\n\t\t\t\t</div>\n\t\t\t\t<div class="invoice-summary-wrapper">\n\t\t\t\t\t<div class="abs-container">\n\t\t\t\t\t\t<div class="upper-section"></div>\n\t\t\t\t\t\t<div class="label">Items</div>\n\t\t\t\t\t\t<div class="items-container summary-container"></div>\n\t\t\t\t\t\t<div class="label">Totals</div>\n\t\t\t\t\t\t<div class="totals-container summary-container"></div>\n\t\t\t\t\t\t<div class="label">Payments</div>\n\t\t\t\t\t\t<div class="payments-container summary-container"></div>\n\t\t\t\t\t\t<div class="summary-btns"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</section>'),this.$component=this.wrapper.find(".past-order-summary"),this.$summary_wrapper=this.$component.find(".invoice-summary-wrapper"),this.$summary_container=this.$component.find(".abs-container"),this.$upper_section=this.$summary_container.find(".upper-section"),this.$items_container=this.$summary_container.find(".items-container"),this.$totals_container=this.$summary_container.find(".totals-container"),this.$payment_container=this.$summary_container.find(".payments-container"),this.$summary_btns=this.$summary_container.find(".summary-btns")}init_email_print_dialog(){var t=this,e=new frappe.ui.Dialog({title:"Email Receipt",fields:[{fieldname:"email_id",fieldtype:"Data",options:"Email",label:"Email ID"}],primary_action:function(){t.send_email()},primary_action_label:__("Send")});this.email_dialog=e;var i=new frappe.ui.Dialog({title:"Print Receipt",fields:[{fieldname:"print",fieldtype:"Data",label:"Print Preview"}],primary_action:function(){t.print_receipt()},primary_action_label:__("Print")});this.print_dialog=i}get_upper_section_html(t){var e=t.status,i="";return in_list(["Paid","Consolidated"],e)&&(i="green"),"Draft"===e&&(i="red"),"Return"===e&&(i="grey"),'<div class="left-section">\n\t\t\t\t\t<div class="customer-name">'+t.customer+'</div>\n\t\t\t\t\t<div class="customer-email">'+this.customer_email+'</div>\n\t\t\t\t\t<div class="cashier">Sold by: '+t.owner+'</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="right-section">\n\t\t\t\t\t<div class="paid-amount">'+format_currency(t.paid_amount,t.currency)+'</div>\n\t\t\t\t\t<div class="invoice-name">'+t.name+'</div>\n\t\t\t\t\t<span class="indicator-pill whitespace-nowrap '+i+'"><span>'+t.status+"</span></span>\n\t\t\t\t</div>"}get_item_html(t,e){return'<div class="item-row-wrapper">\n\t\t\t\t\t<div class="item-name">'+e.item_name+'</div>\n\t\t\t\t\t<div class="item-qty">'+(e.qty||0)+'</div>\n\t\t\t\t\t<div class="item-rate-disc">'+(e.rate&&e.price_list_rate&&e.rate!==e.price_list_rate?'<span class="item-disc">('+e.discount_percentage+'% off)</span>\n\t\t\t\t\t\t<div class="item-rate">'+format_currency(e.rate,t.currency)+"</div>":'<div class="item-rate">'+format_currency(e.price_list_rate||e.rate,t.currency)+"</div>")+"</div>\n\t\t\t\t</div>"}get_discount_html(t){return t.discount_amount?'<div class="summary-row-wrapper">\n\t\t\t\t\t\t<div>Discount ('+t.additional_discount_percentage+" %)</div>\n\t\t\t\t\t\t<div>"+format_currency(t.discount_amount,t.currency)+"</div>\n\t\t\t\t\t</div>":""}get_net_total_html(t){return'<div class="summary-row-wrapper">\n\t\t\t\t\t<div>Net Total</div>\n\t\t\t\t\t<div>'+format_currency(t.net_total,t.currency)+"</div>\n\t\t\t\t</div>"}get_taxes_html(t){return t.taxes.length?'<div class="taxes-wrapper">'+t.taxes.map(function(e){return'\n\t\t\t\t<div class="tax-row">\n\t\t\t\t\t<div class="tax-label">'+(/[0-9]+/.test(e.description)?e.description:e.description+" @ "+e.rate+"%")+'</div>\n\t\t\t\t\t<div class="tax-value">'+format_currency(e.tax_amount_after_discount_amount,t.currency)+"</div>\n\t\t\t\t</div>\n\t\t\t"}).join("")+"</div>":""}get_grand_total_html(t){return'<div class="summary-row-wrapper grand-total">\n\t\t\t\t\t<div>Grand Total</div>\n\t\t\t\t\t<div>'+format_currency(t.grand_total,t.currency)+"</div>\n\t\t\t\t</div>"}get_payment_html(t,e){return'<div class="summary-row-wrapper payments">\n\t\t\t\t\t<div>'+e.mode_of_payment+"</div>\n\t\t\t\t\t<div>"+format_currency(e.amount,t.currency)+"</div>\n\t\t\t\t</div>"}bind_events(){var t=this;this.$summary_container.on("click",".return-btn",function(){t.events.process_return(t.doc.name),t.toggle_component(!1),t.$component.find(".no-summary-placeholder").css("display","flex"),t.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".edit-btn",function(){t.events.edit_order(t.doc.name),t.toggle_component(!1),t.$component.find(".no-summary-placeholder").css("display","flex"),t.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".delete-btn",function(){t.events.delete_order(t.doc.name),t.show_summary_placeholder()}),this.$summary_container.on("click",".delete-btn",function(){t.events.delete_order(t.doc.name),t.show_summary_placeholder()}),this.$summary_container.on("click",".new-btn",function(){t.events.new_order(),t.toggle_component(!1),t.$component.find(".no-summary-placeholder").css("display","flex"),t.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".email-btn",function(){t.email_dialog.fields_dict.email_id.set_value(t.customer_email),t.email_dialog.show()}),this.$summary_container.on("click",".print-btn",function(){t.print_receipt()})}print_receipt(){var t=this.events.get_frm();frappe.utils.print(this.doc.doctype,this.doc.name,t.pos_print_format,this.doc.letter_head,this.doc.language||frappe.boot.lang)}attach_shortcuts(){var t=this,e=frappe.utils.is_mac()?"⌘":"Ctrl";this.$summary_container.find(".print-btn").attr("title",e+"+P"),frappe.ui.keys.add_shortcut({shortcut:"ctrl+p",action:function(){return t.$summary_container.find(".print-btn").click()},condition:function(){return t.$component.is(":visible")&&t.$summary_container.find(".print-btn").is(":visible")},description:__("Print Receipt"),page:cur_page.page.page}),this.$summary_container.find(".new-btn").attr("title",e+"+Enter"),frappe.ui.keys.on("ctrl+enter",function(){t.$component.is(":visible")&&t.$summary_container.find(".new-btn").is(":visible")&&t.$summary_container.find(".new-btn").click()}),this.$summary_container.find(".edit-btn").attr("title",e+"+E"),frappe.ui.keys.add_shortcut({shortcut:"ctrl+e",action:function(){return t.$summary_container.find(".edit-btn").click()},condition:function(){return t.$component.is(":visible")&&t.$summary_container.find(".edit-btn").is(":visible")},description:__("Edit Receipt"),page:cur_page.page.page})}send_email(){var t=this,e=this.events.get_frm(),i=this.email_dialog.get_values().email_id,n=this.doc||e.doc,a=e.pos_print_format;frappe.call({method:"frappe.core.doctype.communication.email.make",args:{recipients:i,subject:__(e.meta.name)+": "+n.name,doctype:n.doctype,name:n.name,send_email:1,print_format:a,sender_full_name:frappe.user.full_name(),_lang:n.language},callback:function(e){e.exc?frappe.msgprint(__("There were errors while sending email. Please try again.")):(frappe.utils.play_sound("email"),e.message.emails_not_sent_to?frappe.msgprint(__("Email not sent to {0} (unsubscribed / disabled)",[frappe.utils.escape_html(e.message.emails_not_sent_to)])):frappe.show_alert({message:__("Email sent successfully."),indicator:"green"}),t.email_dialog.hide())}})}add_summary_btns(t){var e=this;this.$summary_btns.html(""),t.forEach(function(t){t.condition&&t.visible_btns.forEach(function(t){var i=t.split(" ")[0].toLowerCase();e.$summary_btns.append('<div class="summary-btn btn btn-default '+i+'-btn">'+t+"</div>")})}),this.$summary_btns.children().last().removeClass("mr-4")}toggle_summary_placeholder(t){t?(this.$summary_wrapper.css("display","none"),this.$component.find(".no-summary-placeholder").css("display","flex")):(this.$summary_wrapper.css("display","flex"),this.$component.find(".no-summary-placeholder").css("display","none"))}get_condition_btn_map(t){return t?[{condition:!0,visible_btns:["Print Receipt","Email Receipt","New Order"]}]:[{condition:0===this.doc.docstatus,visible_btns:["Edit Order","Delete Order"]},{condition:!this.doc.is_return&&1===this.doc.docstatus,visible_btns:["Print Receipt","Email Receipt","Return"]},{condition:this.doc.is_return&&1===this.doc.docstatus,visible_btns:["Print Receipt","Email Receipt"]}]}load_summary_of(t,e){void 0===e&&(e=!1),e?this.$component.css("grid-column","span 10 / span 10"):this.$component.css("grid-column","span 6 / span 6"),this.toggle_summary_placeholder(!1),this.doc=t,this.attach_document_info(t),this.attach_items_info(t),this.attach_totals_info(t),this.attach_payments_info(t);var i=this.get_condition_btn_map(e);this.add_summary_btns(i)}attach_document_info(t){var e=this;frappe.db.get_value("Customer",this.doc.customer,"email_id").then(function(i){var n=i.message;e.customer_email=n.email_id||"";var a=e.get_upper_section_html(t);e.$upper_section.html(a)})}attach_items_info(t){var e=this;this.$items_container.html(""),t.items.forEach(function(i){var n=e.get_item_html(t,i);e.$items_container.append(n),e.set_dynamic_rate_header_width()})}set_dynamic_rate_header_width(){var t=Array.from(this.$items_container.find(".item-rate-disc"));this.$items_container.find(".item-rate-disc").css("width","");var e=t.reduce(function(t,e){return $(e).width()>t&&(t=$(e).width()),t},0);1==(e+=1)&&(e=""),this.$items_container.find(".item-rate-disc").css("width",e)}attach_payments_info(t){var e=this;if(this.$payment_container.html(""),t.payments.forEach(function(i){if(i.amount){var n=e.get_payment_html(t,i);e.$payment_container.append(n)}}),t.redeem_loyalty_points&&t.loyalty_amount){var i=this.get_payment_html(t,{mode_of_payment:"Loyalty Points",amount:t.loyalty_amount});this.$payment_container.append(i)}}attach_totals_info(t){this.$totals_container.html("");var e=this.get_net_total_html(t),i=this.get_taxes_html(t),n=this.get_discount_html(t),a=this.get_grand_total_html(t);this.$totals_container.append(e),this.$totals_container.append(i),this.$totals_container.append(n),this.$totals_container.append(a)}toggle_component(t){t?this.$component.css("display","flex"):this.$component.css("display","none")}},erpnext.PointOfSale.Controller=class{constructor(t){this.wrapper=$(t).find(".layout-main-section"),this.page=t.page,this.check_opening_entry()}fetch_opening_entry(){return frappe.call("erpnext.selling.page.point_of_sale.point_of_sale.check_opening_entry",{user:frappe.session.user})}check_opening_entry(){var t=this;this.fetch_opening_entry().then(function(e){e.message.length?t.prepare_app_defaults(e.message[0]):t.create_opening_voucher()})}create_opening_voucher(){var t=this,e=[{fieldname:"mode_of_payment",fieldtype:"Link",in_list_view:1,label:"Mode of Payment",options:"Mode of Payment",reqd:1},{fieldname:"opening_amount",fieldtype:"Currency",in_list_view:1,label:"Opening Amount",options:"company:company_currency",change:function(){var t=this;i.fields_dict.balance_details.df.data.some(function(e){if(e.idx==t.doc.idx)return e.opening_amount=t.value,i.fields_dict.balance_details.grid.refresh(),!0})}}],i=new frappe.ui.Dialog({title:__("Create POS Opening Entry"),static:!0,fields:[{fieldtype:"Link",label:__("Company"),default:frappe.defaults.get_default("company"),options:"Company",fieldname:"company",reqd:1},{fieldtype:"Link",label:__("POS Profile"),options:"POS Profile",fieldname:"pos_profile",reqd:1,get_query:function(){return n},onchange:function(){var t;(t=i.fields_dict.pos_profile.get_value())&&frappe.db.get_doc("POS Profile",t).then(function(t){var e=t.payments;i.fields_dict.balance_details.df.data=[],e.forEach(function(t){var e=t.mode_of_payment;i.fields_dict.balance_details.df.data.push({mode_of_payment:e,opening_amount:"0"})}),i.fields_dict.balance_details.grid.refresh()})}},{fieldname:"balance_details",fieldtype:"Table",label:"Opening Balance Details",cannot_add_rows:!1,in_place_edit:!0,reqd:1,data:[],fields:e}],primary_action:async function(e){var n=e.company,a=e.pos_profile,s=e.balance_details;if(!s.length)return frappe.show_alert({message:__("Please add Mode of payments and opening balance details."),indicator:"red"}),frappe.utils.play_sound("error");s=s.filter(function(t){return t.mode_of_payment});var o=await frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.create_opening_voucher",args:{pos_profile:a,company:n,balance_details:s},freeze:!0});!o.exc&&t.prepare_app_defaults(o.message),i.hide()},primary_action_label:__("Submit")});i.show();var n={query:"erpnext.accounts.doctype.pos_profile.pos_profile.pos_profile_query",filters:{company:i.fields_dict.company.get_value()}}}async prepare_app_defaults(t){var e=this;this.pos_opening=t.name,this.company=t.company,this.pos_profile=t.pos_profile,this.pos_opening_time=t.period_start_date,this.item_stock_map={},this.settings={},frappe.db.get_value("Stock Settings",void 0,"allow_negative_stock").then(function(t){var i=t.message;e.allow_negative_stock=flt(i.allow_negative_stock)||!1}),frappe.db.get_doc("POS Profile",this.pos_profile).then(function(t){Object.assign(e.settings,t),e.settings.customer_groups=t.customer_groups.map(function(t){return t.customer_group}),e.make_app()})}set_opening_entry_status(){this.page.set_title_sub('<span class="indicator orange">\n\t\t\t\t<a class="text-muted" href="#Form/POS%20Opening%20Entry/'+this.pos_opening+'">\n\t\t\t\t\tOpened at '+moment(this.pos_opening_time).format("Do MMMM, h:mma")+"\n\t\t\t\t</a>\n\t\t\t</span>")}make_app(){this.prepare_dom(),this.prepare_components(),this.prepare_menu(),this.make_new_invoice()}prepare_dom(){this.wrapper.append('<div class="point-of-sale-app"></div>'),this.$components_wrapper=this.wrapper.find(".point-of-sale-app")}prepare_components(){this.init_item_selector(),this.init_item_details(),this.init_item_cart(),this.init_payments(),this.init_recent_order_list(),this.init_order_summary()}prepare_menu(){this.page.clear_menu(),this.page.add_menu_item(__("Open Form View"),this.open_form_view.bind(this),!1,"Ctrl+F"),this.page.add_menu_item(__("Toggle Recent Orders"),this.toggle_recent_order.bind(this),!1,"Ctrl+O"),this.page.add_menu_item(__("Save as Draft"),this.save_draft_invoice.bind(this),!1,"Ctrl+S"),this.page.add_menu_item(__("Close the POS"),this.close_pos.bind(this),!1,"Shift+Ctrl+C")}open_form_view(){frappe.model.sync(this.frm.doc),frappe.set_route("Form",this.frm.doc.doctype,this.frm.doc.name)}toggle_recent_order(){var t=this.recent_order_list.$component.is(":hidden");this.toggle_recent_order_list(t)}save_draft_invoice(){var t=this;if(this.$components_wrapper.is(":visible"))return 0==this.frm.doc.items.length?(frappe.show_alert({message:__("You must add atleast one item to save it as draft."),indicator:"red"}),void frappe.utils.play_sound("error")):void this.frm.save(void 0,void 0,void 0,function(){frappe.show_alert({message:__("There was an error saving the document."),indicator:"red"}),frappe.utils.play_sound("error")}).then(function(){frappe.run_serially([function(){return frappe.dom.freeze()},function(){return t.make_new_invoice()},function(){return frappe.dom.unfreeze()}])})}close_pos(){if(this.$components_wrapper.is(":visible")){var t=frappe.model.get_new_doc("POS Closing Entry");t.pos_profile=this.frm.doc.pos_profile,t.user=frappe.session.user,t.company=this.frm.doc.company,t.pos_opening_entry=this.pos_opening,t.period_end_date=frappe.datetime.now_datetime(),t.posting_date=frappe.datetime.now_date(),frappe.set_route("Form","POS Closing Entry",t.name)}}init_item_selector(){var t=this;this.item_selector=new erpnext.PointOfSale.ItemSelector({wrapper:this.$components_wrapper,pos_profile:this.pos_profile,settings:this.settings,events:{item_selected:function(e){return t.on_cart_update(e)},get_frm:function(){return t.frm||{}}}})}init_item_cart(){var t=this;this.cart=new erpnext.PointOfSale.ItemCart({wrapper:this.$components_wrapper,settings:this.settings,events:{get_frm:function(){return t.frm},cart_item_clicked:function(e){var i=t.get_item_from_frm(e);t.item_details.toggle_item_details_section(i)},numpad_event:function(e,i){return t.update_item_field(e,i)},checkout:function(){return t.payment.checkout()},edit_cart:function(){return t.payment.edit_cart()},customer_details_updated:function(e){t.customer_details=e,t.payment.render_loyalty_points_payment_mode()}}})}init_item_details(){var t=this;this.item_details=new erpnext.PointOfSale.ItemDetails({wrapper:this.$components_wrapper,settings:this.settings,events:{get_frm:function(){return t.frm},toggle_item_selector:function(e){t.item_selector.resize_selector(e),t.cart.toggle_numpad(e)},form_updated:function(e,i,n){var a=frappe.model.get_doc(e.doctype,e.name);if(a&&a[i]!=n){var s={field:i,value:n,item:t.item_details.current_item};return t.on_cart_update(s)}return Promise.resolve()},highlight_cart_item:function(e){var i=t.cart.get_cart_item(e);t.cart.toggle_item_highlight(i)},item_field_focused:function(e){t.cart.toggle_numpad_field_edit(e)},set_value_in_current_cart_item:function(e,i){t.cart.update_selector_value_in_cart_item(e,i,t.item_details.current_item)},clone_new_batch_item_in_frm:function(e,i){Object.keys(e).forEach(function(n){var a=t.frm.doc.items.find(function(t){return t.name==i.name}),s=t.frm.add_child("items",Object.assign({},a));s.batch_no=n,s.serial_no=e[n].join("\n"),s.qty=e[n].length,t.frm.doc.items.forEach(function(e){i.item_code===e.item_code&&t.update_cart_html(e)})})},remove_item_from_cart:function(){return t.remove_item_from_cart()},get_item_stock_map:function(){return t.item_stock_map},close_item_details:function(){t.item_details.toggle_item_details_section(null),t.cart.prev_action=null,t.cart.toggle_item_highlight()},get_available_stock:function(e,i){return t.get_available_stock(e,i)}}})}init_payments(){var t=this;this.payment=new erpnext.PointOfSale.Payment({wrapper:this.$components_wrapper,events:{get_frm:function(){return t.frm||{}},get_customer_details:function(){return t.customer_details||{}},toggle_other_sections:function(e){e?(t.item_details.$component.is(":visible")&&t.item_details.$component.css("display","none"),t.item_selector.$component.css("display","none")):t.item_selector.$component.css("display","flex")},submit_invoice:function(){t.frm.savesubmit().then(function(e){t.toggle_components(!1),t.order_summary.toggle_component(!0),t.order_summary.load_summary_of(t.frm.doc,!0),frappe.show_alert({indicator:"green",message:__("POS invoice {0} created succesfully",[e.doc.name])})})}}})}init_recent_order_list(){var t=this;this.recent_order_list=new erpnext.PointOfSale.PastOrderList({wrapper:this.$components_wrapper,events:{open_invoice_data:function(e){frappe.db.get_doc("POS Invoice",e).then(function(e){t.order_summary.load_summary_of(e)})},reset_summary:function(){return t.order_summary.toggle_summary_placeholder(!0)}}})}init_order_summary(){var t=this;this.order_summary=new erpnext.PointOfSale.PastOrderSummary({wrapper:this.$components_wrapper,events:{get_frm:function(){return t.frm},process_return:function(e){t.recent_order_list.toggle_component(!1),frappe.db.get_doc("POS Invoice",e).then(function(e){frappe.run_serially([function(){return t.make_return_invoice(e)},function(){return t.cart.load_invoice()},function(){return t.item_selector.toggle_component(!0)}])})},edit_order:function(e){t.recent_order_list.toggle_component(!1),frappe.run_serially([function(){return t.frm.refresh(e)},function(){return t.frm.call("reset_mode_of_payments")},function(){return t.cart.load_invoice()},function(){return t.item_selector.toggle_component(!0)}])},delete_order:function(e){frappe.model.delete_doc(t.frm.doc.doctype,e,function(){t.recent_order_list.refresh_list()})},new_order:function(){frappe.run_serially([function(){return frappe.dom.freeze()},function(){return t.make_new_invoice()},function(){return t.item_selector.toggle_component(!0)},function(){return frappe.dom.unfreeze()}])}}})}toggle_recent_order_list(t){this.toggle_components(!t),this.recent_order_list.toggle_component(t),this.order_summary.toggle_component(t)}toggle_components(t){this.cart.toggle_component(t),this.item_selector.toggle_component(t),!t&&(this.item_details.toggle_component(!1)||this.payment.toggle_component(!1))}make_new_invoice(){var t=this;return frappe.run_serially([function(){return frappe.dom.freeze()},function(){return t.make_sales_invoice_frm()},function(){return t.set_pos_profile_data()},function(){return t.set_pos_profile_status()},function(){return t.cart.load_invoice()},function(){return frappe.dom.unfreeze()}])}make_sales_invoice_frm(){var t=this;return new Promise(function(e){t.frm?(t.frm=t.get_new_frm(t.frm),t.frm.doc.items=[],t.frm.doc.is_pos=1,e()):frappe.model.with_doctype("POS Invoice",function(){t.frm=t.get_new_frm(),t.frm.doc.items=[],t.frm.doc.is_pos=1,e()})})}get_new_frm(t){var e=$("<div>"),i=t||new frappe.ui.form.Form("POS Invoice",e,!1),n=frappe.model.make_new_doc_and_get_name("POS Invoice",!0);return i.refresh(n),i}async make_return_invoice(t){frappe.dom.freeze(),this.frm=this.get_new_frm(this.frm),this.frm.doc.items=[];var e=await frappe.call({method:"erpnext.accounts.doctype.pos_invoice.pos_invoice.make_sales_return",args:{source_name:t.name,target_doc:this.frm.doc}});frappe.model.sync(e.message),await this.set_pos_profile_data(),frappe.dom.unfreeze()}set_pos_profile_data(){if(this.company&&!this.frm.doc.company&&(this.frm.doc.company=this.company),this.pos_profile&&!this.frm.doc.pos_profile&&(this.frm.doc.pos_profile=this.pos_profile),this.frm.doc.company)return this.frm.trigger("set_pos_data")}set_pos_profile_status(){this.page.set_indicator(this.pos_profile,"blue")}async on_cart_update(t){frappe.dom.freeze();var e=void 0;try{var i=t.field,n=t.value,a=t.item;e=this.get_item_from_frm(a);var s=!$.isEmptyObject(e),o="qty"===i&&"+1"===n;if(o&&(n=flt(e.qty)+flt(n)),s){if("qty"===i&&(n=flt(n)),["qty","conversion_factor"].includes(i)&&n>0&&!this.allow_negative_stock){var r="qty"===i?n*e.conversion_factor:e.qty*n;await this.check_stock_availability(e,r,this.frm.doc.set_warehouse)}(this.is_current_item_being_edited(e)||o)&&(await frappe.model.set_value(e.doctype,e.name,i,n),this.update_cart_html(e))}else{if(!this.frm.doc.customer)return this.raise_customer_selection_alert();var c=a.item_code,d=a.batch_no,_=a.serial_no,l=a.rate;if(!c)return;var m={item_code:c,batch_no:d,rate:l};m[i]=n,_&&(await this.check_serial_no_availablilty(c,this.frm.doc.set_warehouse,_),m.serial_no=_),"serial_no"===i&&(m.qty=n.split("\n").length||0),e=this.frm.add_child("items",m),"qty"!==i||0===n||this.allow_negative_stock||await this.check_stock_availability(e,n,this.frm.doc.set_warehouse),await this.trigger_new_item_events(e),this.update_cart_html(e),this.item_details.$component.is(":visible")&&this.edit_item_details_of(e),this.check_serial_batch_selection_needed(e)&&this.edit_item_details_of(e)}}catch(t){console.log(t)}finally{return frappe.dom.unfreeze(),e}}raise_customer_selection_alert(){frappe.dom.unfreeze(),frappe.show_alert({message:__("You must select a customer before adding an item."),indicator:"orange"}),frappe.utils.play_sound("error")}get_item_from_frm(t){var e=t.name,i=t.item_code,n=t.batch_no,a=t.uom,s=t.rate,o=null;if(e)o=this.frm.doc.items.find(function(t){return t.name==e});else{var r=n;o=this.frm.doc.items.find(function(t){return t.item_code===i&&(!r||r&&t.batch_no===n)&&t.uom===a&&t.rate==s})}return o||{}}edit_item_details_of(t){this.item_details.toggle_item_details_section(t)}is_current_item_being_edited(t){return t.name==this.item_details.current_item.name}update_cart_html(t,e){this.cart.update_item_html(t,e),this.cart.update_totals_section(this.frm)}check_serial_batch_selection_needed(t){var e=t.has_serial_no,i=t.has_batch_no,n=!t.serial_no,a=!t.batch_no;return!!(e&&n||i&&a||e&&i&&(a||n))}async trigger_new_item_events(t){await this.frm.script_manager.trigger("item_code",t.doctype,t.name),await this.frm.script_manager.trigger("qty",t.doctype,t.name)}async check_stock_availability(t,e,i){var n=(await this.get_available_stock(t.item_code,i)).message;frappe.dom.unfreeze();var a=t.item_code.bold(),s=i.bold(),o=n.toString().bold();n>0?n<e&&(frappe.show_alert({message:__("Stock quantity not enough for Item Code: {0} under warehouse {1}. Available quantity {2}.",[a,s,o]),indicator:"orange"}),frappe.utils.play_sound("error")):(frappe.model.clear_doc(t.doctype,t.name),frappe.throw({title:__("Not Available"),message:__("Item Code: {0} is not available under warehouse {1}.",[a,s])})),frappe.dom.freeze()}async check_serial_no_availablilty(t,e,i){var n={filters:{item_code:t,warehouse:e}};(await frappe.call({method:"erpnext.stock.doctype.serial_no.serial_no.get_pos_reserved_serial_nos",args:n})).message.includes(i)&&frappe.throw({title:__("Not Available"),message:__("Serial No: {0} has already been transacted into another POS Invoice.",[i.bold()])})}get_available_stock(t,e){var i=this;return frappe.call({method:"erpnext.accounts.doctype.pos_invoice.pos_invoice.get_stock_availability",args:{item_code:t,warehouse:e},callback:function(n){i.item_stock_map[t]||(i.item_stock_map[t]={}),i.item_stock_map[t][e]=n.message}})}update_item_field(t,e){if("checkout"===e)this.item_details.toggle_item_details_section(null);else if("remove"===e)this.remove_item_from_cart();else{var i=this.item_details[e+"_control"];if(!i)return;i.set_focus(),""!=t&&i.set_value(t)}}remove_item_from_cart(){var t=this;frappe.dom.freeze();var e=this.item_details,i=e.doctype,n=e.name,a=e.current_item;frappe.model.set_value(i,n,"qty",0).then(function(){frappe.model.clear_doc(i,n),t.update_cart_html(a,!0),t.item_details.toggle_item_details_section(null),frappe.dom.unfreeze()}).catch(function(t){return console.log(t)})}}}();
//# sourceMappingURL=point-of-sale.min.js.map
