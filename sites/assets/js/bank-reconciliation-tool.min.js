!function(){"use strict";frappe.provide("erpnext.accounts.bank_reconciliation"),erpnext.accounts.bank_reconciliation.DataTableManager=class{constructor(e){Object.assign(this,e),this.dialog_manager=new erpnext.accounts.bank_reconciliation.DialogManager(this.company,this.bank_account),this.make_dt()}make_dt(){var e=this;frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.get_bank_transactions",args:{bank_account:this.bank_account},callback:function(a){e.format_data(a.message),e.get_dt_columns(),e.get_datatable(),e.set_listeners()}})}get_dt_columns(){var e=this;this.columns=[{name:"Date",editable:!1,width:100},{name:"Party Type",editable:!1,width:95},{name:"Party",editable:!1,width:100},{name:"Description",editable:!1,width:350},{name:"Deposit",editable:!1,width:100,format:function(a){return"<span style='color:green;'>"+format_currency(a,e.currency)+"</span>"}},{name:"Withdrawal",editable:!1,width:100,format:function(a){return"<span style='color:red;'>"+format_currency(a,e.currency)+"</span>"}},{name:"Unallocated Amount",editable:!1,width:100,format:function(a){return"<span style='color:blue;'>"+format_currency(a,e.currency)+"</span>"}},{name:"Reference Number",editable:!1,width:140},{name:"Actions",editable:!1,sortable:!1,focusable:!1,dropdown:!1,width:80}]}format_data(e){var a,t=this;this.transactions=[],e[0]&&(this.currency=e[0].currency),this.transaction_dt_map={},e.forEach(function(e){a=t.transactions.push(t.format_row(e)),t.transaction_dt_map[e.name]=a-1})}format_row(e){return[e.date,e.party_type,e.party,e.description,e.deposit,e.withdrawal,e.unallocated_amount,e.reference_number,'\n\t\t\t<Button class="btn btn-primary btn-xs center"  data-name = '+e.name+" >\n\t\t\t\tActions\n\t\t\t</a>\n\t\t\t"]}get_datatable(){var e={columns:this.columns,data:this.transactions,dynamicRowHeight:!0,checkboxColumn:!1,inlineFilters:!0};this.datatable=new frappe.DataTable(this.$reconciliation_tool_dt.get(0),e),$("."+this.datatable.style.scopeClass+" .dt-scrollable").css("max-height","calc(100vh - 400px)"),this.transactions.length>0?(this.$reconciliation_tool_dt.show(),this.$no_bank_transactions.hide()):(this.$reconciliation_tool_dt.hide(),this.$no_bank_transactions.show())}set_listeners(){var e=this;$("."+this.datatable.style.scopeClass+" .dt-scrollable").on("click",".btn",function(){return e.dialog_manager.show_dialog($(this).attr("data-name"),function(a){return e.update_dt_cards(a)}),!0})}update_dt_cards(e){var a=this,t=this.transaction_dt_map[e.name];e.unallocated_amount>0?this.transactions[t]=this.format_row(e):this.transactions.splice(t,1),this.datatable.refresh(this.transactions,this.columns),0==this.transactions.length&&(this.$reconciliation_tool_dt.hide(),this.$no_bank_transactions.show()),this.get_cleared_balance().then(function(){a.cards_manager.$cards[1].set_value(format_currency(a.cleared_balance),a.currency),a.cards_manager.$cards[2].set_value(format_currency(a.bank_statement_closing_balance-a.cleared_balance),a.currency),a.cards_manager.$cards[2].set_value_color(a.bank_statement_closing_balance-a.cleared_balance==0?"text-success":"text-danger")})}get_cleared_balance(){var e=this;if(this.bank_account&&this.bank_statement_to_date)return frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.get_account_balance",args:{bank_account:this.bank_account,till_date:this.bank_statement_to_date},callback:function(a){return e.cleared_balance=a.message}})}},frappe.provide("erpnext.accounts.bank_reconciliation"),erpnext.accounts.bank_reconciliation.NumberCardManager=class{constructor(e){Object.assign(this,e),this.make_cards()}make_cards(){var e=this;this.$reconciliation_tool_cards.empty(),this.$cards=[],this.$summary=$('<div class="report-summary"></div>').hide().appendTo(this.$reconciliation_tool_cards),[{value:this.bank_statement_closing_balance,label:"Closing Balance as per Bank Statement",datatype:"Currency",currency:this.currency},{value:this.cleared_balance,label:"Closing Balance as per ERP",datatype:"Currency",currency:this.currency},{value:this.bank_statement_closing_balance-this.cleared_balance,label:"Difference",datatype:"Currency",currency:this.currency}].forEach(function(a){var t=new erpnext.accounts.NumberCard(a);e.$cards.push(t),t.$card.appendTo(e.$summary)}),this.$cards[2].set_value_color(this.bank_statement_closing_balance-this.cleared_balance==0?"text-success":"text-danger"),this.$summary.css({"border-bottom":"0px","margin-left":"0px","margin-right":"0px"}),this.$summary.show()}},erpnext.accounts.NumberCard=class{constructor(e){this.$card=frappe.utils.build_summary_item(e)}set_value(e){this.$card.find("div").text(e)}set_value_color(e){this.$card.find("div").removeClass("text-danger text-success").addClass(""+e)}set_indicator(e){this.$card.find("span").removeClass("indicator red green").addClass("indicator "+e)}},frappe.provide("erpnext.accounts.bank_reconciliation"),erpnext.accounts.bank_reconciliation.DialogManager=class{constructor(e,a){this.bank_account=a,this.company=e,this.make_dialog()}show_dialog(e,a){var t=this;this.bank_transaction_name=e,this.update_dt_cards=a,frappe.call({method:"frappe.client.get_value",args:{doctype:"Bank Transaction",filters:{name:this.bank_transaction_name},fieldname:["date","deposit","withdrawal","currency","description","name","bank_account","company","reference_number","party_type","party","unallocated_amount","allocated_amount"]},callback:function(e){e.message&&(t.bank_transaction=e.message,e.message.payment_entry=1,t.dialog.set_values(e.message),t.dialog.show())}})}get_linked_vouchers(e){var a=this;frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.get_linked_payments",args:{bank_transaction_name:this.bank_transaction_name,document_types:e},callback:function(e){var t=e.message;if(t&&t.length>0){var n=a.dialog.fields_dict.payment_proposals.$wrapper;n.show(),a.dialog.fields_dict.no_matching_vouchers.$wrapper.hide(),a.data=[],t.forEach(function(e){var t=e[5]?e[5]:e[8];a.data.push([e[1],e[2],t,format_currency(e[3],e[9]),e[6],e[4]])}),a.get_dt_columns(),a.get_datatable(n)}else{a.dialog.fields_dict.payment_proposals.$wrapper.hide(),a.dialog.fields_dict.no_matching_vouchers.$wrapper.show()}a.dialog.show()}})}get_dt_columns(){this.columns=[{name:"Document Type",editable:!1,width:125},{name:"Document Name",editable:!1,width:150},{name:"Reference Date",editable:!1,width:120},{name:"Amount",editable:!1,width:100},{name:"Party",editable:!1,width:120},{name:"Reference Number",editable:!1,width:140}]}get_datatable(e){if(this.datatable)this.datatable.refresh(this.data,this.columns),this.datatable.rowmanager.checkMap=[];else{var a={columns:this.columns,data:this.data,dynamicRowHeight:!0,checkboxColumn:!0,inlineFilters:!0};this.datatable=new frappe.DataTable(e.get(0),a)}}make_dialog(){var e=this;this.selected_payment=null;var a=[{label:__("Action"),fieldname:"action",fieldtype:"Select",options:"Match Against Voucher\nCreate Voucher\nUpdate Bank Transaction",default:"Match Against Voucher"},{fieldname:"column_break_4",fieldtype:"Column Break"},{label:__("Document Type"),fieldname:"document_type",fieldtype:"Select",options:"Payment Entry\nJournal Entry",default:"Payment Entry",depends_on:"eval:doc.action=='Create Voucher'"},{fieldtype:"Section Break",fieldname:"section_break_1",label:__("Filters"),depends_on:"eval:doc.action=='Match Against Voucher'"},{fieldtype:"Check",label:"Payment Entry",fieldname:"payment_entry",onchange:function(){return e.update_options()}},{fieldtype:"Check",label:"Journal Entry",fieldname:"journal_entry",onchange:function(){return e.update_options()}},{fieldname:"column_break_5",fieldtype:"Column Break"},{fieldtype:"Check",label:"Sales Invoice",fieldname:"sales_invoice",onchange:function(){return e.update_options()}},{fieldtype:"Check",label:"Purchase Invoice",fieldname:"purchase_invoice",onchange:function(){return e.update_options()}},{fieldname:"column_break_5",fieldtype:"Column Break"},{fieldtype:"Check",label:"Expense Claim",fieldname:"expense_claim",onchange:function(){return e.update_options()}},{fieldtype:"Check",label:"Show Only Exact Amount",fieldname:"exact_match",onchange:function(){return e.update_options()}},{fieldtype:"Section Break",fieldname:"section_break_1",label:__("Select Vouchers to Match"),depends_on:"eval:doc.action=='Match Against Voucher'"},{fieldtype:"HTML",fieldname:"payment_proposals"},{fieldtype:"HTML",fieldname:"no_matching_vouchers",options:'<div class="text-muted text-center">No Matching Vouchers Found</div>'},{fieldtype:"Section Break",fieldname:"details",label:"Details",depends_on:"eval:doc.action!='Match Against Voucher'"},{fieldname:"reference_number",fieldtype:"Data",label:"Reference Number",mandatory_depends_on:"eval:doc.action=='Create Voucher'"},{default:"Today",fieldname:"posting_date",fieldtype:"Date",label:"Posting Date",reqd:1,depends_on:"eval:doc.action=='Create Voucher'"},{fieldname:"reference_date",fieldtype:"Date",label:"Cheque/Reference Date",mandatory_depends_on:"eval:doc.action=='Create Voucher'",depends_on:"eval:doc.action=='Create Voucher'",reqd:1},{fieldname:"mode_of_payment",fieldtype:"Link",label:"Mode of Payment",options:"Mode of Payment",depends_on:"eval:doc.action=='Create Voucher'"},{fieldname:"edit_in_full_page",fieldtype:"Button",label:"Edit in Full Page",click:function(){e.edit_in_full_page()},depends_on:"eval:doc.action=='Create Voucher'"},{fieldname:"column_break_7",fieldtype:"Column Break"},{default:"Journal Entry Type",fieldname:"journal_entry_type",fieldtype:"Select",label:"Journal Entry Type",options:"Journal Entry\nInter Company Journal Entry\nBank Entry\nCash Entry\nCredit Card Entry\nDebit Note\nCredit Note\nContra Entry\nExcise Entry\nWrite Off Entry\nOpening Entry\nDepreciation Entry\nExchange Rate Revaluation\nDeferred Revenue\nDeferred Expense",depends_on:"eval:doc.action=='Create Voucher' &&  doc.document_type=='Journal Entry'",mandatory_depends_on:"eval:doc.action=='Create Voucher' &&  doc.document_type=='Journal Entry'"},{fieldname:"second_account",fieldtype:"Link",label:"Account",options:"Account",depends_on:"eval:doc.action=='Create Voucher' &&  doc.document_type=='Journal Entry'",mandatory_depends_on:"eval:doc.action=='Create Voucher' &&  doc.document_type=='Journal Entry'",get_query:function(){return{filters:{is_group:0,company:e.company}}}},{fieldname:"party_type",fieldtype:"Link",label:"Party Type",options:"DocType",mandatory_depends_on:"eval:doc.action=='Create Voucher' &&  doc.document_type=='Payment Entry'",get_query:function(){return{filters:{name:["in",Object.keys(frappe.boot.party_account_types)]}}}},{fieldname:"party",fieldtype:"Dynamic Link",label:"Party",options:"party_type",mandatory_depends_on:"eval:doc.action=='Create Voucher' && doc.document_type=='Payment Entry'"},{fieldname:"project",fieldtype:"Link",label:"Project",options:"Project",depends_on:"eval:doc.action=='Create Voucher' && doc.document_type=='Payment Entry'"},{fieldname:"cost_center",fieldtype:"Link",label:"Cost Center",options:"Cost Center",depends_on:"eval:doc.action=='Create Voucher' && doc.document_type=='Payment Entry'"},{fieldtype:"Section Break",fieldname:"details_section",label:"Transaction Details",collapsible:1},{fieldname:"deposit",fieldtype:"Currency",label:"Deposit",read_only:1},{fieldname:"withdrawal",fieldtype:"Currency",label:"Withdrawal",read_only:1},{fieldname:"description",fieldtype:"Small Text",label:"Description",read_only:1},{fieldname:"column_break_17",fieldtype:"Column Break",read_only:1},{fieldname:"allocated_amount",fieldtype:"Currency",label:"Allocated Amount",read_only:1},{fieldname:"unallocated_amount",fieldtype:"Currency",label:"Unallocated Amount",read_only:1}];this.dialog=new frappe.ui.Dialog({title:__("Reconcile the Bank Transaction"),fields:a,size:"large",primary_action:function(a){return e.reconciliation_dialog_primary_action(a)}})}get_selected_attributes(){var e=[];return this.dialog.$wrapper.find(".checkbox input").each(function(a,t){$(t).is(":checked")&&e.push($(t).attr("data-fieldname"))}),e}update_options(){var e=this.get_selected_attributes();this.get_linked_vouchers(e)}reconciliation_dialog_primary_action(e){"Match Against Voucher"==e.action&&this.match(e),"Create Voucher"==e.action&&"Payment Entry"==e.document_type&&this.add_payment_entry(e),"Create Voucher"==e.action&&"Journal Entry"==e.document_type?this.add_journal_entry(e):"Update Bank Transaction"==e.action&&this.update_transaction(e)}match(){var e=this,a=this.datatable.rowmanager.checkMap,t=[];a.forEach(function(a,n){1==a&&t.push(e.datatable.datamanager.rows[n])});var n=[];t.forEach(function(e){n.push({payment_doctype:e[2].content,payment_name:e[3].content,amount:e[5].content})}),frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.reconcile_vouchers",args:{bank_transaction_name:this.bank_transaction.name,vouchers:n},callback:function(a){var t="Bank Transaction "+e.bank_transaction.name+" Matched";frappe.show_alert(t),e.update_dt_cards(a.message),e.dialog.hide()}})}add_payment_entry(e){var a=this;frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.create_payment_entry_bts",args:{bank_transaction_name:this.bank_transaction.name,reference_number:e.reference_number,reference_date:e.reference_date,party_type:e.party_type,party:e.party,posting_date:e.posting_date,mode_of_payment:e.mode_of_payment,project:e.project,cost_center:e.cost_center},callback:function(e){var t="Bank Transaction "+a.bank_transaction.name+" added as Payment Entry";frappe.show_alert(t),a.update_dt_cards(e.message),a.dialog.hide()}})}add_journal_entry(e){var a=this;frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.create_journal_entry_bts",args:{bank_transaction_name:this.bank_transaction.name,reference_number:e.reference_number,reference_date:e.reference_date,party_type:e.party_type,party:e.party,posting_date:e.posting_date,mode_of_payment:e.mode_of_payment,entry_type:e.journal_entry_type,second_account:e.second_account},callback:function(e){var t="Bank Transaction "+a.bank_transaction.name+" added as Journal Entry";frappe.show_alert(t),a.update_dt_cards(e.message),a.dialog.hide()}})}update_transaction(e){var a=this;frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.update_bank_transaction",args:{bank_transaction_name:this.bank_transaction.name,reference_number:e.reference_number,party_type:e.party_type,party:e.party},callback:function(e){var t="Bank Transaction "+a.bank_transaction.name+" updated";frappe.show_alert(t),a.update_dt_cards(e.message),a.dialog.hide()}})}edit_in_full_page(){var e=this.dialog.get_values(!0);"Payment Entry"==e.document_type?frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.create_payment_entry_bts",args:{bank_transaction_name:this.bank_transaction.name,reference_number:e.reference_number,reference_date:e.reference_date,party_type:e.party_type,party:e.party,posting_date:e.posting_date,mode_of_payment:e.mode_of_payment,project:e.project,cost_center:e.cost_center,allow_edit:!0},callback:function(e){var a=frappe.model.sync(e.message);frappe.set_route("Form",a[0].doctype,a[0].name)}}):frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.create_journal_entry_bts",args:{bank_transaction_name:this.bank_transaction.name,reference_number:e.reference_number,reference_date:e.reference_date,party_type:e.party_type,party:e.party,posting_date:e.posting_date,mode_of_payment:e.mode_of_payment,entry_type:e.journal_entry_type,second_account:e.second_account,allow_edit:!0},callback:function(e){var a=frappe.model.sync(e.message);frappe.set_route("Form",a[0].doctype,a[0].name)}})}}}();
//# sourceMappingURL=bank-reconciliation-tool.min.js.map
