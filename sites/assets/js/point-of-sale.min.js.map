{"version":3,"file":"point-of-sale.min.js","sources":["../../../apps/erpnext/node_modules/onscan.js/onscan.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_item_selector.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_item_cart.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_item_details.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_number_pad.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_payment.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_past_order_list.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_past_order_summary.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_controller.js"],"sourcesContent":["/*\n * onScan.js - scan-events for hardware barcodes scanners in javascript\n */\n;(function (global, factory) {\n    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :\n    typeof define === 'function' && define.amd ? define(factory()) :\n    global.onScan = factory()\n}(this, (function () {\n\tvar onScan = {\t\n\t\t\n\t\t/**\n\t\t * \n\t\t * @param DomElement oDomElement\n\t\t * @param Object oOptions\n\t\t * @return self\n\t\t */\n\t\tattachTo: function(oDomElement, oOptions) {\n\t\n\t\t\tif(oDomElement.scannerDetectionData !== undefined){\n\t\t\t\tthrow new Error(\"onScan.js is already initialized for DOM element \" + oDomElement);\n\t\t\t}\n\t\n\t\t\tvar oDefaults = {\n\t\t\t\tonScan: function(sScanned, iQty){}, // Callback after detection of a successfull scanning:  function(){sScancode, iCount)}()\n\t\t\t\tonScanError: function(oDebug){}, // Callback after detection of a unsuccessfull scanning (scanned string in parameter)\n\t\t\t\tonKeyProcess: function(sChar, oEvent){}, // Callback after receiving and processing a char (scanned char in parameter)\n\t\t\t\tonKeyDetect: function(iKeyCode, oEvent){}, // Callback after detecting a keyDown (key char in parameter) - in contrast to onKeyProcess, this fires for non-character keys like tab, arrows, etc. too!\n\t\t\t\tonPaste: function(sPasted, oEvent){}, // Callback after receiving a value on paste, no matter if it is a valid code or not\n\t\t\t\tkeyCodeMapper: function(oEvent) {return onScan.decodeKeyEvent(oEvent)}, // Custom function to decode a keydown event into a character. Must return decoded character or NULL if the given event should not be processed.\n\t\t\t\tonScanButtonLongPress: function(){}, // Callback after detection of a successfull scan while the scan button was pressed and held down\n\t\t\t\tscanButtonKeyCode:false, // Key code of the scanner hardware button (if the scanner button a acts as a key itself) \n\t\t\t\tscanButtonLongPressTime:500, // How long (ms) the hardware button should be pressed, until a callback gets executed\n\t\t\t\ttimeBeforeScanTest:100, // Wait duration (ms) after keypress event to check if scanning is finished\n\t\t\t\tavgTimeByChar:30, // Average time (ms) between 2 chars. Used to do difference between keyboard typing and scanning\n\t\t\t\tminLength:6, // Minimum length for a scanning\n\t\t\t\tsuffixKeyCodes:[9,13], // Chars to remove and means end of scanning\n\t\t\t\tprefixKeyCodes:[], // Chars to remove and means start of scanning\n\t\t\t\tignoreIfFocusOn:false, // do not handle scans if the currently focused element matches this selector or object\n\t\t\t\tstopPropagation:false, // Stop immediate propagation on keypress event\n\t\t\t\tpreventDefault:false, // Prevent default action on keypress event\n\t\t\t\tcaptureEvents:false, // Get the events before any listeners deeper in the DOM\n\t\t\t\treactToKeydown:true, // look for scan input in keyboard events\n\t\t\t\treactToPaste:false, // look for scan input in paste events\n\t\t\t\tsingleScanQty: 1, // Quantity of Items put out to onScan in a single scan\n\t\t\t}\n\t\t\t\t\t\t\t\t\t\n\t\t\toOptions = this._mergeOptions(oDefaults, oOptions);\n\t\n\t\t\t// initializing options and variables on DomElement\n\t\t\toDomElement.scannerDetectionData = {\n\t\t\t\t\toptions: oOptions,\n\t\t\t\t\tvars:{\n\t\t\t\t\t\tfirstCharTime: 0,\n\t\t\t\t\t\tlastCharTime: 0,\n\t\t\t\t\t\taccumulatedString: '',\n\t\t\t\t\t\ttestTimer: false,\n\t\t\t\t\t\tlongPressTimeStart: 0,\n\t\t\t\t\t\tlongPressed: false\n\t\t\t\t\t}\n\t\t\t\t\n\t\t\t};\n\t\t\t\n\t\t\t// initializing handlers (based on settings)\n\t\t\tif (oOptions.reactToPaste === true){\n\t\t\t\toDomElement.addEventListener(\"paste\", this._handlePaste, oOptions.captureEvents);\n\t\t\t}\n\t\t\tif (oOptions.scanButtonKeyCode !== false){\n\t\t\t\toDomElement.addEventListener(\"keyup\", this._handleKeyUp, oOptions.captureEvents);\n\t\t\t}\n\t\t\tif (oOptions.reactToKeydown === true || oOptions.scanButtonKeyCode !== false){\t\n\t\t\t\toDomElement.addEventListener(\"keydown\", this._handleKeyDown, oOptions.captureEvents);\n\t\t\t}\n\t\t\treturn this;\n\t\t},\n\t\t\n\t\t/**\n\t\t * \n\t\t * @param DomElement oDomElement\n\t\t * @return void\n\t\t */\n\t\tdetachFrom: function(oDomElement) {\n\t\t\t// detaching all used events\n\t\t\tif (oDomElement.scannerDetectionData.options.reactToPaste){\n\t\t\t\toDomElement.removeEventListener(\"paste\", this._handlePaste);\n\t\t\t}\n\t\t\tif (oDomElement.scannerDetectionData.options.scanButtonKeyCode !== false){\n\t\t\t\toDomElement.removeEventListener(\"keyup\", this._handleKeyUp);\n\t\t\t}\n\t\t\toDomElement.removeEventListener(\"keydown\", this._handleKeyDown);\n\t\t\t\n\t\t\t// clearing data off DomElement\n\t\t\toDomElement.scannerDetectionData = undefined; \n\t\t\treturn;\n\t\t},\n\t\t\n\t\t/**\n\t\t * \n\t\t * @param DomElement oDomElement\n\t\t * @return Object\n\t\t */\n\t\tgetOptions: function(oDomElement){\n\t\t\treturn oDomElement.scannerDetectionData.options;\t\t\t\n\t\t},\n\t\n\t\t/**\n\t\t * \n\t\t * @param DomElement oDomElement\n\t\t * @param Object oOptions\n\t\t * @return self\n\t\t */\n\t\tsetOptions: function(oDomElement, oOptions){\n\t\t\t// check if some handlers need to be changed based on possible option changes\n\t\t\tswitch (oDomElement.scannerDetectionData.options.reactToPaste){\n\t\t\t\tcase true: \n\t\t\t\t\tif (oOptions.reactToPaste === false){\n\t\t\t\t\t\toDomElement.removeEventListener(\"paste\", this._handlePaste);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase false:\n\t\t\t\t\tif (oOptions.reactToPaste === true){\n\t\t\t\t\t\toDomElement.addEventListener(\"paste\", this._handlePaste);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\tswitch (oDomElement.scannerDetectionData.options.scanButtonKeyCode){\n\t\t\t\tcase false:\n\t\t\t\t\tif (oOptions.scanButtonKeyCode !== false){\n\t\t\t\t\t\toDomElement.addEventListener(\"keyup\", this._handleKeyUp);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault: \n\t\t\t\t\tif (oOptions.scanButtonKeyCode === false){\n\t\t\t\t\t\toDomElement.removeEventListener(\"keyup\", this._handleKeyUp);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\t// merge old and new options\n\t\t\toDomElement.scannerDetectionData.options = this._mergeOptions(oDomElement.scannerDetectionData.options, oOptions);\n\t\t\n\t\t\t// reinitiallize\n\t\t\tthis._reinitialize(oDomElement);\n\t\t\treturn this;\n\t\t},\n\t\t\n\t\t/**\n\t\t * Transforms key codes into characters.\n\t\t * \n\t\t * By default, only the follwing key codes are taken into account\n\t\t * - 48-90 (letters and regular numbers)\n\t\t * - 96-105 (numeric keypad numbers)\n\t\t * - 106-111 (numeric keypad operations)\n\t\t * \n\t\t * All other keys will yield empty strings!\n\t\t * \n\t\t * The above keycodes will be decoded using the KeyboardEvent.key property on modern\n\t\t * browsers. On older browsers the method will fall back to String.fromCharCode()\n\t\t * putting the result to upper/lower case depending on KeyboardEvent.shiftKey if\n\t\t * it is set.\n\t\t * \n\t\t * @param KeyboardEvent oEvent\n\t\t * @return string\n\t\t */\n\t\tdecodeKeyEvent : function (oEvent) {\n\t\t\tvar iCode = this._getNormalizedKeyNum(oEvent);\n\t\t\tswitch (true) {\n\t\t\t\tcase iCode >= 48 && iCode <= 90: // numbers and letters\n\t\t\t\tcase iCode >= 106 && iCode <= 111: // operations on numeric keypad (+, -, etc.)\n\t\t\t\t\tif (oEvent.key !== undefined && oEvent.key !== '') {\n\t\t\t\t\t\treturn oEvent.key;\n\t\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\tvar sDecoded = String.fromCharCode(iCode);\n\t\t\t\t\tswitch (oEvent.shiftKey) {\n\t\t\t\t\t\tcase false: sDecoded = sDecoded.toLowerCase(); break;\n\t\t\t\t\t\tcase true: sDecoded = sDecoded.toUpperCase(); break;\n\t\t\t\t\t}\n\t\t\t\t\treturn sDecoded;\n\t\t\t\tcase iCode >= 96 && iCode <= 105: // numbers on numeric keypad\n\t\t\t\t\treturn 0+(iCode-96);\n\t\t\t}\n\t\t\treturn '';\n\t\t},\n\t\t\n\t\t/**\n\t\t * Simulates a scan of the provided code.\n\t     *\n\t\t * The scan code can be defined as\n\t\t * - a string - in this case no keyCode decoding is done and the code is merely validated\n\t\t * against constraints like minLenght, etc.\n\t\t * - an array of keyCodes (e.g. `[70,71,80]`) - will produce `keydown` events with corresponding\n\t\t * `keyCode` properties. NOTE: these events will have empty `key` properties, so decoding may\n\t\t * yield different results than with native events.\n\t\t * - an array of objects (e.g. `[{keyCode: 70, key: \"F\", shiftKey: true}, {keyCode: 71, key: \"g\"}]`) -\n\t\t * this way almost any event can be simulated, but it's a lot of work to do.\n\t\t *\n\t\t * @param DomElement oDomElement\n\t\t * @param string|array mStringOrArray\n\t\t * @return self\n\t\t */\n\t\tsimulate: function(oDomElement, mStringOrArray){\n\t\t\tthis._reinitialize(oDomElement);\n\t\t\tif (Array.isArray(mStringOrArray)){\n\t\t\t\tmStringOrArray.forEach(function(mKey){\n\t\t\t\t\tvar oEventProps = {};\n\t\t\t\t\tif( (typeof mKey === \"object\" || typeof mKey === 'function') && (mKey !== null) ) {\n\t\t\t\t\t\toEventProps = mKey;\n\t\t\t\t\t} else {\n\t\t\t\t\t\toEventProps.keyCode = parseInt(mKey);\n\t\t\t\t\t}\n\t\t\t\t\tvar oEvent = new KeyboardEvent('keydown', oEventProps);\n\t\t\t\t\tdocument.dispatchEvent(oEvent);\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tthis._validateScanCode(oDomElement, mStringOrArray);\n\t\t\t}\n\t\t\treturn this;\n\t\t},\n\t\t\n\t\t/**\n\t\t * @private\n\t\t * @param DomElement oDomElement\n\t\t * @return void\n\t\t */\n\t\t_reinitialize: function(oDomElement){\n\t\t\tvar oVars = oDomElement.scannerDetectionData.vars;\n\t\t\toVars.firstCharTime = 0;\n\t\t\toVars.lastCharTime = 0;\n\t\t\toVars.accumulatedString = '';\n\t\t\treturn;\n\t\t},\n\t\t\n\t\t/**\n\t\t * @private\n\t\t * @param DomElement oDomElement\n\t     * @return boolean\n\t\t */\n\t\t_isFocusOnIgnoredElement: function(oDomElement){\n\t\t\t\n\t\t\tvar ignoreSelectors = oDomElement.scannerDetectionData.options.ignoreIfFocusOn;\n\t\n\t        if(!ignoreSelectors){\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\n\t\t\tvar oFocused = document.activeElement;\n\t\t\t\n\t\t\t// checks if ignored element is an array, and if so it checks if one of the elements of it is an active one\n\t\t\tif (Array.isArray(ignoreSelectors)){\n\t\t\t\tfor(var i=0; i<ignoreSelectors.length; i++){\n\t\t\t\t\tif(oFocused.matches(ignoreSelectors[i]) === true){\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t// if the option consists of an single element, it only checks this one\n\t\t\t} else if (oFocused.matches(ignoreSelectors)){\n\t\t\t\treturn true;\t\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t// if the active element is not listed in the ignoreIfFocusOn option, return false\n\t\t    return false;\n\t    },\n\t\t\n\t    /**\n\t     * Validates the scan code accumulated by the given DOM element and fires the respective events.\n\t     * \n\t     * @private\n\t     * @param DomElement oDomElement\n\t     * @return boolean\n\t     */\n\t\t_validateScanCode: function(oDomElement, sScanCode){\n\t\t\tvar oScannerData = oDomElement.scannerDetectionData;\t\t\t\n\t\t\tvar oOptions = oScannerData.options;\n\t\t\tvar iSingleScanQty = oScannerData.options.singleScanQty;\n\t\t\tvar iFirstCharTime = oScannerData.vars.firstCharTime;\n\t\t\tvar iLastCharTime = oScannerData.vars.lastCharTime;\n\t\t\tvar oScanError = {};\n\t        var oEvent;\n\t        \n\t\t\tswitch(true){\n\t\t\t\t\n\t\t\t\t// detect codes that are too short\n\t\t\t\tcase (sScanCode.length < oOptions.minLength):\n\t\t\t\t\toScanError = {\n\t\t\t\t\t\tmessage: \"Receieved code is shorter then minimal length\"\n\t\t\t\t\t};\n\t\t\t\t\tbreak;\n\t\t\t\t\t\n\t\t\t\t// detect codes that were entered too slow\t\n\t\t\t\tcase ((iLastCharTime - iFirstCharTime) > (sScanCode.length * oOptions.avgTimeByChar)):\n\t\t\t\t\toScanError = {\n\t\t\t\t\t\tmessage: \"Receieved code was not entered in time\"\n\t\t\t\t\t};\t\t\t\t\n\t\t\t\t\tbreak;\n\t\t\t\t\t\n\t\t\t\t// if a code was not filtered out earlier it is valid\t\n\t\t\t\tdefault:\n\t\t\t\t\toOptions.onScan.call(oDomElement, sScanCode, iSingleScanQty);\n\t\t\t\t\toEvent = new CustomEvent(\n\t\t\t\t\t\t'scan',\n\t\t\t\t\t\t{\t\n\t\t\t\t\t\t\tdetail: { \n\t\t\t\t\t\t\t\tscanCode: sScanCode,\n\t\t\t\t\t\t\t\tqty: iSingleScanQty\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t\toDomElement.dispatchEvent(oEvent);\n\t\t\t\t\tonScan._reinitialize(oDomElement);\n\t\t\t\t\treturn true;\n\t\t\t}\n\t\t\t\n\t\t\t// If an error occurred (otherwise the method would return earlier) create an object for errordetection\n\t\t\toScanError.scanCode = sScanCode;\n\t\t\toScanError.scanDuration = iLastCharTime - iFirstCharTime;\n\t\t\toScanError.avgTimeByChar = oOptions.avgTimeByChar;\n\t\t\toScanError.minLength = oOptions.minLength;\n\t\t\t\n\t\t\toOptions.onScanError.call(oDomElement, oScanError);\n\t\t\t\n\t\t\toEvent = new CustomEvent(\n\t\t\t\t'scanError', \n\t\t\t\t{detail: oScanError}\n\t\t\t);\n\t\t\toDomElement.dispatchEvent(oEvent);\n\t\t\t\n\t\t\tonScan._reinitialize(oDomElement);\n\t\t\treturn false;\n\t    },\n\t\n\t    /**\n\t     * @private\n\t     * @param Object oDefaults\n\t     * @param Object oOptions\n\t     * @return Object\n\t     */\n\t\t_mergeOptions: function(oDefaults, oOptions){\n\t\t\tvar oExtended = {};\n\t\t\tvar prop;\n\t\t\tfor (prop in oDefaults){\n\t\t\t\tif (Object.prototype.hasOwnProperty.call(oDefaults, prop)){\n\t\t\t\t\toExtended[prop] = oDefaults[prop];\n\t\t\t\t}\n\t\t\t}\t\t\t\n\t\t\tfor (prop in oOptions){\n\t\t\t\tif (Object.prototype.hasOwnProperty.call(oOptions, prop)){\n\t\t\t\t\toExtended[prop] = oOptions[prop];\n\t\t\t\t}\n\t\t\t}\t\t\t\n\t\t\treturn oExtended;\n\t\t},\n\t\n\t\t/**\n\t\t * @private\n\t\t * @param KeyboardEvent e\n\t\t * @return int\n\t\t * @see https://www.w3schools.com/jsref/event_key_keycode.asp\n\t\t */\n\t\t_getNormalizedKeyNum: function(e){\n\t\t\treturn e.which || e.keyCode;\n\t\t},\n\t\n\t\n\t\t/**\n\t\t * @private\n\t\t * @param KeyboardEvent e\n\t\t * @return void\n\t\t */\n\t\t_handleKeyDown: function(e){\n\t\t\tvar iKeyCode = onScan._getNormalizedKeyNum(e);\n\t\t\tvar oOptions = this.scannerDetectionData.options;\n\t\t\tvar oVars = this.scannerDetectionData.vars;\n\t\t\tvar bScanFinished = false;\n\t\t\t\n\t\t\tif (oOptions.onKeyDetect.call(this, iKeyCode, e) === false) {\n\t\t\t\treturn;\n\t\t\t}\t\t\n\t\t\t\n\t\t\tif (onScan._isFocusOnIgnoredElement(this)){\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\t\t\t\n\t        // If it's just the button of the scanner, ignore it and wait for the real input\n\t\t    if(oOptions.scanButtonKeyCode !== false && iKeyCode==oOptions.scanButtonKeyCode) {\n\t\t\t\t\n\t\t\t\t// if the button was first pressed, start a timeout for the callback, which gets interrupted if the scanbutton gets released\n\t\t\t\tif (!oVars.longPressed){\n\t\t\t\t\toVars.longPressTimer = setTimeout( oOptions.onScanButtonLongPress, oOptions.scanButtonLongPressTime, this);\n\t\t\t\t\toVars.longPressed = true;\n\t\t\t\t}\n\t\n\t\t\t\treturn;\n\t        }\n\t\t\t\n\t\t\tswitch(true){\n\t\t\t\t// If it's not the first character and we encounter a terminating character, trigger scan process\n\t\t\t\tcase (oVars.firstCharTime && oOptions.suffixKeyCodes.indexOf(iKeyCode)!==-1):\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopImmediatePropagation();\n\t\t\t\t\tbScanFinished=true;\n\t\t\t\t\tbreak;\n\t\t\t\t\t\n\t\t\t\t// If it's the first character and we encountered one of the starting characters, don't process the scan\t\n\t\t\t\tcase (!oVars.firstCharTime && oOptions.prefixKeyCodes.indexOf(iKeyCode)!==-1):\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopImmediatePropagation();\n\t\t\t\t\tbScanFinished=false;\n\t\t\t\t\tbreak;\n\t\t\t\t\t\n\t\t\t\t// Otherwise, just add the character to the scan string we're building\t\n\t\t\t\tdefault:\n\t\t\t\t\tvar character = oOptions.keyCodeMapper.call(this, e);\n\t\t\t\t\tif (character === null){\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\toVars.accumulatedString += character;\n\t\t\t\t\t\n\t\t\t\t\tif (oOptions.preventDefault) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t}\n\t\t\t\t\tif (oOptions.stopPropagation) {\n\t\t\t\t\t\te.stopImmediatePropagation();\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tbScanFinished=false;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t        \n\t\t\tif(!oVars.firstCharTime){\n\t\t\t\toVars.firstCharTime=Date.now();\n\t\t\t}\n\t\t\t\n\t\t\toVars.lastCharTime=Date.now();\n\t\n\t\t\tif(oVars.testTimer){ \n\t\t\t\tclearTimeout(oVars.testTimer);\n\t\t\t}\n\t\t\t\n\t\t\tif(bScanFinished){\n\t\t\t\tonScan._validateScanCode(this, oVars.accumulatedString);\n\t\t\t\toVars.testTimer=false;\n\t\t\t} else {\n\t\t\t\toVars.testTimer=setTimeout(onScan._validateScanCode, oOptions.timeBeforeScanTest, this, oVars.accumulatedString);\n\t\t\t}\n\t\n\t\t\toOptions.onKeyProcess.call(this, character, e);\n\t\t\treturn;\n\t\t},\n\t\t\n\t\t/**\n\t\t * @private\n\t\t * @param Event e\n\t\t * @return void\n\t\t */\n\t\t_handlePaste: function(e){\n\t\n\t\t\tvar oOptions = this.scannerDetectionData.options;\n\t\t\tvar oVars = this.scannerDetectionData.vars;\n\t\t\tvar sPasteString = (event.clipboardData || window.clipboardData).getData('text');\n\t\t\t\n\t\t\t// if the focus is on an ignored element, abort\n\t\t\tif (onScan._isFocusOnIgnoredElement(this)){\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\te.preventDefault();\n\n\t\t\tif (oOptions.stopPropagation) {\n\t\t\t\te.stopImmediatePropagation();\n\t\t\t}\n\t\t\t\t\t\t\n\t\t\toOptions.onPaste.call(this, sPasteString, event);\n\t\t\t\n\t\t\toVars.firstCharTime = 0;\n\t\t\toVars.lastCharTime = 0;\n\t\t\t\n\t\t\t// validate the string\n\t\t\tonScan._validateScanCode(this, sPasteString);\n\t\t\treturn;\n\t\t},\n\t\t\n\t\t/**\n\t\t * @private\n\t\t * @param KeyboardEvent e\n\t\t * @return void\n\t\t */\n\t\t_handleKeyUp: function(e){\n\t\t\t// if the focus is on an ignored element, abort\n\t\t\tif (onScan._isFocusOnIgnoredElement(this)){\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\tvar iKeyCode = onScan._getNormalizedKeyNum(e);\n\t\t\t\n\t\t\t// if hardware key is not being pressed anymore stop the timeout and reset\n\t\t\tif (iKeyCode == this.scannerDetectionData.options.scanButtonKeyCode){\n\t\t\t\tclearTimeout(this.scannerDetectionData.vars.longPressTimer);\n\t\t\t\tthis.scannerDetectionData.vars.longPressed = false;\n\t\t\t}\n\t\t\treturn;\n\t\t},\n\t\t\n\t\t/**\n\t\t * Returns TRUE the scanner is currently in the middle of a scan sequence.\n\t\t * \n\t\t * @param DomElement\n\t\t * @return boolean\n\t\t */\n\t\tisScanInProgressFor: function(oDomElement) {\n\t\t\treturn oDomElement.scannerDetectionData.vars.firstCharTime > 0;\n\t\t},\n\t\t\n\t\t/**\n\t\t * Returns TRUE if onScan is attached to the given DOM element and FALSE otherwise.\n\t\t * \n\t\t * @param DomElement\n\t\t * @return boolean\n\t\t */\n\t\tisAttachedTo: function(oDomElement) {\n\t\t\treturn (oDomElement.scannerDetectionData !== undefined);\n\t\t}\n\t};\n\t\n\treturn onScan;\n})));","import onScan from 'onscan.js';\n\nerpnext.PointOfSale.ItemSelector = class {\n\t// eslint-disable-next-line no-unused-vars\n\tconstructor({ frm, wrapper, events, pos_profile, settings }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\t\tthis.pos_profile = pos_profile;\n\t\tthis.hide_images = settings.hide_images;\n\t\tthis.auto_add_item = settings.auto_add_item_to_cart;\n\n\t\tthis.inti_component();\n\t}\n\n\tinti_component() {\n\t\tthis.prepare_dom();\n\t\tthis.make_search_bar();\n\t\tthis.load_items_data();\n\t\tthis.bind_events();\n\t\tthis.attach_shortcuts();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"items-selector\">\n\t\t\t\t<div class=\"filter-section\">\n\t\t\t\t\t<div class=\"label\">All Items</div>\n\t\t\t\t\t<div class=\"search-field\"></div>\n\t\t\t\t\t<div class=\"item-group-field\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"items-container\"></div>\n\t\t\t</section>`\n\t\t);\n\n\t\tthis.$component = this.wrapper.find('.items-selector');\n\t\tthis.$items_container = this.$component.find('.items-container');\n\t}\n\n\tasync load_items_data() {\n\t\tif (!this.item_group) {\n\t\t\tconst res = await frappe.db.get_value(\"Item Group\", {lft: 1, is_group: 1}, \"name\");\n\t\t\tthis.parent_item_group = res.message.name;\n\t\t}\n\t\tif (!this.price_list) {\n\t\t\tconst res = await frappe.db.get_value(\"POS Profile\", this.pos_profile, \"selling_price_list\");\n\t\t\tthis.price_list = res.message.selling_price_list;\n\t\t}\n\n\t\tthis.get_items({}).then(({message}) => {\n\t\t\tthis.render_item_list(message.items);\n\t\t});\n\t}\n\n\tget_items({start = 0, page_length = 40, search_term=''}) {\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst price_list = (doc && doc.selling_price_list) || this.price_list;\n\t\tlet { item_group, pos_profile } = this;\n\n\t\t!item_group && (item_group = this.parent_item_group);\n\n\t\treturn frappe.call({\n\t\t\tmethod: \"erpnext.selling.page.point_of_sale.point_of_sale.get_items\",\n\t\t\tfreeze: true,\n\t\t\targs: { start, page_length, price_list, item_group, search_term, pos_profile },\n\t\t});\n\t}\n\n\n\trender_item_list(items) {\n\t\tthis.$items_container.html('');\n\n\t\titems.forEach(item => {\n\t\t\tconst item_html = this.get_item_html(item);\n\t\t\tthis.$items_container.append(item_html);\n\t\t});\n\t}\n\n\tget_item_html(item) {\n\t\tconst me = this;\n\t\t// eslint-disable-next-line no-unused-vars\n\t\tconst { item_image, serial_no, batch_no, barcode, actual_qty, stock_uom, price_list_rate } = item;\n\t\tconst indicator_color = actual_qty > 10 ? \"green\" : actual_qty <= 0 ? \"red\" : \"orange\";\n\t\tconst precision = flt(price_list_rate, 2) % 1 != 0 ? 2 : 0;\n\n\t\tlet qty_to_display = actual_qty;\n\n\t\tif (Math.round(qty_to_display) > 999) {\n\t\t\tqty_to_display = Math.round(qty_to_display)/1000;\n\t\t\tqty_to_display = qty_to_display.toFixed(1) + 'K';\n\t\t}\n\n\t\tfunction get_item_image_html() {\n\t\t\tif (!me.hide_images && item_image) {\n\t\t\t\treturn `<div class=\"item-qty-pill\">\n\t\t\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color}\">${qty_to_display}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"flex items-center justify-center h-32 border-b-grey text-6xl text-grey-100\">\n\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\tonerror=\"cur_pos.item_selector.handle_broken_image(this)\"\n\t\t\t\t\t\t\t\tclass=\"h-full\" src=\"${item_image}\"\n\t\t\t\t\t\t\t\talt=\"${frappe.get_abbr(item.item_name)}\"\n\t\t\t\t\t\t\t\tstyle=\"object-fit: cover;\">\n\t\t\t\t\t\t</div>`;\n\t\t\t} else {\n\t\t\t\treturn `<div class=\"item-qty-pill\">\n\t\t\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color}\">${qty_to_display}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"item-display abbr\">${frappe.get_abbr(item.item_name)}</div>`;\n\t\t\t}\n\t\t}\n\n\t\treturn (\n\t\t\t`<div class=\"item-wrapper\"\n\t\t\t\tdata-item-code=\"${escape(item.item_code)}\" data-serial-no=\"${escape(serial_no)}\"\n\t\t\t\tdata-batch-no=\"${escape(batch_no)}\" data-uom=\"${escape(stock_uom)}\"\n\t\t\t\tdata-rate=\"${escape(price_list_rate)}\"\n\t\t\t\ttitle=\"${item.item_name}\">\n\n\t\t\t\t${get_item_image_html()}\n\n\t\t\t\t<div class=\"item-detail\">\n\t\t\t\t\t<div class=\"item-name\">\n\t\t\t\t\t\t${frappe.ellipsis(item.item_name, 18)}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"item-rate\">${format_currency(price_list_rate, item.currency, precision) || 0}</div>\n\t\t\t\t</div>\n\t\t\t</div>`\n\t\t);\n\t}\n\n\thandle_broken_image($img) {\n\t\tconst item_abbr = $($img).attr('alt');\n\t\t$($img).parent().replaceWith(`<div class=\"item-display abbr\">${item_abbr}</div>`);\n\t}\n\n\tmake_search_bar() {\n\t\tconst me = this;\n\t\tconst doc = me.events.get_frm().doc;\n\t\tthis.$component.find('.search-field').html('');\n\t\tthis.$component.find('.item-group-field').html('');\n\n\t\tthis.search_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Search'),\n\t\t\t\tfieldtype: 'Data',\n\t\t\t\tplaceholder: __('Search by item code, serial number or barcode')\n\t\t\t},\n\t\t\tparent: this.$component.find('.search-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.item_group_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Item Group'),\n\t\t\t\tfieldtype: 'Link',\n\t\t\t\toptions: 'Item Group',\n\t\t\t\tplaceholder: __('Select item group'),\n\t\t\t\tonchange: function() {\n\t\t\t\t\tme.item_group = this.value;\n\t\t\t\t\t!me.item_group && (me.item_group = me.parent_item_group);\n\t\t\t\t\tme.filter_items();\n\t\t\t\t},\n\t\t\t\tget_query: function () {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tquery: 'erpnext.selling.page.point_of_sale.point_of_sale.item_group_query',\n\t\t\t\t\t\tfilters: {\n\t\t\t\t\t\t\tpos_profile: doc ? doc.pos_profile : ''\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t},\n\t\t\tparent: this.$component.find('.item-group-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.search_field.toggle_label(false);\n\t\tthis.item_group_field.toggle_label(false);\n\t}\n\n\tset_search_value(value) {\n\t\t$(this.search_field.$input[0]).val(value).trigger(\"input\");\n\t}\n\n\tbind_events() {\n\t\tconst me = this;\n\t\twindow.onScan = onScan;\n\n\t\tonScan.decodeKeyEvent = function (oEvent) {\n\t\t\tvar iCode = this._getNormalizedKeyNum(oEvent);\n\t\t\tswitch (true) {\n\t\t\t\tcase iCode >= 48 && iCode <= 90: // numbers and letters\n\t\t\t\tcase iCode >= 106 && iCode <= 111: // operations on numeric keypad (+, -, etc.)\n\t\t\t\tcase (iCode >= 160 && iCode <= 164) || iCode == 170: // ^ ! # $ *\n\t\t\t\tcase iCode >= 186 && iCode <= 194: // (; = , - . / `)\n\t\t\t\tcase iCode >= 219 && iCode <= 222: // ([ \\ ] ')\n\t\t\t\tcase iCode == 32: // spacebar\n\t\t\t\t\tif (oEvent.key !== undefined && oEvent.key !== '') {\n\t\t\t\t\t\treturn oEvent.key;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar sDecoded = String.fromCharCode(iCode);\n\t\t\t\t\tswitch (oEvent.shiftKey) {\n\t\t\t\t\t\tcase false: sDecoded = sDecoded.toLowerCase(); break;\n\t\t\t\t\t\tcase true: sDecoded = sDecoded.toUpperCase(); break;\n\t\t\t\t\t}\n\t\t\t\t\treturn sDecoded;\n\t\t\t\tcase iCode >= 96 && iCode <= 105: // numbers on numeric keypad\n\t\t\t\t\treturn 0 + (iCode - 96);\n\t\t\t}\n\t\t\treturn '';\n\t\t};\n\n\t\tonScan.attachTo(document, {\n\t\t\tonScan: (sScancode) => {\n\t\t\t\tif (this.search_field && this.$component.is(':visible')) {\n\t\t\t\t\tthis.search_field.set_focus();\n\t\t\t\t\tthis.set_search_value(sScancode);\n\t\t\t\t\tthis.barcode_scanned = true;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.$component.on('click', '.item-wrapper', function() {\n\t\t\tconst $item = $(this);\n\t\t\tconst item_code = unescape($item.attr('data-item-code'));\n\t\t\tlet batch_no = unescape($item.attr('data-batch-no'));\n\t\t\tlet serial_no = unescape($item.attr('data-serial-no'));\n\t\t\tlet uom = unescape($item.attr('data-uom'));\n\t\t\tlet rate = unescape($item.attr('data-rate'));\n\n\t\t\t// escape(undefined) returns \"undefined\" then unescape returns \"undefined\"\n\t\t\tbatch_no = batch_no === \"undefined\" ? undefined : batch_no;\n\t\t\tserial_no = serial_no === \"undefined\" ? undefined : serial_no;\n\t\t\tuom = uom === \"undefined\" ? undefined : uom;\n\t\t\trate = rate === \"undefined\" ? undefined : rate;\n\n\t\t\tme.events.item_selected({\n\t\t\t\tfield: 'qty',\n\t\t\t\tvalue: \"+1\",\n\t\t\t\titem: { item_code, batch_no, serial_no, uom, rate }\n\t\t\t});\n\t\t\tme.set_search_value('');\n\t\t});\n\n\t\tthis.search_field.$input.on('input', (e) => {\n\t\t\tclearTimeout(this.last_search);\n\t\t\tthis.last_search = setTimeout(() => {\n\t\t\t\tconst search_term = e.target.value;\n\t\t\t\tthis.filter_items({ search_term });\n\t\t\t}, 300);\n\t\t});\n\t}\n\n\tattach_shortcuts() {\n\t\tconst ctrl_label = frappe.utils.is_mac() ? '⌘' : 'Ctrl';\n\t\tthis.search_field.parent.attr(\"title\", `${ctrl_label}+I`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+i\",\n\t\t\taction: () => this.search_field.set_focus(),\n\t\t\tcondition: () => this.$component.is(':visible'),\n\t\t\tdescription: __(\"Focus on search input\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t\tthis.item_group_field.parent.attr(\"title\", `${ctrl_label}+G`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+g\",\n\t\t\taction: () => this.item_group_field.set_focus(),\n\t\t\tcondition: () => this.$component.is(':visible'),\n\t\t\tdescription: __(\"Focus on Item Group filter\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\n\t\t// for selecting the last filtered item on search\n\t\tfrappe.ui.keys.on(\"enter\", () => {\n\t\t\tconst selector_is_visible = this.$component.is(':visible');\n\t\t\tif (!selector_is_visible || this.search_field.get_value() === \"\") return;\n\n\t\t\tif (this.items.length == 1) {\n\t\t\t\tthis.$items_container.find(\".item-wrapper\").click();\n\t\t\t\tfrappe.utils.play_sound(\"submit\");\n\t\t\t\t$(this.search_field.$input[0]).val(\"\").trigger(\"input\");\n\t\t\t} else if (this.items.length == 0 && this.barcode_scanned) {\n\t\t\t\t// only show alert of barcode is scanned and enter is pressed\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: __(\"No items found. Scan barcode again.\"),\n\t\t\t\t\tindicator: 'orange'\n\t\t\t\t});\n\t\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\t\tthis.barcode_scanned = false;\n\t\t\t\t$(this.search_field.$input[0]).val(\"\").trigger(\"input\");\n\t\t\t}\n\t\t});\n\t}\n\n\tfilter_items({ search_term='' }={}) {\n\t\tif (search_term) {\n\t\t\tsearch_term = search_term.toLowerCase();\n\n\t\t\t// memoize\n\t\t\tthis.search_index = this.search_index || {};\n\t\t\tif (this.search_index[search_term]) {\n\t\t\t\tconst items = this.search_index[search_term];\n\t\t\t\tthis.items = items;\n\t\t\t\tthis.render_item_list(items);\n\t\t\t\tthis.auto_add_item && this.items.length == 1 && this.add_filtered_item_to_cart();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.get_items({ search_term })\n\t\t\t.then(({ message }) => {\n\t\t\t\t// eslint-disable-next-line no-unused-vars\n\t\t\t\tconst { items, serial_no, batch_no, barcode } = message;\n\t\t\t\tif (search_term && !barcode) {\n\t\t\t\t\tthis.search_index[search_term] = items;\n\t\t\t\t}\n\t\t\t\tthis.items = items;\n\t\t\t\tthis.render_item_list(items);\n\t\t\t\tthis.auto_add_item && this.items.length == 1 && this.add_filtered_item_to_cart();\n\t\t\t});\n\t}\n\n\tadd_filtered_item_to_cart() {\n\t\tthis.$items_container.find(\".item-wrapper\").click();\n\t}\n\n\tresize_selector(minimize) {\n\t\tminimize ?\n\t\t\tthis.$component.find('.filter-section').css('grid-template-columns', 'repeat(1, minmax(0, 1fr))') :\n\t\t\tthis.$component.find('.filter-section').css('grid-template-columns', 'repeat(12, minmax(0, 1fr))');\n\n\t\tminimize ?\n\t\t\tthis.$component.find('.search-field').css('margin', 'var(--margin-sm) 0px') :\n\t\t\tthis.$component.find('.search-field').css('margin', '0px var(--margin-sm)');\n\n\t\tminimize ?\n\t\t\tthis.$component.css('grid-column', 'span 2 / span 2') :\n\t\t\tthis.$component.css('grid-column', 'span 6 / span 6');\n\n\t\tminimize ?\n\t\t\tthis.$items_container.css('grid-template-columns', 'repeat(1, minmax(0, 1fr))') :\n\t\t\tthis.$items_container.css('grid-template-columns', 'repeat(4, minmax(0, 1fr))');\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\n\t}\n};\n","erpnext.PointOfSale.ItemCart = class {\n\tconstructor({ wrapper, events, settings }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\t\tthis.customer_info = undefined;\n\t\tthis.hide_images = settings.hide_images;\n\t\tthis.allowed_customer_groups = settings.customer_groups;\n\t\tthis.allow_rate_change = settings.allow_rate_change;\n\t\tthis.allow_discount_change = settings.allow_discount_change;\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.init_child_components();\n\t\tthis.bind_events();\n\t\tthis.attach_shortcuts();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"customer-cart-container\"></section>`\n\t\t)\n\n\t\tthis.$component = this.wrapper.find('.customer-cart-container');\n\t}\n\n\tinit_child_components() {\n\t\tthis.init_customer_selector();\n\t\tthis.init_cart_components();\n\t}\n\n\tinit_customer_selector() {\n\t\tthis.$component.append(\n\t\t\t`<div class=\"customer-section\"></div>`\n\t\t)\n\t\tthis.$customer_section = this.$component.find('.customer-section');\n\t\tthis.make_customer_selector();\n\t}\n\n\treset_customer_selector() {\n\t\tconst frm = this.events.get_frm();\n\t\tfrm.set_value('customer', '');\n\t\tthis.make_customer_selector();\n\t\tthis.customer_field.set_focus();\n\t}\n\n\tinit_cart_components() {\n\t\tthis.$component.append(\n\t\t\t`<div class=\"cart-container\">\n\t\t\t\t<div class=\"abs-cart-container\">\n\t\t\t\t\t<div class=\"cart-label\">Item Cart</div>\n\t\t\t\t\t<div class=\"cart-header\">\n\t\t\t\t\t\t<div class=\"name-header\">Item</div>\n\t\t\t\t\t\t<div class=\"qty-header\">Qty</div>\n\t\t\t\t\t\t<div class=\"rate-amount-header\">Amount</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"cart-items-section\"></div>\n\t\t\t\t\t<div class=\"cart-totals-section\"></div>\n\t\t\t\t\t<div class=\"numpad-section\"></div>\n\t\t\t\t</div>\n\t\t\t</div>`\n\t\t);\n\t\tthis.$cart_container = this.$component.find('.cart-container');\n\n\t\tthis.make_cart_totals_section();\n\t\tthis.make_cart_items_section();\n\t\tthis.make_cart_numpad();\n\t}\n\n\tmake_cart_items_section() {\n\t\tthis.$cart_header = this.$component.find('.cart-header');\n\t\tthis.$cart_items_wrapper = this.$component.find('.cart-items-section');\n\n\t\tthis.make_no_items_placeholder();\n\t}\n\n\tmake_no_items_placeholder() {\n\t\tthis.$cart_header.css('display', 'none');\n\t\tthis.$cart_items_wrapper.html(\n\t\t\t`<div class=\"no-item-wrapper\">No items in cart</div>`\n\t\t);\n\t}\n\n\tget_discount_icon() {\n\t\treturn (\n\t\t\t`<svg class=\"discount-icon\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n\t\t\t\t<path d=\"M19 15.6213C19 15.2235 19.158 14.842 19.4393 14.5607L20.9393 13.0607C21.5251 12.4749 21.5251 11.5251 20.9393 10.9393L19.4393 9.43934C19.158 9.15804 19 8.7765 19 8.37868V6.5C19 5.67157 18.3284 5 17.5 5H15.6213C15.2235 5 14.842 4.84196 14.5607 4.56066L13.0607 3.06066C12.4749 2.47487 11.5251 2.47487 10.9393 3.06066L9.43934 4.56066C9.15804 4.84196 8.7765 5 8.37868 5H6.5C5.67157 5 5 5.67157 5 6.5V8.37868C5 8.7765 4.84196 9.15804 4.56066 9.43934L3.06066 10.9393C2.47487 11.5251 2.47487 12.4749 3.06066 13.0607L4.56066 14.5607C4.84196 14.842 5 15.2235 5 15.6213V17.5C5 18.3284 5.67157 19 6.5 19H8.37868C8.7765 19 9.15804 19.158 9.43934 19.4393L10.9393 20.9393C11.5251 21.5251 12.4749 21.5251 13.0607 20.9393L14.5607 19.4393C14.842 19.158 15.2235 19 15.6213 19H17.5C18.3284 19 19 18.3284 19 17.5V15.6213Z\" stroke-miterlimit=\"10\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t\t<path d=\"M15 9L9 15\" stroke-miterlimit=\"10\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t\t<path d=\"M10.5 9.5C10.5 10.0523 10.0523 10.5 9.5 10.5C8.94772 10.5 8.5 10.0523 8.5 9.5C8.5 8.94772 8.94772 8.5 9.5 8.5C10.0523 8.5 10.5 8.94772 10.5 9.5Z\" fill=\"white\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t\t<path d=\"M15.5 14.5C15.5 15.0523 15.0523 15.5 14.5 15.5C13.9477 15.5 13.5 15.0523 13.5 14.5C13.5 13.9477 13.9477 13.5 14.5 13.5C15.0523 13.5 15.5 13.9477 15.5 14.5Z\" fill=\"white\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t</svg>`\n\t\t);\n\t}\n\n\tmake_cart_totals_section() {\n\t\tthis.$totals_section = this.$component.find('.cart-totals-section');\n\n\t\tthis.$totals_section.append(\n\t\t\t`<div class=\"add-discount-wrapper\">\n\t\t\t\t${this.get_discount_icon()} Add Discount\n\t\t\t</div>\n\t\t\t<div class=\"net-total-container\">\n\t\t\t\t<div class=\"net-total-label\">Net Total</div>\n\t\t\t\t<div class=\"net-total-value\">0.00</div>\n\t\t\t</div>\n\t\t\t<div class=\"taxes-container\"></div>\n\t\t\t<div class=\"grand-total-container\">\n\t\t\t\t<div>Grand Total</div>\n\t\t\t\t<div>0.00</div>\n\t\t\t</div>\n\t\t\t<div class=\"checkout-btn\">Checkout</div>\n\t\t\t<div class=\"edit-cart-btn\">Edit Cart</div>`\n\t\t)\n\n\t\tthis.$add_discount_elem = this.$component.find(\".add-discount-wrapper\");\n\t}\n\n\tmake_cart_numpad() {\n\t\tthis.$numpad_section = this.$component.find('.numpad-section');\n\n\t\tthis.number_pad = new erpnext.PointOfSale.NumberPad({\n\t\t\twrapper: this.$numpad_section,\n\t\t\tevents: {\n\t\t\t\tnumpad_event: this.on_numpad_event.bind(this)\n\t\t\t},\n\t\t\tcols: 5,\n\t\t\tkeys: [\n\t\t\t\t[ 1, 2, 3, 'Quantity' ],\n\t\t\t\t[ 4, 5, 6, 'Discount' ],\n\t\t\t\t[ 7, 8, 9, 'Rate' ],\n\t\t\t\t[ '.', 0, 'Delete', 'Remove' ]\n\t\t\t],\n\t\t\tcss_classes: [\n\t\t\t\t[ '', '', '', 'col-span-2' ],\n\t\t\t\t[ '', '', '', 'col-span-2' ],\n\t\t\t\t[ '', '', '', 'col-span-2' ],\n\t\t\t\t[ '', '', '', 'col-span-2 remove-btn' ]\n\t\t\t],\n\t\t\tfieldnames_map: { 'Quantity': 'qty', 'Discount': 'discount_percentage' }\n\t\t})\n\n\t\tthis.$numpad_section.prepend(\n\t\t\t`<div class=\"numpad-totals\">\n\t\t\t\t<span class=\"numpad-net-total\"></span>\n\t\t\t\t<span class=\"numpad-grand-total\"></span>\n\t\t\t</div>`\n\t\t)\n\n\t\tthis.$numpad_section.append(\n\t\t\t`<div class=\"numpad-btn checkout-btn\" data-button-value=\"checkout\">Checkout</div>`\n\t\t)\n\t}\n\n\tbind_events() {\n\t\tconst me = this;\n\t\tthis.$customer_section.on('click', '.reset-customer-btn', function () {\n\t\t\tme.reset_customer_selector();\n\t\t});\n\n\t\tthis.$customer_section.on('click', '.close-details-btn', function () {\n\t\t\tme.toggle_customer_info(false);\n\t\t});\n\n\t\tthis.$customer_section.on('click', '.customer-display', function(e) {\n\t\t\tif ($(e.target).closest('.reset-customer-btn').length) return;\n\n\t\t\tconst show = me.$cart_container.is(':visible');\n\t\t\tme.toggle_customer_info(show);\n\t\t});\n\n\t\tthis.$cart_items_wrapper.on('click', '.cart-item-wrapper', function() {\n\t\t\tconst $cart_item = $(this);\n\n\t\t\tme.toggle_item_highlight(this);\n\n\t\t\tconst payment_section_hidden = !me.$totals_section.find('.edit-cart-btn').is(':visible');\n\t\t\tif (!payment_section_hidden) {\n\t\t\t\t// payment section is visible\n\t\t\t\t// edit cart first and then open item details section\n\t\t\t\tme.$totals_section.find(\".edit-cart-btn\").click();\n\t\t\t}\n\n\t\t\tconst item_row_name = unescape($cart_item.attr('data-row-name'));\n\t\t\tme.events.cart_item_clicked({ name: item_row_name });\n\t\t\tthis.numpad_value = '';\n\t\t});\n\n\t\tthis.$component.on('click', '.checkout-btn', function() {\n\t\t\tif ($(this).attr('style').indexOf('--blue-500') == -1) return;\n\n\t\t\tme.events.checkout();\n\t\t\tme.toggle_checkout_btn(false);\n\n\t\t\tme.allow_discount_change && me.$add_discount_elem.removeClass(\"d-none\");\n\t\t});\n\n\t\tthis.$totals_section.on('click', '.edit-cart-btn', () => {\n\t\t\tthis.events.edit_cart();\n\t\t\tthis.toggle_checkout_btn(true);\n\t\t});\n\n\t\tthis.$component.on('click', '.add-discount-wrapper', () => {\n\t\t\tconst can_edit_discount = this.$add_discount_elem.find('.edit-discount-btn').length;\n\n\t\t\tif(!this.discount_field || can_edit_discount) this.show_discount_control();\n\t\t});\n\n\t\tfrappe.ui.form.on(\"POS Invoice\", \"paid_amount\", frm => {\n\t\t\t// called when discount is applied\n\t\t\tthis.update_totals_section(frm);\n\t\t});\n\t}\n\n\tattach_shortcuts() {\n\t\tfor (let row of this.number_pad.keys) {\n\t\t\tfor (let btn of row) {\n\t\t\t\tif (typeof btn !== 'string') continue; // do not make shortcuts for numbers\n\n\t\t\t\tlet shortcut_key = `ctrl+${frappe.scrub(String(btn))[0]}`;\n\t\t\t\tif (btn === 'Delete') shortcut_key = 'ctrl+backspace';\n\t\t\t\tif (btn === 'Remove') shortcut_key = 'shift+ctrl+backspace'\n\t\t\t\tif (btn === '.') shortcut_key = 'ctrl+>';\n\n\t\t\t\t// to account for fieldname map\n\t\t\t\tconst fieldname = this.number_pad.fieldnames[btn] ? this.number_pad.fieldnames[btn] :\n\t\t\t\t\ttypeof btn === 'string' ? frappe.scrub(btn) : btn;\n\n\t\t\t\tlet shortcut_label = shortcut_key.split('+').map(frappe.utils.to_title_case).join('+');\n\t\t\t\tshortcut_label = frappe.utils.is_mac() ? shortcut_label.replace('Ctrl', '⌘') : shortcut_label;\n\t\t\t\tthis.$numpad_section.find(`.numpad-btn[data-button-value=\"${fieldname}\"]`).attr(\"title\", shortcut_label);\n\n\t\t\t\tfrappe.ui.keys.on(`${shortcut_key}`, () => {\n\t\t\t\t\tconst cart_is_visible = this.$component.is(\":visible\");\n\t\t\t\t\tif (cart_is_visible && this.item_is_selected && this.$numpad_section.is(\":visible\")) {\n\t\t\t\t\t\tthis.$numpad_section.find(`.numpad-btn[data-button-value=\"${fieldname}\"]`).click();\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\tconst ctrl_label = frappe.utils.is_mac() ? '⌘' : 'Ctrl';\n\t\tthis.$component.find(\".checkout-btn\").attr(\"title\", `${ctrl_label}+Enter`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+enter\",\n\t\t\taction: () => this.$component.find(\".checkout-btn\").click(),\n\t\t\tcondition: () => this.$component.is(\":visible\") && !this.$totals_section.find('.edit-cart-btn').is(':visible'),\n\t\t\tdescription: __(\"Checkout Order / Submit Order / New Order\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t\tthis.$component.find(\".edit-cart-btn\").attr(\"title\", `${ctrl_label}+E`);\n\t\tfrappe.ui.keys.on(\"ctrl+e\", () => {\n\t\t\tconst item_cart_visible = this.$component.is(\":visible\");\n\t\t\tconst checkout_btn_invisible = !this.$totals_section.find('.checkout-btn').is('visible');\n\t\t\tif (item_cart_visible && checkout_btn_invisible) {\n\t\t\t\tthis.$component.find(\".edit-cart-btn\").click();\n\t\t\t}\n\t\t});\n\t\tthis.$component.find(\".add-discount-wrapper\").attr(\"title\", `${ctrl_label}+D`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+d\",\n\t\t\taction: () => this.$component.find(\".add-discount-wrapper\").click(),\n\t\t\tcondition: () => this.$add_discount_elem.is(\":visible\"),\n\t\t\tdescription: __(\"Add Order Discount\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t\tfrappe.ui.keys.on(\"escape\", () => {\n\t\t\tconst item_cart_visible = this.$component.is(\":visible\");\n\t\t\tif (item_cart_visible && this.discount_field && this.discount_field.parent.is(\":visible\")) {\n\t\t\t\tthis.discount_field.set_value(0);\n\t\t\t}\n\t\t});\n\t}\n\n\ttoggle_item_highlight(item) {\n\t\tconst $cart_item = $(item);\n\t\tconst item_is_highlighted = $cart_item.attr(\"style\") == \"background-color:var(--gray-50);\";\n\n\t\tif (!item || item_is_highlighted) {\n\t\t\tthis.item_is_selected = false;\n\t\t\tthis.$cart_container.find('.cart-item-wrapper').css(\"background-color\", \"\");\n\t\t} else {\n\t\t\t$cart_item.css(\"background-color\", \"var(--gray-50)\");\n\t\t\tthis.item_is_selected = true;\n\t\t\tthis.$cart_container.find('.cart-item-wrapper').not(item).css(\"background-color\", \"\");\n\t\t}\n\t}\n\n\tmake_customer_selector() {\n\t\tthis.$customer_section.html(`\n\t\t\t<div class=\"customer-field\"></div>\n\t\t`);\n\t\tconst me = this;\n\t\tconst query = { query: 'erpnext.controllers.queries.customer_query' };\n\t\tconst allowed_customer_group = this.allowed_customer_groups || [];\n\t\tif (allowed_customer_group.length) {\n\t\t\tquery.filters = {\n\t\t\t\tcustomer_group: ['in', allowed_customer_group]\n\t\t\t}\n\t\t}\n\t\tthis.customer_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Customer'),\n\t\t\t\tfieldtype: 'Link',\n\t\t\t\toptions: 'Customer',\n\t\t\t\tplaceholder: __('Search by customer name, phone, email.'),\n\t\t\t\tget_query: () => query,\n\t\t\t\tonchange: function() {\n\t\t\t\t\tif (this.value) {\n\t\t\t\t\t\tconst frm = me.events.get_frm();\n\t\t\t\t\t\tfrappe.dom.freeze();\n\t\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'customer', this.value);\n\t\t\t\t\t\tfrm.script_manager.trigger('customer', frm.doc.doctype, frm.doc.name).then(() => {\n\t\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t\t() => me.fetch_customer_details(this.value),\n\t\t\t\t\t\t\t\t() => me.events.customer_details_updated(me.customer_info),\n\t\t\t\t\t\t\t\t() => me.update_customer_section(),\n\t\t\t\t\t\t\t\t() => me.update_totals_section(),\n\t\t\t\t\t\t\t\t() => frappe.dom.unfreeze()\n\t\t\t\t\t\t\t]);\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\tparent: this.$customer_section.find('.customer-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.customer_field.toggle_label(false);\n\t}\n\n\tfetch_customer_details(customer) {\n\t\tif (customer) {\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tfrappe.db.get_value('Customer', customer, [\"email_id\", \"mobile_no\", \"image\", \"loyalty_program\"]).then(({ message }) => {\n\t\t\t\t\tconst { loyalty_program } = message;\n\t\t\t\t\t// if loyalty program then fetch loyalty points too\n\t\t\t\t\tif (loyalty_program) {\n\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\tmethod: \"erpnext.accounts.doctype.loyalty_program.loyalty_program.get_loyalty_program_details_with_points\",\n\t\t\t\t\t\t\targs: { customer, loyalty_program, \"silent\": true },\n\t\t\t\t\t\t\tcallback: (r) => {\n\t\t\t\t\t\t\t\tconst { loyalty_points, conversion_factor } = r.message;\n\t\t\t\t\t\t\t\tif (!r.exc) {\n\t\t\t\t\t\t\t\t\tthis.customer_info = { ...message, customer, loyalty_points, conversion_factor };\n\t\t\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.customer_info = { ...message, customer };\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t} else {\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tthis.customer_info = {}\n\t\t\t\tresolve();\n\t\t\t});\n\t\t}\n\t}\n\n\tshow_discount_control() {\n\t\tthis.$add_discount_elem.css({ 'padding': '0px', 'border': 'none' });\n\t\tthis.$add_discount_elem.html(\n\t\t\t`<div class=\"add-discount-field\"></div>`\n\t\t);\n\t\tconst me = this;\n\t\tconst frm = me.events.get_frm();\n\t\tlet discount = frm.doc.additional_discount_percentage;\n\n\t\tthis.discount_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Discount'),\n\t\t\t\tfieldtype: 'Data',\n\t\t\t\tplaceholder: ( discount ? discount + '%' :  __('Enter discount percentage.') ),\n\t\t\t\tinput_class: 'input-xs',\n\t\t\t\tonchange: function() {\n\t\t\t\t\tif (flt(this.value) != 0) {\n\t\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'additional_discount_percentage', flt(this.value));\n\t\t\t\t\t\tme.hide_discount_control(this.value);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'additional_discount_percentage', 0);\n\t\t\t\t\t\tme.$add_discount_elem.css({\n\t\t\t\t\t\t\t'border': '1px dashed var(--gray-500)',\n\t\t\t\t\t\t\t'padding': 'var(--padding-sm) var(--padding-md)'\n\t\t\t\t\t\t});\n\t\t\t\t\t\tme.$add_discount_elem.html(`${me.get_discount_icon()} Add Discount`);\n\t\t\t\t\t\tme.discount_field = undefined;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\tparent: this.$add_discount_elem.find('.add-discount-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.discount_field.toggle_label(false);\n\t\tthis.discount_field.set_focus();\n\t}\n\n\thide_discount_control(discount) {\n\t\tif (!discount) {\n\t\t\tthis.$add_discount_elem.css({ 'padding': '0px', 'border': 'none' });\n\t\t\tthis.$add_discount_elem.html(\n\t\t\t\t`<div class=\"add-discount-field\"></div>`\n\t\t\t);\n\t\t} else {\n\t\t\tthis.$add_discount_elem.css({\n\t\t\t\t'border': '1px dashed var(--dark-green-500)',\n\t\t\t\t'padding': 'var(--padding-sm) var(--padding-md)'\n\t\t\t});\n\t\t\tthis.$add_discount_elem.html(\n\t\t\t\t`<div class=\"edit-discount-btn\">\n\t\t\t\t\t${this.get_discount_icon()} Additional&nbsp;${String(discount).bold()}% discount applied\n\t\t\t\t</div>`\n\t\t\t);\n\t\t}\n\t}\n\n\tupdate_customer_section() {\n\t\tconst me = this;\n\t\tconst { customer, email_id='', mobile_no='', image } = this.customer_info || {};\n\n\t\tif (customer) {\n\t\t\tthis.$customer_section.html(\n\t\t\t\t`<div class=\"customer-details\">\n\t\t\t\t\t<div class=\"customer-display\">\n\t\t\t\t\t\t${this.get_customer_image()}\n\t\t\t\t\t\t<div class=\"customer-name-desc\">\n\t\t\t\t\t\t\t<div class=\"customer-name\">${customer}</div>\n\t\t\t\t\t\t\t${get_customer_description()}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"reset-customer-btn\" data-customer=\"${escape(customer)}\">\n\t\t\t\t\t\t\t<svg width=\"32\" height=\"32\" viewBox=\"0 0 14 14\" fill=\"none\">\n\t\t\t\t\t\t\t\t<path d=\"M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759\" stroke=\"#8D99A6\"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>`\n\t\t\t);\n\t\t} else {\n\t\t\t// reset customer selector\n\t\t\tthis.reset_customer_selector();\n\t\t}\n\n\t\tfunction get_customer_description() {\n\t\t\tif (!email_id && !mobile_no) {\n\t\t\t\treturn `<div class=\"customer-desc\">Click to add email / phone</div>`;\n\t\t\t} else if (email_id && !mobile_no) {\n\t\t\t\treturn `<div class=\"customer-desc\">${email_id}</div>`;\n\t\t\t} else if (mobile_no && !email_id) {\n\t\t\t\treturn `<div class=\"customer-desc\">${mobile_no}</div>`;\n\t\t\t} else {\n\t\t\t\treturn `<div class=\"customer-desc\">${email_id} - ${mobile_no}</div>`;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tget_customer_image() {\n\t\tconst { customer, image } = this.customer_info || {};\n\t\tif (image) {\n\t\t\treturn `<div class=\"customer-image\"><img src=\"${image}\" alt=\"${image}\"\"></div>`;\n\t\t} else {\n\t\t\treturn `<div class=\"customer-image customer-abbr\">${frappe.get_abbr(customer)}</div>`;\n\t\t}\n\t}\n\n\tupdate_totals_section(frm) {\n\t\tif (!frm) frm = this.events.get_frm();\n\n\t\tthis.render_net_total(frm.doc.net_total);\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? frm.doc.grand_total : frm.doc.rounded_total;\n\t\tthis.render_grand_total(grand_total);\n\n\t\tthis.render_taxes(frm.doc.taxes);\n\t}\n\n\trender_net_total(value) {\n\t\tconst currency = this.events.get_frm().doc.currency;\n\t\tthis.$totals_section.find('.net-total-container').html(\n\t\t\t`<div>Net Total</div><div>${format_currency(value, currency)}</div>`\n\t\t)\n\n\t\tthis.$numpad_section.find('.numpad-net-total').html(\n\t\t\t`<div>Net Total: <span>${format_currency(value, currency)}</span></div>`\n\t\t);\n\t}\n\n\trender_grand_total(value) {\n\t\tconst currency = this.events.get_frm().doc.currency;\n\t\tthis.$totals_section.find('.grand-total-container').html(\n\t\t\t`<div>Grand Total</div><div>${format_currency(value, currency)}</div>`\n\t\t)\n\n\t\tthis.$numpad_section.find('.numpad-grand-total').html(\n\t\t\t`<div>Grand Total: <span>${format_currency(value, currency)}</span></div>`\n\t\t);\n\t}\n\n\trender_taxes(taxes) {\n\t\tif (taxes.length) {\n\t\t\tconst currency = this.events.get_frm().doc.currency;\n\t\t\tconst taxes_html = taxes.map(t => {\n\t\t\t\tconst description = /[0-9]+/.test(t.description) ? t.description : `${t.description} @ ${t.rate}%`;\n\t\t\t\treturn `<div class=\"tax-row\">\n\t\t\t\t\t<div class=\"tax-label\">${description}</div>\n\t\t\t\t\t<div class=\"tax-value\">${format_currency(t.tax_amount_after_discount_amount, currency)}</div>\n\t\t\t\t</div>`;\n\t\t\t}).join('');\n\t\t\tthis.$totals_section.find('.taxes-container').css('display', 'flex').html(taxes_html);\n\t\t} else {\n\t\t\tthis.$totals_section.find('.taxes-container').css('display', 'none').html('');\n\t\t}\n\t}\n\n\tget_cart_item({ name }) {\n\t\tconst item_selector = `.cart-item-wrapper[data-row-name=\"${escape(name)}\"]`;\n\t\treturn this.$cart_items_wrapper.find(item_selector);\n\t}\n\n\tget_item_from_frm(item) {\n\t\tconst doc = this.events.get_frm().doc;\n\t\treturn doc.items.find(i => i.name == item.name);\n\t}\n\n\tupdate_item_html(item, remove_item) {\n\t\tconst $item = this.get_cart_item(item);\n\n\t\tif (remove_item) {\n\t\t\t$item && $item.next().remove() && $item.remove();\n\t\t} else {\n\t\t\tconst item_row = this.get_item_from_frm(item);\n\t\t\tthis.render_cart_item(item_row, $item);\n\t\t}\n\n\t\tconst no_of_cart_items = this.$cart_items_wrapper.find('.cart-item-wrapper').length;\n\t\tthis.highlight_checkout_btn(no_of_cart_items > 0);\n\n\t\tthis.update_empty_cart_section(no_of_cart_items);\n\t}\n\n\trender_cart_item(item_data, $item_to_update) {\n\t\tconst currency = this.events.get_frm().doc.currency;\n\t\tconst me = this;\n\n\t\tif (!$item_to_update.length) {\n\t\t\tthis.$cart_items_wrapper.append(\n\t\t\t\t`<div class=\"cart-item-wrapper\" data-row-name=\"${escape(item_data.name)}\"></div>\n\t\t\t\t<div class=\"seperator\"></div>`\n\t\t\t)\n\t\t\t$item_to_update = this.get_cart_item(item_data);\n\t\t}\n\n\t\t$item_to_update.html(\n\t\t\t`${get_item_image_html()}\n\t\t\t<div class=\"item-name-desc\">\n\t\t\t\t<div class=\"item-name\">\n\t\t\t\t\t${item_data.item_name}\n\t\t\t\t</div>\n\t\t\t\t${get_description_html()}\n\t\t\t</div>\n\t\t\t${get_rate_discount_html()}`\n\t\t)\n\n\t\tset_dynamic_rate_header_width();\n\n\t\tfunction set_dynamic_rate_header_width() {\n\t\t\tconst rate_cols = Array.from(me.$cart_items_wrapper.find(\".item-rate-amount\"));\n\t\t\tme.$cart_header.find(\".rate-amount-header\").css(\"width\", \"\");\n\t\t\tme.$cart_items_wrapper.find(\".item-rate-amount\").css(\"width\", \"\");\n\t\t\tlet max_width = rate_cols.reduce((max_width, elm) => {\n\t\t\t\tif ($(elm).width() > max_width)\n\t\t\t\t\tmax_width = $(elm).width();\n\t\t\t\treturn max_width;\n\t\t\t}, 0);\n\n\t\t\tmax_width += 1;\n\t\t\tif (max_width == 1) max_width = \"\";\n\n\t\t\tme.$cart_header.find(\".rate-amount-header\").css(\"width\", max_width);\n\t\t\tme.$cart_items_wrapper.find(\".item-rate-amount\").css(\"width\", max_width);\n\t\t}\n\n\t\tfunction get_rate_discount_html() {\n\t\t\tif (item_data.rate && item_data.amount && item_data.rate !== item_data.amount) {\n\t\t\t\treturn `\n\t\t\t\t\t<div class=\"item-qty-rate\">\n\t\t\t\t\t\t<div class=\"item-qty\"><span>${item_data.qty || 0}</span></div>\n\t\t\t\t\t\t<div class=\"item-rate-amount\">\n\t\t\t\t\t\t\t<div class=\"item-rate\">${format_currency(item_data.amount, currency)}</div>\n\t\t\t\t\t\t\t<div class=\"item-amount\">${format_currency(item_data.rate, currency)}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>`\n\t\t\t} else {\n\t\t\t\treturn `\n\t\t\t\t\t<div class=\"item-qty-rate\">\n\t\t\t\t\t\t<div class=\"item-qty\"><span>${item_data.qty || 0}</span></div>\n\t\t\t\t\t\t<div class=\"item-rate-amount\">\n\t\t\t\t\t\t\t<div class=\"item-rate\">${format_currency(item_data.rate, currency)}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>`\n\t\t\t}\n\t\t}\n\n\t\tfunction get_description_html() {\n\t\t\tif (item_data.description) {\n\t\t\t\tif (item_data.description.indexOf('<div>') != -1) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\titem_data.description = $(item_data.description).text();\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\titem_data.description = item_data.description.replace(/<div>/g, ' ').replace(/<\\/div>/g, ' ').replace(/ +/g, ' ');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\titem_data.description = frappe.ellipsis(item_data.description, 45);\n\t\t\t\treturn `<div class=\"item-desc\">${item_data.description}</div>`;\n\t\t\t}\n\t\t\treturn ``;\n\t\t}\n\n\t\tfunction get_item_image_html() {\n\t\t\tconst { image, item_name } = item_data;\n\t\t\tif (!me.hide_images && image) {\n\t\t\t\treturn `\n\t\t\t\t\t<div class=\"item-image\">\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tonerror=\"cur_pos.cart.handle_broken_image(this)\"\n\t\t\t\t\t\t\tsrc=\"${image}\" alt=\"${frappe.get_abbr(item_name)}\"\">\n\t\t\t\t\t</div>`;\n\t\t\t} else {\n\t\t\t\treturn `<div class=\"item-image item-abbr\">${frappe.get_abbr(item_name)}</div>`;\n\t\t\t}\n\t\t}\n\t}\n\n\thandle_broken_image($img) {\n\t\tconst item_abbr = $($img).attr('alt');\n\t\t$($img).parent().replaceWith(`<div class=\"item-image item-abbr\">${item_abbr}</div>`);\n\t}\n\n\tupdate_selector_value_in_cart_item(selector, value, item) {\n\t\tconst $item_to_update = this.get_cart_item(item);\n\t\t$item_to_update.attr(`data-${selector}`, escape(value));\n\t}\n\n\ttoggle_checkout_btn(show_checkout) {\n\t\tif (show_checkout) {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'flex');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'none');\n\t\t} else {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'none');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'flex');\n\t\t}\n\t}\n\n\thighlight_checkout_btn(toggle) {\n\t\tif (toggle) {\n\t\t\tthis.$add_discount_elem.css('display', 'flex');\n\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t'background-color': 'var(--blue-500)'\n\t\t\t});\n\t\t} else {\n\t\t\tthis.$add_discount_elem.css('display', 'none');\n\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t'background-color': 'var(--blue-200)'\n\t\t\t});\n\t\t}\n\t}\n\n\tupdate_empty_cart_section(no_of_cart_items) {\n\t\tconst $no_item_element = this.$cart_items_wrapper.find('.no-item-wrapper');\n\n\t\t// if cart has items and no item is present\n\t\tno_of_cart_items > 0 && $no_item_element && $no_item_element.remove() && this.$cart_header.css('display', 'flex');\n\n\t\tno_of_cart_items === 0 && !$no_item_element.length && this.make_no_items_placeholder();\n\t}\n\n\ton_numpad_event($btn) {\n\t\tconst current_action = $btn.attr('data-button-value');\n\t\tconst action_is_field_edit = ['qty', 'discount_percentage', 'rate'].includes(current_action);\n\t\tconst action_is_allowed = action_is_field_edit ? (\n\t\t\t(current_action == 'rate' && this.allow_rate_change) ||\n\t\t\t(current_action == 'discount_percentage' && this.allow_discount_change) ||\n\t\t\t(current_action == 'qty')) : true;\n\n\t\tconst action_is_pressed_twice = this.prev_action === current_action;\n\t\tconst first_click_event = !this.prev_action;\n\t\tconst field_to_edit_changed = this.prev_action && this.prev_action != current_action;\n\n\t\tif (action_is_field_edit) {\n\t\t\tif (!action_is_allowed) {\n\t\t\t\tconst label = current_action == 'rate' ? 'Rate'.bold() : 'Discount'.bold();\n\t\t\t\tconst message = __('Editing {0} is not allowed as per POS Profile settings', [label]);\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tindicator: 'red',\n\t\t\t\t\tmessage: message\n\t\t\t\t});\n\t\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (first_click_event || field_to_edit_changed) {\n\t\t\t\tthis.prev_action = current_action;\n\t\t\t} else if (action_is_pressed_twice) {\n\t\t\t\tthis.prev_action = undefined;\n\t\t\t}\n\t\t\tthis.numpad_value = '';\n\n\t\t} else if (current_action === 'checkout') {\n\t\t\tthis.prev_action = undefined;\n\t\t\tthis.toggle_item_highlight();\n\t\t\tthis.events.numpad_event(undefined, current_action);\n\t\t\treturn;\n\t\t} else if (current_action === 'remove') {\n\t\t\tthis.prev_action = undefined;\n\t\t\tthis.toggle_item_highlight();\n\t\t\tthis.events.numpad_event(undefined, current_action);\n\t\t\treturn;\n\t\t} else {\n\t\t\tthis.numpad_value = current_action === 'delete' ? this.numpad_value.slice(0, -1) : this.numpad_value + current_action;\n\t\t\tthis.numpad_value = this.numpad_value || 0;\n\t\t}\n\n\t\tconst first_click_event_is_not_field_edit = !action_is_field_edit && first_click_event;\n\n\t\tif (first_click_event_is_not_field_edit) {\n\t\t\tfrappe.show_alert({\n\t\t\t\tindicator: 'red',\n\t\t\t\tmessage: __('Please select a field to edit from numpad')\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\treturn;\n\t\t}\n\n\t\tif (flt(this.numpad_value) > 100 && this.prev_action === 'discount_percentage') {\n\t\t\tfrappe.show_alert({\n\t\t\t\tmessage: __('Discount cannot be greater than 100%'),\n\t\t\t\tindicator: 'orange'\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\tthis.numpad_value = current_action;\n\t\t}\n\n\t\tthis.highlight_numpad_btn($btn, current_action);\n\t\tthis.events.numpad_event(this.numpad_value, this.prev_action);\n\t}\n\n\thighlight_numpad_btn($btn, curr_action) {\n\t\tconst curr_action_is_highlighted = $btn.hasClass('highlighted-numpad-btn');\n\t\tconst curr_action_is_action = ['qty', 'discount_percentage', 'rate', 'done'].includes(curr_action);\n\n\t\tif (!curr_action_is_highlighted) {\n\t\t\t$btn.addClass('highlighted-numpad-btn');\n\t\t}\n\t\tif (this.prev_action === curr_action && curr_action_is_highlighted) {\n\t\t\t// if Qty is pressed twice\n\t\t\t$btn.removeClass('highlighted-numpad-btn');\n\t\t}\n\t\tif (this.prev_action && this.prev_action !== curr_action && curr_action_is_action) {\n\t\t\t// Order: Qty -> Rate then remove Qty highlight\n\t\t\tconst prev_btn = $(`[data-button-value='${this.prev_action}']`);\n\t\t\tprev_btn.removeClass('highlighted-numpad-btn');\n\t\t}\n\t\tif (!curr_action_is_action || curr_action === 'done') {\n\t\t\t// if numbers are clicked\n\t\t\tsetTimeout(() => {\n\t\t\t\t$btn.removeClass('highlighted-numpad-btn');\n\t\t\t}, 200);\n\t\t}\n\t}\n\n\ttoggle_numpad(show) {\n\t\tif (show) {\n\t\t\tthis.$totals_section.css('display', 'none');\n\t\t\tthis.$numpad_section.css('display', 'flex');\n\t\t} else {\n\t\t\tthis.$totals_section.css('display', 'flex');\n\t\t\tthis.$numpad_section.css('display', 'none');\n\t\t}\n\t\tthis.reset_numpad();\n\t}\n\n\treset_numpad() {\n\t\tthis.numpad_value = '';\n\t\tthis.prev_action = undefined;\n\t\tthis.$numpad_section.find('.highlighted-numpad-btn').removeClass('highlighted-numpad-btn');\n\t}\n\n\ttoggle_numpad_field_edit(fieldname) {\n\t\tif (['qty', 'discount_percentage', 'rate'].includes(fieldname)) {\n\t\t\tthis.$numpad_section.find(`[data-button-value=\"${fieldname}\"]`).click();\n\t\t}\n\t}\n\n\ttoggle_customer_info(show) {\n\t\tif (show) {\n\t\t\tconst { customer } = this.customer_info || {};\n\n\t\t\tthis.$cart_container.css('display', 'none');\n\t\t\tthis.$customer_section.css({\n\t\t\t\t'height': '100%',\n\t\t\t\t'padding-top': '0px'\n\t\t\t});\n\t\t\tthis.$customer_section.find('.customer-details').html(\n\t\t\t\t`<div class=\"header\">\n\t\t\t\t\t<div class=\"label\">Contact Details</div>\n\t\t\t\t\t<div class=\"close-details-btn\">\n\t\t\t\t\t\t<svg width=\"32\" height=\"32\" viewBox=\"0 0 14 14\" fill=\"none\">\n\t\t\t\t\t\t\t<path d=\"M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759\" stroke=\"#8D99A6\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"customer-display\">\n\t\t\t\t\t${this.get_customer_image()}\n\t\t\t\t\t<div class=\"customer-name-desc\">\n\t\t\t\t\t\t<div class=\"customer-name\">${customer}</div>\n\t\t\t\t\t\t<div class=\"customer-desc\"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"customer-fields-container\">\n\t\t\t\t\t<div class=\"email_id-field\"></div>\n\t\t\t\t\t<div class=\"mobile_no-field\"></div>\n\t\t\t\t\t<div class=\"loyalty_program-field\"></div>\n\t\t\t\t\t<div class=\"loyalty_points-field\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"transactions-label\">Recent Transactions</div>`\n\t\t\t);\n\t\t\t// transactions need to be in diff div from sticky elem for scrolling\n\t\t\tthis.$customer_section.append(`<div class=\"customer-transactions\"></div>`);\n\n\t\t\tthis.render_customer_fields();\n\t\t\tthis.fetch_customer_transactions();\n\n\t\t} else {\n\t\t\tthis.$cart_container.css('display', 'flex');\n\t\t\tthis.$customer_section.css({\n\t\t\t\t'height': '',\n\t\t\t\t'padding-top': ''\n\t\t\t});\n\n\t\t\tthis.update_customer_section();\n\t\t}\n\t}\n\n\trender_customer_fields() {\n\t\tconst $customer_form = this.$customer_section.find('.customer-fields-container');\n\n\t\tconst dfs = [{\n\t\t\tfieldname: 'email_id',\n\t\t\tlabel: __('Email'),\n\t\t\tfieldtype: 'Data',\n\t\t\toptions: 'email',\n\t\t\tplaceholder: __(\"Enter customer's email\")\n\t\t},{\n\t\t\tfieldname: 'mobile_no',\n\t\t\tlabel: __('Phone Number'),\n\t\t\tfieldtype: 'Data',\n\t\t\tplaceholder: __(\"Enter customer's phone number\")\n\t\t},{\n\t\t\tfieldname: 'loyalty_program',\n\t\t\tlabel: __('Loyalty Program'),\n\t\t\tfieldtype: 'Link',\n\t\t\toptions: 'Loyalty Program',\n\t\t\tplaceholder: __(\"Select Loyalty Program\")\n\t\t},{\n\t\t\tfieldname: 'loyalty_points',\n\t\t\tlabel: __('Loyalty Points'),\n\t\t\tfieldtype: 'Data',\n\t\t\tread_only: 1\n\t\t}];\n\n\t\tconst me = this;\n\t\tdfs.forEach(df => {\n\t\t\tthis[`customer_${df.fieldname}_field`] = frappe.ui.form.make_control({\n\t\t\t\tdf: { ...df,\n\t\t\t\t\tonchange: handle_customer_field_change,\n\t\t\t\t},\n\t\t\t\tparent: $customer_form.find(`.${df.fieldname}-field`),\n\t\t\t\trender_input: true,\n\t\t\t});\n\t\t\tthis[`customer_${df.fieldname}_field`].set_value(this.customer_info[df.fieldname]);\n\t\t})\n\n\t\tfunction handle_customer_field_change() {\n\t\t\tconst current_value = me.customer_info[this.df.fieldname];\n\t\t\tconst current_customer = me.customer_info.customer;\n\n\t\t\tif (this.value && current_value != this.value && this.df.fieldname != 'loyalty_points') {\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: 'erpnext.selling.page.point_of_sale.point_of_sale.set_customer_info',\n\t\t\t\t\targs: {\n\t\t\t\t\t\tfieldname: this.df.fieldname,\n\t\t\t\t\t\tcustomer: current_customer,\n\t\t\t\t\t\tvalue: this.value\n\t\t\t\t\t},\n\t\t\t\t\tcallback: (r) => {\n\t\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\t\tme.customer_info[this.df.fieldname] = this.value;\n\t\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\t\tmessage: __(\"Customer contact updated successfully.\"),\n\t\t\t\t\t\t\t\tindicator: 'green'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tfrappe.utils.play_sound(\"submit\");\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tfetch_customer_transactions() {\n\t\tfrappe.db.get_list('POS Invoice', {\n\t\t\tfilters: { customer: this.customer_info.customer, docstatus: 1 },\n\t\t\tfields: ['name', 'grand_total', 'status', 'posting_date', 'posting_time', 'currency'],\n\t\t\tlimit: 20\n\t\t}).then((res) => {\n\t\t\tconst transaction_container = this.$customer_section.find('.customer-transactions');\n\n\t\t\tif (!res.length) {\n\t\t\t\ttransaction_container.html(\n\t\t\t\t\t`<div class=\"no-transactions-placeholder\">No recent transactions found</div>`\n\t\t\t\t)\n\t\t\t\treturn;\n\t\t\t};\n\n\t\t\tconst elapsed_time = moment(res[0].posting_date+\" \"+res[0].posting_time).fromNow();\n\t\t\tthis.$customer_section.find('.customer-desc').html(`Last transacted ${elapsed_time}`);\n\n\t\t\tres.forEach(invoice => {\n\t\t\t\tconst posting_datetime = moment(invoice.posting_date+\" \"+invoice.posting_time).format(\"Do MMMM, h:mma\");\n\t\t\t\tlet indicator_color = {\n\t\t\t\t\t'Paid': 'green',\n\t\t\t\t\t'Draft': 'red',\n\t\t\t\t\t'Return': 'gray',\n\t\t\t\t\t'Consolidated': 'blue'\n\t\t\t\t};\n\n\t\t\t\ttransaction_container.append(\n\t\t\t\t\t`<div class=\"invoice-wrapper\" data-invoice-name=\"${escape(invoice.name)}\">\n\t\t\t\t\t\t<div class=\"invoice-name-date\">\n\t\t\t\t\t\t\t<div class=\"invoice-name\">${invoice.name}</div>\n\t\t\t\t\t\t\t<div class=\"invoice-date\">${posting_datetime}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"invoice-total-status\">\n\t\t\t\t\t\t\t<div class=\"invoice-total\">\n\t\t\t\t\t\t\t\t${format_currency(invoice.grand_total, invoice.currency, 0) || 0}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"invoice-status\">\n\t\t\t\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color[invoice.status]}\">\n\t\t\t\t\t\t\t\t\t<span>${invoice.status}</span>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"seperator\"></div>`\n\t\t\t\t)\n\t\t\t});\n\t\t});\n\t}\n\n\tattach_refresh_field_event(frm) {\n\t\t$(frm.wrapper).off('refresh-fields');\n\t\t$(frm.wrapper).on('refresh-fields', () => {\n\t\t\tif (frm.doc.items.length) {\n\t\t\t\tfrm.doc.items.forEach(item => {\n\t\t\t\t\tthis.update_item_html(item);\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.update_totals_section(frm);\n\t\t});\n\t}\n\n\tload_invoice() {\n\t\tconst frm = this.events.get_frm();\n\n\t\tthis.attach_refresh_field_event(frm);\n\n\t\tthis.fetch_customer_details(frm.doc.customer).then(() => {\n\t\t\tthis.events.customer_details_updated(this.customer_info);\n\t\t\tthis.update_customer_section();\n\t\t});\n\n\t\tthis.$cart_items_wrapper.html('');\n\t\tif (frm.doc.items.length) {\n\t\t\tfrm.doc.items.forEach(item => {\n\t\t\t\tthis.update_item_html(item);\n\t\t\t});\n\t\t} else {\n\t\t\tthis.make_no_items_placeholder();\n\t\t\tthis.highlight_checkout_btn(false);\n\t\t}\n\n\t\tthis.update_totals_section(frm);\n\n\t\tif(frm.doc.docstatus === 1) {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'none');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'none');\n\t\t} else {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'flex');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'none');\n\t\t}\n\n\t\tthis.toggle_component(true);\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\n\t}\n\n}\n","erpnext.PointOfSale.ItemDetails = class {\n\tconstructor({ wrapper, events, settings }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\t\tthis.hide_images = settings.hide_images;\n\t\tthis.allow_rate_change = settings.allow_rate_change;\n\t\tthis.allow_discount_change = settings.allow_discount_change;\n\t\tthis.current_item = {};\n\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.init_child_components();\n\t\tthis.bind_events();\n\t\tthis.attach_shortcuts();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"item-details-container\"></section>`\n\t\t)\n\n\t\tthis.$component = this.wrapper.find('.item-details-container');\n\t}\n\n\tinit_child_components() {\n\t\tthis.$component.html(\n\t\t\t`<div class=\"item-details-header\">\n\t\t\t\t<div class=\"label\">Item Details</div>\n\t\t\t\t<div class=\"close-btn\">\n\t\t\t\t\t<svg width=\"32\" height=\"32\" viewBox=\"0 0 14 14\" fill=\"none\">\n\t\t\t\t\t\t<path d=\"M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759\" stroke=\"#8D99A6\"/>\n\t\t\t\t\t</svg>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"item-display\">\n\t\t\t\t<div class=\"item-name-desc-price\">\n\t\t\t\t\t<div class=\"item-name\"></div>\n\t\t\t\t\t<div class=\"item-desc\"></div>\n\t\t\t\t\t<div class=\"item-price\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"item-image\"></div>\n\t\t\t</div>\n\t\t\t<div class=\"discount-section\"></div>\n\t\t\t<div class=\"form-container\"></div>`\n\t\t)\n\n\t\tthis.$item_name = this.$component.find('.item-name');\n\t\tthis.$item_description = this.$component.find('.item-desc');\n\t\tthis.$item_price = this.$component.find('.item-price');\n\t\tthis.$item_image = this.$component.find('.item-image');\n\t\tthis.$form_container = this.$component.find('.form-container');\n\t\tthis.$dicount_section = this.$component.find('.discount-section');\n\t}\n\n\tcompare_with_current_item(item) {\n\t\t// returns true if `item` is currently being edited\n\t\treturn item && item.name == this.current_item.name;\n\t}\n\n\ttoggle_item_details_section(item) {\n\t\tconst current_item_changed = !this.compare_with_current_item(item);\n\n\t\t// if item is null or highlighted cart item is clicked twice\n\t\tconst hide_item_details = !Boolean(item) || !current_item_changed;\n\n\t\tthis.events.toggle_item_selector(!hide_item_details);\n\t\tthis.toggle_component(!hide_item_details);\n\n\t\tif (item && current_item_changed) {\n\t\t\tthis.doctype = item.doctype;\n\t\t\tthis.item_meta = frappe.get_meta(this.doctype);\n\t\t\tthis.name = item.name;\n\t\t\tthis.item_row = item;\n\t\t\tthis.currency = this.events.get_frm().doc.currency;\n\n\t\t\tthis.current_item = item;\n\n\t\t\tthis.render_dom(item);\n\t\t\tthis.render_discount_dom(item);\n\t\t\tthis.render_form(item);\n\t\t\tthis.events.highlight_cart_item(item);\n\t\t} else {\n\t\t\tthis.validate_serial_batch_item();\n\t\t\tthis.current_item = {};\n\t\t}\n\t}\n\n\tvalidate_serial_batch_item() {\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst item_row = doc.items.find(item => item.name === this.name);\n\n\t\tif (!item_row) return;\n\n\t\tconst serialized = item_row.has_serial_no;\n\t\tconst batched = item_row.has_batch_no;\n\t\tconst no_serial_selected = !item_row.serial_no;\n\t\tconst no_batch_selected = !item_row.batch_no;\n\n\t\tif ((serialized && no_serial_selected) || (batched && no_batch_selected) ||\n\t\t\t(serialized && batched && (no_batch_selected || no_serial_selected))) {\n\n\t\t\tfrappe.show_alert({\n\t\t\t\tmessage: __(\"Item will be removed since no serial / batch no selected.\"),\n\t\t\t\tindicator: 'orange'\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"cancel\");\n\t\t\tthis.events.remove_item_from_cart();\n\t\t}\n\t}\n\n\trender_dom(item) {\n\t\tlet { item_name, description, image, price_list_rate } = item;\n\n\t\tfunction get_description_html() {\n\t\t\tif (description) {\n\t\t\t\tdescription = description.indexOf('...') === -1 && description.length > 140 ? description.substr(0, 139) + '...' : description;\n\t\t\t\treturn description;\n\t\t\t}\n\t\t\treturn ``;\n\t\t}\n\n\t\tthis.$item_name.html(item_name);\n\t\tthis.$item_description.html(get_description_html());\n\t\tthis.$item_price.html(format_currency(price_list_rate, this.currency));\n\t\tif (!this.hide_images && image) {\n\t\t\tthis.$item_image.html(\n\t\t\t\t`<img\n\t\t\t\t\tonerror=\"cur_pos.item_details.handle_broken_image(this)\"\n\t\t\t\t\tclass=\"h-full\" src=\"${image}\"\n\t\t\t\t\talt=\"${frappe.get_abbr(item_name)}\"\n\t\t\t\t\tstyle=\"object-fit: cover;\">`\n\t\t\t);\n\t\t} else {\n\t\t\tthis.$item_image.html(`<div class=\"item-abbr\">${frappe.get_abbr(item_name)}</div>`);\n\t\t}\n\n\t}\n\n\thandle_broken_image($img) {\n\t\tconst item_abbr = $($img).attr('alt');\n\t\t$($img).replaceWith(`<div class=\"item-abbr\">${item_abbr}</div>`);\n\t}\n\n\trender_discount_dom(item) {\n\t\tif (item.discount_percentage) {\n\t\t\tthis.$dicount_section.html(\n\t\t\t\t`<div class=\"item-rate\">${format_currency(item.price_list_rate, this.currency)}</div>\n\t\t\t\t<div class=\"item-discount\">${item.discount_percentage}% off</div>`\n\t\t\t)\n\t\t\tthis.$item_price.html(format_currency(item.rate, this.currency));\n\t\t} else {\n\t\t\tthis.$dicount_section.html(``)\n\t\t}\n\t}\n\n\trender_form(item) {\n\t\tconst fields_to_display = this.get_form_fields(item);\n\t\tthis.$form_container.html('');\n\n\t\tfields_to_display.forEach((fieldname, idx) => {\n\t\t\tthis.$form_container.append(\n\t\t\t\t`<div class=\"${fieldname}-control\" data-fieldname=\"${fieldname}\"></div>`\n\t\t\t)\n\n\t\t\tconst field_meta = this.item_meta.fields.find(df => df.fieldname === fieldname);\n\t\t\tfieldname === 'discount_percentage' ? (field_meta.label = __('Discount (%)')) : '';\n\t\t\tconst me = this;\n\n\t\t\tthis[`${fieldname}_control`] = frappe.ui.form.make_control({\n\t\t\t\tdf: {\n\t\t\t\t\t...field_meta,\n\t\t\t\t\tonchange: function() {\n\t\t\t\t\t\tme.events.form_updated(me.current_item, fieldname, this.value);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tparent: this.$form_container.find(`.${fieldname}-control`),\n\t\t\t\trender_input: true,\n\t\t\t})\n\t\t\tthis[`${fieldname}_control`].set_value(item[fieldname]);\n\t\t});\n\n\t\tthis.make_auto_serial_selection_btn(item);\n\n\t\tthis.bind_custom_control_change_event();\n\t}\n\n\tget_form_fields(item) {\n\t\tconst fields = ['qty', 'uom', 'rate', 'conversion_factor', 'discount_percentage', 'warehouse', 'actual_qty', 'price_list_rate'];\n\t\tif (item.has_serial_no) fields.push('serial_no');\n\t\tif (item.has_batch_no) fields.push('batch_no');\n\t\treturn fields;\n\t}\n\n\tmake_auto_serial_selection_btn(item) {\n\t\tif (item.has_serial_no) {\n\t\t\tif (!item.has_batch_no) {\n\t\t\t\tthis.$form_container.append(\n\t\t\t\t\t`<div class=\"grid-filler no-select\"></div>`\n\t\t\t\t);\n\t\t\t}\n\t\t\tthis.$form_container.append(\n\t\t\t\t`<div class=\"btn btn-sm btn-secondary auto-fetch-btn\">Auto Fetch Serial Numbers</div>`\n\t\t\t);\n\t\t\tthis.$form_container.find('.serial_no-control').find('textarea').css('height', '6rem');\n\t\t}\n\t}\n\n\tbind_custom_control_change_event() {\n\t\tconst me = this;\n\t\tif (this.rate_control) {\n\t\t\tthis.rate_control.df.onchange = function() {\n\t\t\t\tif (this.value || flt(this.value) === 0) {\n\t\t\t\t\tme.events.form_updated(me.current_item, 'rate', this.value).then(() => {\n\t\t\t\t\t\tconst item_row = frappe.get_doc(me.doctype, me.name);\n\t\t\t\t\t\tconst doc = me.events.get_frm().doc;\n\t\t\t\t\t\tme.$item_price.html(format_currency(item_row.rate, doc.currency));\n\t\t\t\t\t\tme.render_discount_dom(item_row);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.rate_control.df.read_only = !this.allow_rate_change;\n\t\t\tthis.rate_control.refresh();\n\t\t}\n\n\t\tif (this.discount_percentage_control && !this.allow_discount_change) {\n\t\t\tthis.discount_percentage_control.df.read_only = 1;\n\t\t\tthis.discount_percentage_control.refresh();\n\t\t}\n\n\t\tif (this.warehouse_control) {\n\t\t\tthis.warehouse_control.df.reqd = 1;\n\t\t\tthis.warehouse_control.df.onchange = function() {\n\t\t\t\tif (this.value) {\n\t\t\t\t\tme.events.form_updated(me.current_item, 'warehouse', this.value).then(() => {\n\t\t\t\t\t\tme.item_stock_map = me.events.get_item_stock_map();\n\t\t\t\t\t\tconst available_qty = me.item_stock_map[me.item_row.item_code][this.value];\n\t\t\t\t\t\tif (available_qty === undefined) {\n\t\t\t\t\t\t\tme.events.get_available_stock(me.item_row.item_code, this.value).then(() => {\n\t\t\t\t\t\t\t\t// item stock map is updated now reset warehouse\n\t\t\t\t\t\t\t\tme.warehouse_control.set_value(this.value);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t} else if (available_qty === 0) {\n\t\t\t\t\t\t\tme.warehouse_control.set_value('');\n\t\t\t\t\t\t\tconst bold_item_code = me.item_row.item_code.bold();\n\t\t\t\t\t\t\tconst bold_warehouse = this.value.bold();\n\t\t\t\t\t\t\tfrappe.throw(\n\t\t\t\t\t\t\t\t__('Item Code: {0} is not available under warehouse {1}.', [bold_item_code, bold_warehouse])\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tme.actual_qty_control.set_value(available_qty);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.warehouse_control.df.get_query = () => {\n\t\t\t\treturn {\n\t\t\t\t\tfilters: { company: this.events.get_frm().doc.company }\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.warehouse_control.refresh();\n\t\t}\n\n\t\tif (this.serial_no_control) {\n\t\t\tthis.serial_no_control.df.reqd = 1;\n\t\t\tthis.serial_no_control.df.onchange = async function() {\n\t\t\t\t!me.current_item.batch_no && await me.auto_update_batch_no();\n\t\t\t\tme.events.form_updated(me.current_item, 'serial_no', this.value);\n\t\t\t}\n\t\t\tthis.serial_no_control.refresh();\n\t\t}\n\n\t\tif (this.batch_no_control) {\n\t\t\tthis.batch_no_control.df.reqd = 1;\n\t\t\tthis.batch_no_control.df.get_query = () => {\n\t\t\t\treturn {\n\t\t\t\t\tquery: 'erpnext.controllers.queries.get_batch_no',\n\t\t\t\t\tfilters: {\n\t\t\t\t\t\titem_code: me.item_row.item_code,\n\t\t\t\t\t\twarehouse: me.item_row.warehouse,\n\t\t\t\t\t\tposting_date: me.events.get_frm().doc.posting_date\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.batch_no_control.refresh();\n\t\t}\n\n\t\tif (this.uom_control) {\n\t\t\tthis.uom_control.df.onchange = function() {\n\t\t\t\tme.events.form_updated(me.current_item, 'uom', this.value);\n\n\t\t\t\tconst item_row = frappe.get_doc(me.doctype, me.name);\n\t\t\t\tme.conversion_factor_control.df.read_only = (item_row.stock_uom == this.value);\n\t\t\t\tme.conversion_factor_control.refresh();\n\t\t\t}\n\t\t}\n\n\t\tfrappe.model.on(\"POS Invoice Item\", \"*\", (fieldname, value, item_row) => {\n\t\t\tconst field_control = this[`${fieldname}_control`];\n\t\t\tconst item_row_is_being_edited = this.compare_with_current_item(item_row);\n\n\t\t\tif (item_row_is_being_edited && field_control && field_control.get_value() !== value) {\n\t\t\t\tfield_control.set_value(value);\n\t\t\t\tcur_pos.update_cart_html(item_row);\n\t\t\t}\n\t\t});\n\t}\n\n\tasync auto_update_batch_no() {\n\t\tif (this.serial_no_control && this.batch_no_control) {\n\t\t\tconst selected_serial_nos = this.serial_no_control.get_value().split(`\\n`).filter(s => s);\n\t\t\tif (!selected_serial_nos.length) return;\n\n\t\t\t// find batch nos of the selected serial no\n\t\t\tconst serials_with_batch_no = await frappe.db.get_list(\"Serial No\", {\n\t\t\t\tfilters: { 'name': [\"in\", selected_serial_nos]},\n\t\t\t\tfields: [\"batch_no\", \"name\"]\n\t\t\t});\n\t\t\tconst batch_serial_map = serials_with_batch_no.reduce((acc, r) => {\n\t\t\t\tif (!acc[r.batch_no]) {\n\t\t\t\t\tacc[r.batch_no] = [];\n\t\t\t\t}\n\t\t\t\tacc[r.batch_no] = [...acc[r.batch_no], r.name];\n\t\t\t\treturn acc;\n\t\t\t}, {});\n\t\t\t// set current item's batch no and serial no\n\t\t\tconst batch_no = Object.keys(batch_serial_map)[0];\n\t\t\tconst batch_serial_nos = batch_serial_map[batch_no].join(`\\n`);\n\t\t\t// eg. 10 selected serial no. -> 5 belongs to first batch other 5 belongs to second batch\n\t\t\tconst serial_nos_belongs_to_other_batch = selected_serial_nos.length !== batch_serial_map[batch_no].length;\n\n\t\t\tconst current_batch_no = this.batch_no_control.get_value();\n\t\t\tcurrent_batch_no != batch_no && await this.batch_no_control.set_value(batch_no);\n\n\t\t\tif (serial_nos_belongs_to_other_batch) {\n\t\t\t\tthis.serial_no_control.set_value(batch_serial_nos);\n\t\t\t\tthis.qty_control.set_value(batch_serial_map[batch_no].length);\n\n\t\t\t\tdelete batch_serial_map[batch_no];\n\t\t\t\tthis.events.clone_new_batch_item_in_frm(batch_serial_map, this.current_item);\n\t\t\t}\n\t\t}\n\t}\n\n\tbind_events() {\n\t\tthis.bind_auto_serial_fetch_event();\n\t\tthis.bind_fields_to_numpad_fields();\n\n\t\tthis.$component.on('click', '.close-btn', () => {\n\t\t\tthis.events.close_item_details();\n\t\t});\n\t}\n\n\tattach_shortcuts() {\n\t\tthis.wrapper.find('.close-btn').attr(\"title\", \"Esc\");\n\t\tfrappe.ui.keys.on(\"escape\", () => {\n\t\t\tconst item_details_visible = this.$component.is(\":visible\");\n\t\t\tif (item_details_visible) {\n\t\t\t\tthis.events.close_item_details();\n\t\t\t}\n\t\t});\n\t}\n\n\tbind_fields_to_numpad_fields() {\n\t\tconst me = this;\n\t\tthis.$form_container.on('click', '.input-with-feedback', function() {\n\t\t\tconst fieldname = $(this).attr('data-fieldname');\n\t\t\tif (this.last_field_focused != fieldname) {\n\t\t\t\tme.events.item_field_focused(fieldname);\n\t\t\t\tthis.last_field_focused = fieldname;\n\t\t\t}\n\t\t});\n\t}\n\n\tbind_auto_serial_fetch_event() {\n\t\tthis.$form_container.on('click', '.auto-fetch-btn', () => {\n\t\t\tthis.batch_no_control && this.batch_no_control.set_value('');\n\t\t\tlet qty = this.qty_control.get_value();\n\t\t\tlet conversion_factor = this.conversion_factor_control.get_value();\n\t\t\tlet expiry_date = this.item_row.has_batch_no ? this.events.get_frm().doc.posting_date : \"\";\n\n\t\t\tlet numbers = frappe.call({\n\t\t\t\tmethod: \"erpnext.stock.doctype.serial_no.serial_no.auto_fetch_serial_number\",\n\t\t\t\targs: {\n\t\t\t\t\tqty: qty * conversion_factor,\n\t\t\t\t\titem_code: this.current_item.item_code,\n\t\t\t\t\twarehouse: this.warehouse_control.get_value() || '',\n\t\t\t\t\tbatch_nos: this.current_item.batch_no || '',\n\t\t\t\t\tposting_date: expiry_date,\n\t\t\t\t\tfor_doctype: 'POS Invoice'\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tnumbers.then((data) => {\n\t\t\t\tlet auto_fetched_serial_numbers = data.message;\n\t\t\t\tlet records_length = auto_fetched_serial_numbers.length;\n\t\t\t\tif (!records_length) {\n\t\t\t\t\tconst warehouse = this.warehouse_control.get_value().bold();\n\t\t\t\t\tconst item_code = this.current_item.item_code.bold();\n\t\t\t\t\tfrappe.msgprint(\n\t\t\t\t\t\t__('Serial numbers unavailable for Item {0} under warehouse {1}. Please try changing warehouse.', [item_code, warehouse])\n\t\t\t\t\t);\n\t\t\t\t} else if (records_length < qty) {\n\t\t\t\t\tfrappe.msgprint(\n\t\t\t\t\t\t__('Fetched only {0} available serial numbers.', [records_length])\n\t\t\t\t\t);\n\t\t\t\t\tthis.qty_control.set_value(records_length);\n\t\t\t\t}\n\t\t\t\tnumbers = auto_fetched_serial_numbers.join(`\\n`);\n\t\t\t\tthis.serial_no_control.set_value(numbers);\n\t\t\t});\n\t\t})\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\n\t}\n}\n","erpnext.PointOfSale.NumberPad = class {\n\tconstructor({ wrapper, events, cols, keys, css_classes, fieldnames_map }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\t\tthis.cols = cols;\n\t\tthis.keys = keys;\n\t\tthis.css_classes = css_classes || [];\n\t\tthis.fieldnames = fieldnames_map || {};\n\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.bind_events();\n\t}\n\n\tprepare_dom() {\n\t\tconst { cols, keys, css_classes, fieldnames } = this;\n\n\t\tfunction get_keys() {\n\t\t\treturn keys.reduce((a, row, i) => {\n\t\t\t\treturn a + row.reduce((a2, number, j) => {\n\t\t\t\t\tconst class_to_append = css_classes && css_classes[i] ? css_classes[i][j] : '';\n\t\t\t\t\tconst fieldname = fieldnames && fieldnames[number] ?\n\t\t\t\t\t\tfieldnames[number] : typeof number === 'string' ? frappe.scrub(number) : number;\n\n\t\t\t\t\treturn a2 + `<div class=\"numpad-btn ${class_to_append}\" data-button-value=\"${fieldname}\">${number}</div>`;\n\t\t\t\t}, '');\n\t\t\t}, '');\n\t\t}\n\n\t\tthis.wrapper.html(\n\t\t\t`<div class=\"numpad-container\">\n\t\t\t\t${get_keys()}\n\t\t\t</div>`\n\t\t)\n\t}\n\n\tbind_events() {\n\t\tconst me = this;\n\t\tthis.wrapper.on('click', '.numpad-btn', function() {\n\t\t\tconst $btn = $(this);\n\t\t\tme.events.numpad_event($btn);\n\t\t});\n\t}\n}\n","/* eslint-disable no-unused-vars */\nerpnext.PointOfSale.Payment = class {\n\tconstructor({ events, wrapper }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.initialize_numpad();\n\t\tthis.bind_events();\n\t\tthis.attach_shortcuts();\n\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"payment-container\">\n\t\t\t\t<div class=\"section-label payment-section\">Payment Method</div>\n\t\t\t\t<div class=\"payment-modes\"></div>\n\t\t\t\t<div class=\"fields-numpad-container\">\n\t\t\t\t\t<div class=\"fields-section\">\n\t\t\t\t\t\t<div class=\"section-label\">Additional Information</div>\n\t\t\t\t\t\t<div class=\"invoice-fields\"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"number-pad\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"totals-section\">\n\t\t\t\t\t<div class=\"totals\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"submit-order-btn\">Complete Order</div>\n\t\t\t</section>`\n\t\t);\n\t\tthis.$component = this.wrapper.find('.payment-container');\n\t\tthis.$payment_modes = this.$component.find('.payment-modes');\n\t\tthis.$totals_section = this.$component.find('.totals-section');\n\t\tthis.$totals = this.$component.find('.totals');\n\t\tthis.$numpad = this.$component.find('.number-pad');\n\t\tthis.$invoice_fields_section = this.$component.find('.fields-section');\n\t}\n\n\tmake_invoice_fields_control() {\n\t\tfrappe.db.get_doc(\"POS Settings\", undefined).then((doc) => {\n\t\t\tconst fields = doc.invoice_fields;\n\t\t\tif (!fields.length) return;\n\n\t\t\tthis.$invoice_fields = this.$invoice_fields_section.find('.invoice-fields');\n\t\t\tthis.$invoice_fields.html('');\n\t\t\tconst frm = this.events.get_frm();\n\n\t\t\tfields.forEach(df => {\n\t\t\t\tthis.$invoice_fields.append(\n\t\t\t\t\t`<div class=\"invoice_detail_field ${df.fieldname}-field\" data-fieldname=\"${df.fieldname}\"></div>`\n\t\t\t\t);\n\t\t\t\tlet df_events = {\n\t\t\t\t\tonchange: function() {\n\t\t\t\t\t\tfrm.set_value(this.df.fieldname, this.get_value());\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tif (df.fieldtype == \"Button\") {\n\t\t\t\t\tdf_events = {\n\t\t\t\t\t\tclick: function() {\n\t\t\t\t\t\t\tif (frm.script_manager.has_handlers(df.fieldname, frm.doc.doctype)) {\n\t\t\t\t\t\t\t\tfrm.script_manager.trigger(df.fieldname, frm.doc.doctype, frm.doc.docname);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tthis[`${df.fieldname}_field`] = frappe.ui.form.make_control({\n\t\t\t\t\tdf: {\n\t\t\t\t\t\t...df,\n\t\t\t\t\t\t...df_events\n\t\t\t\t\t},\n\t\t\t\t\tparent: this.$invoice_fields.find(`.${df.fieldname}-field`),\n\t\t\t\t\trender_input: true,\n\t\t\t\t});\n\t\t\t\tthis[`${df.fieldname}_field`].set_value(frm.doc[df.fieldname]);\n\t\t\t});\n\t\t});\n\t}\n\n\tinitialize_numpad() {\n\t\tconst me = this;\n\t\tthis.number_pad = new erpnext.PointOfSale.NumberPad({\n\t\t\twrapper: this.$numpad,\n\t\t\tevents: {\n\t\t\t\tnumpad_event: function($btn) {\n\t\t\t\t\tme.on_numpad_clicked($btn);\n\t\t\t\t}\n\t\t\t},\n\t\t\tcols: 3,\n\t\t\tkeys: [\n\t\t\t\t[ 1, 2, 3 ],\n\t\t\t\t[ 4, 5, 6 ],\n\t\t\t\t[ 7, 8, 9 ],\n\t\t\t\t[ '.', 0, 'Delete' ]\n\t\t\t],\n\t\t});\n\n\t\tthis.numpad_value = '';\n\t}\n\n\ton_numpad_clicked($btn) {\n\t\tconst button_value = $btn.attr('data-button-value');\n\n\t\thighlight_numpad_btn($btn);\n\t\tthis.numpad_value = button_value === 'delete' ? this.numpad_value.slice(0, -1) : this.numpad_value + button_value;\n\t\tthis.selected_mode.$input.get(0).focus();\n\t\tthis.selected_mode.set_value(this.numpad_value);\n\n\t\tfunction highlight_numpad_btn($btn) {\n\t\t\t$btn.addClass('shadow-base-inner bg-selected');\n\t\t\tsetTimeout(() => {\n\t\t\t\t$btn.removeClass('shadow-base-inner bg-selected');\n\t\t\t}, 100);\n\t\t}\n\t}\n\n\tbind_events() {\n\t\tconst me = this;\n\n\t\tthis.$payment_modes.on('click', '.mode-of-payment', function(e) {\n\t\t\tconst mode_clicked = $(this);\n\t\t\t// if clicked element doesn't have .mode-of-payment class then return\n\t\t\tif (!$(e.target).is(mode_clicked)) return;\n\n\t\t\tconst scrollLeft = mode_clicked.offset().left - me.$payment_modes.offset().left + me.$payment_modes.scrollLeft();\n\t\t\tme.$payment_modes.animate({ scrollLeft });\n\n\t\t\tconst mode = mode_clicked.attr('data-mode');\n\n\t\t\t// hide all control fields and shortcuts\n\t\t\t$(`.mode-of-payment-control`).css('display', 'none');\n\t\t\t$(`.cash-shortcuts`).css('display', 'none');\n\t\t\tme.$payment_modes.find(`.pay-amount`).css('display', 'inline');\n\t\t\tme.$payment_modes.find(`.loyalty-amount-name`).css('display', 'none');\n\n\t\t\t// remove highlight from all mode-of-payments\n\t\t\t$('.mode-of-payment').removeClass('border-primary');\n\n\t\t\tif (mode_clicked.hasClass('border-primary')) {\n\t\t\t\t// clicked one is selected then unselect it\n\t\t\t\tmode_clicked.removeClass('border-primary');\n\t\t\t\tme.selected_mode = '';\n\t\t\t} else {\n\t\t\t\t// clicked one is not selected then select it\n\t\t\t\tmode_clicked.addClass('border-primary');\n\t\t\t\tmode_clicked.find('.mode-of-payment-control').css('display', 'flex');\n\t\t\t\tmode_clicked.find('.cash-shortcuts').css('display', 'grid');\n\t\t\t\tme.$payment_modes.find(`.${mode}-amount`).css('display', 'none');\n\t\t\t\tme.$payment_modes.find(`.${mode}-name`).css('display', 'inline');\n\n\t\t\t\tme.selected_mode = me[`${mode}_control`];\n\t\t\t\tme.selected_mode && me.selected_mode.$input.get(0).focus();\n\t\t\t\tme.auto_set_remaining_amount();\n\t\t\t}\n\t\t});\n\n\t\tfrappe.ui.form.on('POS Invoice', 'contact_mobile', (frm) => {\n\t\t\tconst contact = frm.doc.contact_mobile;\n\t\t\tconst request_button = $(this.request_for_payment_field.$input[0]);\n\t\t\tif (contact) {\n\t\t\t\trequest_button.removeClass('btn-default').addClass('btn-primary');\n\t\t\t} else {\n\t\t\t\trequest_button.removeClass('btn-primary').addClass('btn-default');\n      }\n    });\n\n\t\tthis.setup_listener_for_payments();\n\n\t\tthis.$payment_modes.on('click', '.shortcut', function() {\n\t\t\tconst value = $(this).attr('data-value');\n\t\t\tme.selected_mode.set_value(value);\n\t\t});\n\n\t\tthis.$component.on('click', '.submit-order-btn', () => {\n\t\t\tconst doc = this.events.get_frm().doc;\n\t\t\tconst paid_amount = doc.paid_amount;\n\t\t\tconst items = doc.items;\n\n\t\t\tif (paid_amount == 0 || !items.length) {\n\t\t\t\tconst message = items.length ? __(\"You cannot submit the order without payment.\") : __(\"You cannot submit empty order.\");\n\t\t\t\tfrappe.show_alert({ message, indicator: \"orange\" });\n\t\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.events.submit_invoice();\n\t\t});\n\n\t\tfrappe.ui.form.on('POS Invoice', 'paid_amount', (frm) => {\n\t\t\tthis.update_totals_section(frm.doc);\n\n\t\t\t// need to re calculate cash shortcuts after discount is applied\n\t\t\tconst is_cash_shortcuts_invisible = !this.$payment_modes.find('.cash-shortcuts').is(':visible');\n\t\t\tthis.attach_cash_shortcuts(frm.doc);\n\t\t\t!is_cash_shortcuts_invisible && this.$payment_modes.find('.cash-shortcuts').css('display', 'grid');\n\t\t\tthis.render_payment_mode_dom();\n\t\t});\n\n\t\tfrappe.ui.form.on('POS Invoice', 'loyalty_amount', (frm) => {\n\t\t\tconst formatted_currency = format_currency(frm.doc.loyalty_amount, frm.doc.currency);\n\t\t\tthis.$payment_modes.find(`.loyalty-amount-amount`).html(formatted_currency);\n\t\t});\n\n\t\tfrappe.ui.form.on(\"Sales Invoice Payment\", \"amount\", (frm, cdt, cdn) => {\n\t\t\t// for setting correct amount after loyalty points are redeemed\n\t\t\tconst default_mop = locals[cdt][cdn];\n\t\t\tconst mode = default_mop.mode_of_payment.replace(/ +/g, \"_\").toLowerCase();\n\t\t\tif (this[`${mode}_control`] && this[`${mode}_control`].get_value() != default_mop.amount) {\n\t\t\t\tthis[`${mode}_control`].set_value(default_mop.amount);\n\t\t\t}\n\t\t});\n\t}\n\n\tsetup_listener_for_payments() {\n\t\tfrappe.realtime.on(\"process_phone_payment\", (data) => {\n\t\t\tconst doc = this.events.get_frm().doc;\n\t\t\tconst { response, amount, success, failure_message } = data;\n\t\t\tlet message, title;\n\n\t\t\tif (success) {\n\t\t\t\ttitle = __(\"Payment Received\");\n\t\t\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\n\t\t\t\tif (amount >= grand_total) {\n\t\t\t\t\tfrappe.dom.unfreeze();\n\t\t\t\t\tmessage = __(\"Payment of {0} received successfully.\", [format_currency(amount, doc.currency, 0)]);\n\t\t\t\t\tthis.events.submit_invoice();\n\t\t\t\t\tcur_frm.reload_doc();\n\n\t\t\t\t} else {\n\t\t\t\t\tmessage = __(\"Payment of {0} received successfully. Waiting for other requests to complete...\", [format_currency(amount, doc.currency, 0)]);\n\t\t\t\t}\n\t\t\t} else if (failure_message) {\n\t\t\t\tmessage = failure_message;\n\t\t\t\ttitle = __(\"Payment Failed\");\n\t\t\t}\n\n\t\t\tfrappe.msgprint({ \"message\": message, \"title\": title });\n\t\t});\n\t}\n\n\tauto_set_remaining_amount() {\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\n\t\tconst remaining_amount = grand_total - doc.paid_amount;\n\t\tconst current_value = this.selected_mode ? this.selected_mode.get_value() : undefined;\n\t\tif (!current_value && remaining_amount > 0 && this.selected_mode) {\n\t\t\tthis.selected_mode.set_value(remaining_amount);\n\t\t}\n\t}\n\n\tattach_shortcuts() {\n\t\tconst ctrl_label = frappe.utils.is_mac() ? '⌘' : 'Ctrl';\n\t\tthis.$component.find('.submit-order-btn').attr(\"title\", `${ctrl_label}+Enter`);\n\t\tfrappe.ui.keys.on(\"ctrl+enter\", () => {\n\t\t\tconst payment_is_visible = this.$component.is(\":visible\");\n\t\t\tconst active_mode = this.$payment_modes.find(\".border-primary\");\n\t\t\tif (payment_is_visible && active_mode.length) {\n\t\t\t\tthis.$component.find('.submit-order-btn').click();\n\t\t\t}\n\t\t});\n\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"tab\",\n\t\t\taction: () => {\n\t\t\t\tconst payment_is_visible = this.$component.is(\":visible\");\n\t\t\t\tlet active_mode = this.$payment_modes.find(\".border-primary\");\n\t\t\t\tactive_mode = active_mode.length ? active_mode.attr(\"data-mode\") : undefined;\n\n\t\t\t\tif (!active_mode) return;\n\n\t\t\t\tconst mode_of_payments = Array.from(this.$payment_modes.find(\".mode-of-payment\")).map(m => $(m).attr(\"data-mode\"));\n\t\t\t\tconst mode_index = mode_of_payments.indexOf(active_mode);\n\t\t\t\tconst next_mode_index = (mode_index + 1) % mode_of_payments.length;\n\t\t\t\tconst next_mode_to_be_clicked = this.$payment_modes.find(`.mode-of-payment[data-mode=\"${mode_of_payments[next_mode_index]}\"]`);\n\n\t\t\t\tif (payment_is_visible && mode_index != next_mode_index) {\n\t\t\t\t\tnext_mode_to_be_clicked.click();\n\t\t\t\t}\n\t\t\t},\n\t\t\tcondition: () => this.$component.is(':visible') && this.$payment_modes.find(\".border-primary\").length,\n\t\t\tdescription: __(\"Switch Between Payment Modes\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t}\n\n\ttoggle_numpad() {\n\t\t// pass\n\t}\n\n\trender_payment_section() {\n\t\tthis.render_payment_mode_dom();\n\t\tthis.make_invoice_fields_control();\n\t\tthis.update_totals_section();\n\t\tthis.focus_on_default_mop();\n\t}\n\n\tedit_cart() {\n\t\tthis.events.toggle_other_sections(false);\n\t\tthis.toggle_component(false);\n\t}\n\n\tcheckout() {\n\t\tthis.events.toggle_other_sections(true);\n\t\tthis.toggle_component(true);\n\n\t\tthis.render_payment_section();\n\t}\n\n\ttoggle_remarks_control() {\n\t\tif (this.$remarks.find('.frappe-control').length) {\n\t\t\tthis.$remarks.html('+ Add Remark');\n\t\t} else {\n\t\t\tthis.$remarks.html('');\n\t\t\tthis[`remark_control`] = frappe.ui.form.make_control({\n\t\t\t\tdf: {\n\t\t\t\t\tlabel: __('Remark'),\n\t\t\t\t\tfieldtype: 'Data',\n\t\t\t\t\tonchange: function() {}\n\t\t\t\t},\n\t\t\t\tparent: this.$totals_section.find(`.remarks`),\n\t\t\t\trender_input: true,\n\t\t\t});\n\t\t\tthis[`remark_control`].set_value('');\n\t\t}\n\t}\n\n\trender_payment_mode_dom() {\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst payments = doc.payments;\n\t\tconst currency = doc.currency;\n\n\t\tthis.$payment_modes.html(`${\n\t\t\tpayments.map((p, i) => {\n\t\t\t\tconst mode = p.mode_of_payment.replace(/ +/g, \"_\").toLowerCase();\n\t\t\t\tconst payment_type = p.type;\n\t\t\t\tconst margin = i % 2 === 0 ? 'pr-2' : 'pl-2';\n\t\t\t\tconst amount = p.amount > 0 ? format_currency(p.amount, currency) : '';\n\n\t\t\t\treturn (`\n\t\t\t\t\t<div class=\"payment-mode-wrapper\">\n\t\t\t\t\t\t<div class=\"mode-of-payment\" data-mode=\"${mode}\" data-payment-type=\"${payment_type}\">\n\t\t\t\t\t\t\t${p.mode_of_payment}\n\t\t\t\t\t\t\t<div class=\"${mode}-amount pay-amount\">${amount}</div>\n\t\t\t\t\t\t\t<div class=\"${mode} mode-of-payment-control\"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`);\n\t\t\t}).join('')\n\t\t}`);\n\n\t\tpayments.forEach(p => {\n\t\t\tconst mode = p.mode_of_payment.replace(/ +/g, \"_\").toLowerCase();\n\t\t\tconst me = this;\n\t\t\tthis[`${mode}_control`] = frappe.ui.form.make_control({\n\t\t\t\tdf: {\n\t\t\t\t\tlabel: p.mode_of_payment,\n\t\t\t\t\tfieldtype: 'Currency',\n\t\t\t\t\tplaceholder: __('Enter {0} amount.', [p.mode_of_payment]),\n\t\t\t\t\tonchange: function() {\n\t\t\t\t\t\tconst current_value = frappe.model.get_value(p.doctype, p.name, 'amount');\n\t\t\t\t\t\tif (current_value != this.value) {\n\t\t\t\t\t\t\tfrappe.model\n\t\t\t\t\t\t\t\t.set_value(p.doctype, p.name, 'amount', flt(this.value))\n\t\t\t\t\t\t\t\t.then(() => me.update_totals_section())\n\n\t\t\t\t\t\t\tconst formatted_currency = format_currency(this.value, currency);\n\t\t\t\t\t\t\tme.$payment_modes.find(`.${mode}-amount`).html(formatted_currency);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tparent: this.$payment_modes.find(`.${mode}.mode-of-payment-control`),\n\t\t\t\trender_input: true,\n\t\t\t});\n\t\t\tthis[`${mode}_control`].toggle_label(false);\n\t\t\tthis[`${mode}_control`].set_value(p.amount);\n\t\t});\n\n\t\tthis.render_loyalty_points_payment_mode();\n\n\t\tthis.attach_cash_shortcuts(doc);\n\t}\n\n\tfocus_on_default_mop() {\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst payments = doc.payments;\n\t\tpayments.forEach(p => {\n\t\t\tconst mode = p.mode_of_payment.replace(/ +/g, \"_\").toLowerCase();\n\t\t\tif (p.default) {\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tthis.$payment_modes.find(`.${mode}.mode-of-payment-control`).parent().click();\n\t\t\t\t}, 500);\n\t\t\t}\n\t\t});\n\t}\n\n\tattach_cash_shortcuts(doc) {\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\n\t\tconst currency = doc.currency;\n\n\t\tconst shortcuts = this.get_cash_shortcuts(flt(grand_total));\n\n\t\tthis.$payment_modes.find('.cash-shortcuts').remove();\n\t\tlet shortcuts_html = shortcuts.map(s => {\n\t\t\treturn `<div class=\"shortcut\" data-value=\"${s}\">${format_currency(s, currency, 0)}</div>`;\n\t\t}).join('');\n\n\t\tthis.$payment_modes.find('[data-payment-type=\"Cash\"]').find('.mode-of-payment-control')\n\t\t\t.after(`<div class=\"cash-shortcuts\">${shortcuts_html}</div>`);\n\t}\n\n\tget_cash_shortcuts(grand_total) {\n\t\tlet steps = [1, 5, 10];\n\t\tconst digits = String(Math.round(grand_total)).length;\n\n\t\tsteps = steps.map(x => x * (10 ** (digits - 2)));\n\n\t\tconst get_nearest = (amount, x) => {\n\t\t\tlet nearest_x = Math.ceil((amount / x)) * x;\n\t\t\treturn nearest_x === amount ? nearest_x + x : nearest_x;\n\t\t};\n\n\t\treturn steps.reduce((finalArr, x) => {\n\t\t\tlet nearest_x = get_nearest(grand_total, x);\n\t\t\tnearest_x = finalArr.indexOf(nearest_x) != -1 ? nearest_x + x : nearest_x;\n\t\t\treturn [...finalArr, nearest_x];\n\t\t}, []);\n\t}\n\n\trender_loyalty_points_payment_mode() {\n\t\tconst me = this;\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst { loyalty_program, loyalty_points, conversion_factor } = this.events.get_customer_details();\n\n\t\tthis.$payment_modes.find(`.mode-of-payment[data-mode=\"loyalty-amount\"]`).parent().remove();\n\n\t\tif (!loyalty_program) return;\n\n\t\tlet description, read_only, max_redeemable_amount;\n\t\tif (!loyalty_points) {\n\t\t\tdescription = __(\"You don't have enough points to redeem.\");\n\t\t\tread_only = true;\n\t\t} else {\n\t\t\tmax_redeemable_amount = flt(flt(loyalty_points) * flt(conversion_factor), precision(\"loyalty_amount\", doc));\n\t\t\tdescription = __(\"You can redeem upto {0}.\", [format_currency(max_redeemable_amount)]);\n\t\t\tread_only = false;\n\t\t}\n\n\t\tconst margin = this.$payment_modes.children().length % 2 === 0 ? 'pr-2' : 'pl-2';\n\t\tconst amount = doc.loyalty_amount > 0 ? format_currency(doc.loyalty_amount, doc.currency) : '';\n\t\tthis.$payment_modes.append(\n\t\t\t`<div class=\"payment-mode-wrapper\">\n\t\t\t\t<div class=\"mode-of-payment loyalty-card\" data-mode=\"loyalty-amount\" data-payment-type=\"loyalty-amount\">\n\t\t\t\t\tRedeem Loyalty Points\n\t\t\t\t\t<div class=\"loyalty-amount-amount pay-amount\">${amount}</div>\n\t\t\t\t\t<div class=\"loyalty-amount-name\">${loyalty_program}</div>\n\t\t\t\t\t<div class=\"loyalty-amount mode-of-payment-control\"></div>\n\t\t\t\t</div>\n\t\t\t</div>`\n\t\t);\n\n\t\tthis['loyalty-amount_control'] = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __(\"Redeem Loyalty Points\"),\n\t\t\t\tfieldtype: 'Currency',\n\t\t\t\tplaceholder: __(\"Enter amount to be redeemed.\"),\n\t\t\t\toptions: 'company:currency',\n\t\t\t\tread_only,\n\t\t\t\tonchange: async function() {\n\t\t\t\t\tif (!loyalty_points) return;\n\n\t\t\t\t\tif (this.value > max_redeemable_amount) {\n\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\tmessage: __(\"You cannot redeem more than {0}.\", [format_currency(max_redeemable_amount)]),\n\t\t\t\t\t\t\tindicator: \"red\"\n\t\t\t\t\t\t});\n\t\t\t\t\t\tfrappe.utils.play_sound(\"submit\");\n\t\t\t\t\t\tme['loyalty-amount_control'].set_value(0);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst redeem_loyalty_points = this.value > 0 ? 1 : 0;\n\t\t\t\t\tawait frappe.model.set_value(doc.doctype, doc.name, 'redeem_loyalty_points', redeem_loyalty_points);\n\t\t\t\t\tfrappe.model.set_value(doc.doctype, doc.name, 'loyalty_points', parseInt(this.value / conversion_factor));\n\t\t\t\t},\n\t\t\t\tdescription\n\t\t\t},\n\t\t\tparent: this.$payment_modes.find(`.loyalty-amount.mode-of-payment-control`),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis['loyalty-amount_control'].toggle_label(false);\n\n\t\t// this.render_add_payment_method_dom();\n\t}\n\n\trender_add_payment_method_dom() {\n\t\tconst docstatus = this.events.get_frm().doc.docstatus;\n\t\tif (docstatus === 0)\n\t\t\tthis.$payment_modes.append(\n\t\t\t\t`<div class=\"w-full pr-2\">\n\t\t\t\t\t<div class=\"add-mode-of-payment w-half text-grey mb-4 no-select pointer\">+ Add Payment Method</div>\n\t\t\t\t</div>`\n\t\t\t);\n\t}\n\n\tupdate_totals_section(doc) {\n\t\tif (!doc) doc = this.events.get_frm().doc;\n\t\tconst paid_amount = doc.paid_amount;\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\n\t\tconst remaining = grand_total - doc.paid_amount;\n\t\tconst change = doc.change_amount || remaining <= 0 ? -1 * remaining : undefined;\n\t\tconst currency = doc.currency;\n\t\tconst label = change ? __('Change') : __('To Be Paid');\n\n\t\tthis.$totals.html(\n\t\t\t`<div class=\"col\">\n\t\t\t\t<div class=\"total-label\">Grand Total</div>\n\t\t\t\t<div class=\"value\">${format_currency(grand_total, currency)}</div>\n\t\t\t</div>\n\t\t\t<div class=\"seperator-y\"></div>\n\t\t\t<div class=\"col\">\n\t\t\t\t<div class=\"total-label\">Paid Amount</div>\n\t\t\t\t<div class=\"value\">${format_currency(paid_amount, currency)}</div>\n\t\t\t</div>\n\t\t\t<div class=\"seperator-y\"></div>\n\t\t\t<div class=\"col\">\n\t\t\t\t<div class=\"total-label\">${label}</div>\n\t\t\t\t<div class=\"value\">${format_currency(change || remaining, currency)}</div>\n\t\t\t</div>`\n\t\t);\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\n\t}\n};\n","erpnext.PointOfSale.PastOrderList = class {\n\tconstructor({ wrapper, events }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.make_filter_section();\n\t\tthis.bind_events();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"past-order-list\">\n\t\t\t\t<div class=\"filter-section\">\n\t\t\t\t\t<div class=\"label\">Recent Orders</div>\n\t\t\t\t\t<div class=\"search-field\"></div>\n\t\t\t\t\t<div class=\"status-field\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"invoices-container\"></div>\n\t\t\t</section>`\n\t\t);\n\n\t\tthis.$component = this.wrapper.find('.past-order-list');\n\t\tthis.$invoices_container = this.$component.find('.invoices-container');\n\t}\n\n\tbind_events() {\n\t\tthis.search_field.$input.on('input', (e) => {\n\t\t\tclearTimeout(this.last_search);\n\t\t\tthis.last_search = setTimeout(() => {\n\t\t\t\tconst search_term = e.target.value;\n\t\t\t\tthis.refresh_list(search_term, this.status_field.get_value());\n\t\t\t}, 300);\n\t\t});\n\t\tconst me = this;\n\t\tthis.$invoices_container.on('click', '.invoice-wrapper', function() {\n\t\t\tconst invoice_name = unescape($(this).attr('data-invoice-name'));\n\n\t\t\tme.events.open_invoice_data(invoice_name);\n\t\t});\n\t}\n\n\tmake_filter_section() {\n\t\tconst me = this;\n\t\tthis.search_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Search'),\n\t\t\t\tfieldtype: 'Data',\n\t\t\t\tplaceholder: __('Search by invoice id or customer name')\n\t\t\t},\n\t\t\tparent: this.$component.find('.search-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.status_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Invoice Status'),\n\t\t\t\tfieldtype: 'Select',\n\t\t\t\toptions: `Draft\\nPaid\\nConsolidated\\nReturn`,\n\t\t\t\tplaceholder: __('Filter by invoice status'),\n\t\t\t\tonchange: function() {\n\t\t\t\t\tif (me.$component.is(':visible')) me.refresh_list();\n\t\t\t\t}\n\t\t\t},\n\t\t\tparent: this.$component.find('.status-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.search_field.toggle_label(false);\n\t\tthis.status_field.toggle_label(false);\n\t\tthis.status_field.set_value('Draft');\n\t}\n\n\trefresh_list() {\n\t\tfrappe.dom.freeze();\n\t\tthis.events.reset_summary();\n\t\tconst search_term = this.search_field.get_value();\n\t\tconst status = this.status_field.get_value();\n\n\t\tthis.$invoices_container.html('');\n\n\t\treturn frappe.call({\n\t\t\tmethod: \"erpnext.selling.page.point_of_sale.point_of_sale.get_past_order_list\",\n\t\t\tfreeze: true,\n\t\t\targs: { search_term, status },\n\t\t\tcallback: (response) => {\n\t\t\t\tfrappe.dom.unfreeze();\n\t\t\t\tresponse.message.forEach(invoice => {\n\t\t\t\t\tconst invoice_html = this.get_invoice_html(invoice);\n\t\t\t\t\tthis.$invoices_container.append(invoice_html);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tget_invoice_html(invoice) {\n\t\tconst posting_datetime = moment(invoice.posting_date+\" \"+invoice.posting_time).format(\"Do MMMM, h:mma\");\n\t\treturn (\n\t\t\t`<div class=\"invoice-wrapper\" data-invoice-name=\"${escape(invoice.name)}\">\n\t\t\t\t<div class=\"invoice-name-date\">\n\t\t\t\t\t<div class=\"invoice-name\">${invoice.name}</div>\n\t\t\t\t\t<div class=\"invoice-date\">\n\t\t\t\t\t\t<svg class=\"mr-2\" width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"1\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n\t\t\t\t\t\t\t<path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"/><circle cx=\"12\" cy=\"7\" r=\"4\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t${frappe.ellipsis(invoice.customer, 20)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"invoice-total-status\">\n\t\t\t\t\t<div class=\"invoice-total\">${format_currency(invoice.grand_total, invoice.currency, 0) || 0}</div>\n\t\t\t\t\t<div class=\"invoice-date\">${posting_datetime}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"seperator\"></div>`\n\t\t);\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') && this.refresh_list() : this.$component.css('display', 'none');\n\t}\n};\n","erpnext.PointOfSale.PastOrderSummary = class {\n\tconstructor({ wrapper, events }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.init_email_print_dialog();\n\t\tthis.bind_events();\n\t\tthis.attach_shortcuts();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"past-order-summary\">\n\t\t\t\t<div class=\"no-summary-placeholder\">\n\t\t\t\t\tSelect an invoice to load summary data\n\t\t\t\t</div>\n\t\t\t\t<div class=\"invoice-summary-wrapper\">\n\t\t\t\t\t<div class=\"abs-container\">\n\t\t\t\t\t\t<div class=\"upper-section\"></div>\n\t\t\t\t\t\t<div class=\"label\">Items</div>\n\t\t\t\t\t\t<div class=\"items-container summary-container\"></div>\n\t\t\t\t\t\t<div class=\"label\">Totals</div>\n\t\t\t\t\t\t<div class=\"totals-container summary-container\"></div>\n\t\t\t\t\t\t<div class=\"label\">Payments</div>\n\t\t\t\t\t\t<div class=\"payments-container summary-container\"></div>\n\t\t\t\t\t\t<div class=\"summary-btns\"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</section>`\n\t\t);\n\n\t\tthis.$component = this.wrapper.find('.past-order-summary');\n\t\tthis.$summary_wrapper = this.$component.find('.invoice-summary-wrapper');\n\t\tthis.$summary_container = this.$component.find('.abs-container');\n\t\tthis.$upper_section = this.$summary_container.find('.upper-section');\n\t\tthis.$items_container = this.$summary_container.find('.items-container');\n\t\tthis.$totals_container = this.$summary_container.find('.totals-container');\n\t\tthis.$payment_container = this.$summary_container.find('.payments-container');\n\t\tthis.$summary_btns = this.$summary_container.find('.summary-btns');\n\t}\n\n\tinit_email_print_dialog() {\n\t\tconst email_dialog = new frappe.ui.Dialog({\n\t\t\ttitle: 'Email Receipt',\n\t\t\tfields: [\n\t\t\t\t{fieldname: 'email_id', fieldtype: 'Data', options: 'Email', label: 'Email ID'},\n\t\t\t\t// {fieldname:'remarks', fieldtype:'Text', label:'Remarks (if any)'}\n\t\t\t],\n\t\t\tprimary_action: () => {\n\t\t\t\tthis.send_email();\n\t\t\t},\n\t\t\tprimary_action_label: __('Send'),\n\t\t});\n\t\tthis.email_dialog = email_dialog;\n\n\t\tconst print_dialog = new frappe.ui.Dialog({\n\t\t\ttitle: 'Print Receipt',\n\t\t\tfields: [\n\t\t\t\t{fieldname: 'print', fieldtype: 'Data', label: 'Print Preview'}\n\t\t\t],\n\t\t\tprimary_action: () => {\n\t\t\t\tthis.print_receipt();\n\t\t\t},\n\t\t\tprimary_action_label: __('Print'),\n\t\t});\n\t\tthis.print_dialog = print_dialog;\n\t}\n\n\tget_upper_section_html(doc) {\n\t\tconst { status } = doc;\n\t\tlet indicator_color = '';\n\n\t\tin_list(['Paid', 'Consolidated'], status) && (indicator_color = 'green');\n\t\tstatus === 'Draft' && (indicator_color = 'red');\n\t\tstatus === 'Return' && (indicator_color = 'grey');\n\n\t\treturn `<div class=\"left-section\">\n\t\t\t\t\t<div class=\"customer-name\">${doc.customer}</div>\n\t\t\t\t\t<div class=\"customer-email\">${this.customer_email}</div>\n\t\t\t\t\t<div class=\"cashier\">Sold by: ${doc.owner}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"right-section\">\n\t\t\t\t\t<div class=\"paid-amount\">${format_currency(doc.paid_amount, doc.currency)}</div>\n\t\t\t\t\t<div class=\"invoice-name\">${doc.name}</div>\n\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color}\"><span>${doc.status}</span></span>\n\t\t\t\t</div>`;\n\t}\n\n\tget_item_html(doc, item_data) {\n\t\treturn `<div class=\"item-row-wrapper\">\n\t\t\t\t\t<div class=\"item-name\">${item_data.item_name}</div>\n\t\t\t\t\t<div class=\"item-qty\">${item_data.qty || 0}</div>\n\t\t\t\t\t<div class=\"item-rate-disc\">${get_rate_discount_html()}</div>\n\t\t\t\t</div>`;\n\n\t\tfunction get_rate_discount_html() {\n\t\t\tif (item_data.rate && item_data.price_list_rate && item_data.rate !== item_data.price_list_rate) {\n\t\t\t\treturn `<span class=\"item-disc\">(${item_data.discount_percentage}% off)</span>\n\t\t\t\t\t\t<div class=\"item-rate\">${format_currency(item_data.rate, doc.currency)}</div>`;\n\t\t\t} else {\n\t\t\t\treturn `<div class=\"item-rate\">${format_currency(item_data.price_list_rate || item_data.rate, doc.currency)}</div>`;\n\t\t\t}\n\t\t}\n\t}\n\n\tget_discount_html(doc) {\n\t\tif (doc.discount_amount) {\n\t\t\treturn `<div class=\"summary-row-wrapper\">\n\t\t\t\t\t\t<div>Discount (${doc.additional_discount_percentage} %)</div>\n\t\t\t\t\t\t<div>${format_currency(doc.discount_amount, doc.currency)}</div>\n\t\t\t\t\t</div>`;\n\t\t} else {\n\t\t\treturn ``;\n\t\t}\n\t}\n\n\tget_net_total_html(doc) {\n\t\treturn `<div class=\"summary-row-wrapper\">\n\t\t\t\t\t<div>Net Total</div>\n\t\t\t\t\t<div>${format_currency(doc.net_total, doc.currency)}</div>\n\t\t\t\t</div>`;\n\t}\n\n\tget_taxes_html(doc) {\n\t\tif (!doc.taxes.length) return '';\n\n\t\tlet taxes_html = doc.taxes.map(t => {\n\t\t\tconst description = /[0-9]+/.test(t.description) ? t.description : `${t.description} @ ${t.rate}%`;\n\t\t\treturn `\n\t\t\t\t<div class=\"tax-row\">\n\t\t\t\t\t<div class=\"tax-label\">${description}</div>\n\t\t\t\t\t<div class=\"tax-value\">${format_currency(t.tax_amount_after_discount_amount, doc.currency)}</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t}).join('');\n\n\t\treturn `<div class=\"taxes-wrapper\">${taxes_html}</div>`;\n\t}\n\n\tget_grand_total_html(doc) {\n\t\treturn `<div class=\"summary-row-wrapper grand-total\">\n\t\t\t\t\t<div>Grand Total</div>\n\t\t\t\t\t<div>${format_currency(doc.grand_total, doc.currency)}</div>\n\t\t\t\t</div>`;\n\t}\n\n\tget_payment_html(doc, payment) {\n\t\treturn `<div class=\"summary-row-wrapper payments\">\n\t\t\t\t\t<div>${payment.mode_of_payment}</div>\n\t\t\t\t\t<div>${format_currency(payment.amount, doc.currency)}</div>\n\t\t\t\t</div>`;\n\t}\n\n\tbind_events() {\n\t\tthis.$summary_container.on('click', '.return-btn', () => {\n\t\t\tthis.events.process_return(this.doc.name);\n\t\t\tthis.toggle_component(false);\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'flex');\n\t\t\tthis.$summary_wrapper.css('display', 'none');\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.edit-btn', () => {\n\t\t\tthis.events.edit_order(this.doc.name);\n\t\t\tthis.toggle_component(false);\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'flex');\n\t\t\tthis.$summary_wrapper.css('display', 'none');\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.delete-btn', () => {\n\t\t\tthis.events.delete_order(this.doc.name);\n\t\t\tthis.show_summary_placeholder();\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.delete-btn', () => {\n\t\t\tthis.events.delete_order(this.doc.name);\n\t\t\tthis.show_summary_placeholder();\n\t\t\t// this.toggle_component(false);\n\t\t\t// this.$component.find('.no-summary-placeholder').removeClass('d-none');\n\t\t\t// this.$summary_wrapper.addClass('d-none');\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.new-btn', () => {\n\t\t\tthis.events.new_order();\n\t\t\tthis.toggle_component(false);\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'flex');\n\t\t\tthis.$summary_wrapper.css('display', 'none');\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.email-btn', () => {\n\t\t\tthis.email_dialog.fields_dict.email_id.set_value(this.customer_email);\n\t\t\tthis.email_dialog.show();\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.print-btn', () => {\n\t\t\tthis.print_receipt();\n\t\t});\n\t}\n\n\tprint_receipt() {\n\t\tconst frm = this.events.get_frm();\n\t\tfrappe.utils.print(\n\t\t\tthis.doc.doctype,\n\t\t\tthis.doc.name,\n\t\t\tfrm.pos_print_format,\n\t\t\tthis.doc.letter_head,\n\t\t\tthis.doc.language || frappe.boot.lang\n\t\t);\n\t}\n\n\tattach_shortcuts() {\n\t\tconst ctrl_label = frappe.utils.is_mac() ? '⌘' : 'Ctrl';\n\t\tthis.$summary_container.find('.print-btn').attr(\"title\", `${ctrl_label}+P`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+p\",\n\t\t\taction: () => this.$summary_container.find('.print-btn').click(),\n\t\t\tcondition: () => this.$component.is(':visible') && this.$summary_container.find('.print-btn').is(\":visible\"),\n\t\t\tdescription: __(\"Print Receipt\"),\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t\tthis.$summary_container.find('.new-btn').attr(\"title\", `${ctrl_label}+Enter`);\n\t\tfrappe.ui.keys.on(\"ctrl+enter\", () => {\n\t\t\tconst summary_is_visible = this.$component.is(\":visible\");\n\t\t\tif (summary_is_visible && this.$summary_container.find('.new-btn').is(\":visible\")) {\n\t\t\t\tthis.$summary_container.find('.new-btn').click();\n\t\t\t}\n\t\t});\n\t\tthis.$summary_container.find('.edit-btn').attr(\"title\", `${ctrl_label}+E`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+e\",\n\t\t\taction: () => this.$summary_container.find('.edit-btn').click(),\n\t\t\tcondition: () => this.$component.is(':visible') && this.$summary_container.find('.edit-btn').is(\":visible\"),\n\t\t\tdescription: __(\"Edit Receipt\"),\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t}\n\n\tsend_email() {\n\t\tconst frm = this.events.get_frm();\n\t\tconst recipients = this.email_dialog.get_values().email_id;\n\t\tconst doc = this.doc || frm.doc;\n\t\tconst print_format = frm.pos_print_format;\n\n\t\tfrappe.call({\n\t\t\tmethod: \"frappe.core.doctype.communication.email.make\",\n\t\t\targs: {\n\t\t\t\trecipients: recipients,\n\t\t\t\tsubject: __(frm.meta.name) + ': ' + doc.name,\n\t\t\t\tdoctype: doc.doctype,\n\t\t\t\tname: doc.name,\n\t\t\t\tsend_email: 1,\n\t\t\t\tprint_format,\n\t\t\t\tsender_full_name: frappe.user.full_name(),\n\t\t\t\t_lang: doc.language\n\t\t\t},\n\t\t\tcallback: r => {\n\t\t\t\tif (!r.exc) {\n\t\t\t\t\tfrappe.utils.play_sound(\"email\");\n\t\t\t\t\tif (r.message[\"emails_not_sent_to\"]) {\n\t\t\t\t\t\tfrappe.msgprint(__(\n\t\t\t\t\t\t\t\"Email not sent to {0} (unsubscribed / disabled)\",\n\t\t\t\t\t\t\t[ frappe.utils.escape_html(r.message[\"emails_not_sent_to\"]) ]\n\t\t\t\t\t\t));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\tmessage: __('Email sent successfully.'),\n\t\t\t\t\t\t\tindicator: 'green'\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tthis.email_dialog.hide();\n\t\t\t\t} else {\n\t\t\t\t\tfrappe.msgprint(__(\"There were errors while sending email. Please try again.\"));\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tadd_summary_btns(map) {\n\t\tthis.$summary_btns.html('');\n\t\tmap.forEach(m => {\n\t\t\tif (m.condition) {\n\t\t\t\tm.visible_btns.forEach(b => {\n\t\t\t\t\tconst class_name = b.split(' ')[0].toLowerCase();\n\t\t\t\t\tthis.$summary_btns.append(\n\t\t\t\t\t\t`<div class=\"summary-btn btn btn-default ${class_name}-btn\">${b}</div>`\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t\tthis.$summary_btns.children().last().removeClass('mr-4');\n\t}\n\n\ttoggle_summary_placeholder(show) {\n\t\tif (show) {\n\t\t\tthis.$summary_wrapper.css('display', 'none');\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'flex');\n\t\t} else {\n\t\t\tthis.$summary_wrapper.css('display', 'flex');\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'none');\n\t\t}\n\t}\n\n\tget_condition_btn_map(after_submission) {\n\t\tif (after_submission)\n\t\t\treturn [{ condition: true, visible_btns: ['Print Receipt', 'Email Receipt', 'New Order'] }];\n\n\t\treturn [\n\t\t\t{ condition: this.doc.docstatus === 0, visible_btns: ['Edit Order', 'Delete Order'] },\n\t\t\t{ condition: !this.doc.is_return && this.doc.docstatus === 1, visible_btns: ['Print Receipt', 'Email Receipt', 'Return']},\n\t\t\t{ condition: this.doc.is_return && this.doc.docstatus === 1, visible_btns: ['Print Receipt', 'Email Receipt']}\n\t\t];\n\t}\n\n\tload_summary_of(doc, after_submission=false) {\n\t\tafter_submission ?\n\t\t\tthis.$component.css('grid-column', 'span 10 / span 10') :\n\t\t\tthis.$component.css('grid-column', 'span 6 / span 6');\n\n\t\tthis.toggle_summary_placeholder(false);\n\n\t\tthis.doc = doc;\n\n\t\tthis.attach_document_info(doc);\n\n\t\tthis.attach_items_info(doc);\n\n\t\tthis.attach_totals_info(doc);\n\n\t\tthis.attach_payments_info(doc);\n\n\t\tconst condition_btns_map = this.get_condition_btn_map(after_submission);\n\n\t\tthis.add_summary_btns(condition_btns_map);\n\t}\n\n\tattach_document_info(doc) {\n\t\tfrappe.db.get_value('Customer', this.doc.customer, 'email_id').then(({ message }) => {\n\t\t\tthis.customer_email = message.email_id || '';\n\t\t\tconst upper_section_dom = this.get_upper_section_html(doc);\n\t\t\tthis.$upper_section.html(upper_section_dom);\n\t\t});\n\t}\n\n\tattach_items_info(doc) {\n\t\tthis.$items_container.html('');\n\t\tdoc.items.forEach(item => {\n\t\t\tconst item_dom = this.get_item_html(doc, item);\n\t\t\tthis.$items_container.append(item_dom);\n\t\t\tthis.set_dynamic_rate_header_width();\n\t\t});\n\t}\n\n\tset_dynamic_rate_header_width() {\n\t\tconst rate_cols = Array.from(this.$items_container.find(\".item-rate-disc\"));\n\t\tthis.$items_container.find(\".item-rate-disc\").css(\"width\", \"\");\n\t\tlet max_width = rate_cols.reduce((max_width, elm) => {\n\t\t\tif ($(elm).width() > max_width)\n\t\t\t\tmax_width = $(elm).width();\n\t\t\treturn max_width;\n\t\t}, 0);\n\n\t\tmax_width += 1;\n\t\tif (max_width == 1) max_width = \"\";\n\n\t\tthis.$items_container.find(\".item-rate-disc\").css(\"width\", max_width);\n\t}\n\n\tattach_payments_info(doc) {\n\t\tthis.$payment_container.html('');\n\t\tdoc.payments.forEach(p => {\n\t\t\tif (p.amount) {\n\t\t\t\tconst payment_dom = this.get_payment_html(doc, p);\n\t\t\t\tthis.$payment_container.append(payment_dom);\n\t\t\t}\n\t\t});\n\t\tif (doc.redeem_loyalty_points && doc.loyalty_amount) {\n\t\t\tconst payment_dom = this.get_payment_html(doc, {\n\t\t\t\tmode_of_payment: 'Loyalty Points',\n\t\t\t\tamount: doc.loyalty_amount,\n\t\t\t});\n\t\t\tthis.$payment_container.append(payment_dom);\n\t\t}\n\t}\n\n\tattach_totals_info(doc) {\n\t\tthis.$totals_container.html('');\n\n\t\tconst net_total_dom = this.get_net_total_html(doc);\n\t\tconst taxes_dom = this.get_taxes_html(doc);\n\t\tconst discount_dom = this.get_discount_html(doc);\n\t\tconst grand_total_dom = this.get_grand_total_html(doc);\n\t\tthis.$totals_container.append(net_total_dom);\n\t\tthis.$totals_container.append(taxes_dom);\n\t\tthis.$totals_container.append(discount_dom);\n\t\tthis.$totals_container.append(grand_total_dom);\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\n\t}\n};\n","erpnext.PointOfSale.Controller = class {\n\tconstructor(wrapper) {\n\t\tthis.wrapper = $(wrapper).find('.layout-main-section');\n\t\tthis.page = wrapper.page;\n\n\t\tthis.check_opening_entry();\n\t}\n\n\tfetch_opening_entry() {\n\t\treturn frappe.call(\"erpnext.selling.page.point_of_sale.point_of_sale.check_opening_entry\", { \"user\": frappe.session.user });\n\t}\n\n\tcheck_opening_entry() {\n\t\tthis.fetch_opening_entry().then((r) => {\n\t\t\tif (r.message.length) {\n\t\t\t\t// assuming only one opening voucher is available for the current user\n\t\t\t\tthis.prepare_app_defaults(r.message[0]);\n\t\t\t} else {\n\t\t\t\tthis.create_opening_voucher();\n\t\t\t}\n\t\t});\n\t}\n\n\tcreate_opening_voucher() {\n\t\tconst me = this;\n\t\tconst table_fields = [\n\t\t\t{\n\t\t\t\tfieldname: \"mode_of_payment\", fieldtype: \"Link\",\n\t\t\t\tin_list_view: 1, label: \"Mode of Payment\",\n\t\t\t\toptions: \"Mode of Payment\", reqd: 1\n\t\t\t},\n\t\t\t{\n\t\t\t\tfieldname: \"opening_amount\", fieldtype: \"Currency\",\n\t\t\t\tin_list_view: 1, label: \"Opening Amount\",\n\t\t\t\toptions: \"company:company_currency\",\n\t\t\t\tchange: function () {\n\t\t\t\t\tdialog.fields_dict.balance_details.df.data.some(d => {\n\t\t\t\t\t\tif (d.idx == this.doc.idx) {\n\t\t\t\t\t\t\td.opening_amount = this.value;\n\t\t\t\t\t\t\tdialog.fields_dict.balance_details.grid.refresh();\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t];\n\t\tconst fetch_pos_payment_methods = () => {\n\t\t\tconst pos_profile = dialog.fields_dict.pos_profile.get_value();\n\t\t\tif (!pos_profile) return;\n\t\t\tfrappe.db.get_doc(\"POS Profile\", pos_profile).then(({ payments }) => {\n\t\t\t\tdialog.fields_dict.balance_details.df.data = [];\n\t\t\t\tpayments.forEach(pay => {\n\t\t\t\t\tconst { mode_of_payment } = pay;\n\t\t\t\t\tdialog.fields_dict.balance_details.df.data.push({ mode_of_payment, opening_amount: '0' });\n\t\t\t\t});\n\t\t\t\tdialog.fields_dict.balance_details.grid.refresh();\n\t\t\t});\n\t\t}\n\t\tconst dialog = new frappe.ui.Dialog({\n\t\t\ttitle: __('Create POS Opening Entry'),\n\t\t\tstatic: true,\n\t\t\tfields: [\n\t\t\t\t{\n\t\t\t\t\tfieldtype: 'Link', label: __('Company'), default: frappe.defaults.get_default('company'),\n\t\t\t\t\toptions: 'Company', fieldname: 'company', reqd: 1\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tfieldtype: 'Link', label: __('POS Profile'),\n\t\t\t\t\toptions: 'POS Profile', fieldname: 'pos_profile', reqd: 1,\n\t\t\t\t\tget_query: () => pos_profile_query,\n\t\t\t\t\tonchange: () => fetch_pos_payment_methods()\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tfieldname: \"balance_details\",\n\t\t\t\t\tfieldtype: \"Table\",\n\t\t\t\t\tlabel: \"Opening Balance Details\",\n\t\t\t\t\tcannot_add_rows: false,\n\t\t\t\t\tin_place_edit: true,\n\t\t\t\t\treqd: 1,\n\t\t\t\t\tdata: [],\n\t\t\t\t\tfields: table_fields\n\t\t\t\t}\n\t\t\t],\n\t\t\tprimary_action: async function({ company, pos_profile, balance_details }) {\n\t\t\t\tif (!balance_details.length) {\n\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\tmessage: __(\"Please add Mode of payments and opening balance details.\"),\n\t\t\t\t\t\tindicator: 'red'\n\t\t\t\t\t})\n\t\t\t\t\treturn frappe.utils.play_sound(\"error\");\n\t\t\t\t}\n\n\t\t\t\t// filter balance details for empty rows\n\t\t\t\tbalance_details = balance_details.filter(d => d.mode_of_payment);\n\n\t\t\t\tconst method = \"erpnext.selling.page.point_of_sale.point_of_sale.create_opening_voucher\";\n\t\t\t\tconst res = await frappe.call({ method, args: { pos_profile, company, balance_details }, freeze:true });\n\t\t\t\t!res.exc && me.prepare_app_defaults(res.message);\n\t\t\t\tdialog.hide();\n\t\t\t},\n\t\t\tprimary_action_label: __('Submit')\n\t\t});\n\t\tdialog.show();\n\t\tconst pos_profile_query = {\n\t\t\tquery: 'erpnext.accounts.doctype.pos_profile.pos_profile.pos_profile_query',\n\t\t\tfilters: { company: dialog.fields_dict.company.get_value() }\n\t\t};\n\t}\n\n\tasync prepare_app_defaults(data) {\n\t\tthis.pos_opening = data.name;\n\t\tthis.company = data.company;\n\t\tthis.pos_profile = data.pos_profile;\n\t\tthis.pos_opening_time = data.period_start_date;\n\t\tthis.item_stock_map = {};\n\t\tthis.settings = {};\n\n\t\tfrappe.db.get_value('Stock Settings', undefined, 'allow_negative_stock').then(({ message }) => {\n\t\t\tthis.allow_negative_stock = flt(message.allow_negative_stock) || false;\n\t\t});\n\n\t\tfrappe.db.get_doc(\"POS Profile\", this.pos_profile).then((profile) => {\n\t\t\tObject.assign(this.settings, profile);\n\t\t\tthis.settings.customer_groups = profile.customer_groups.map(group => group.customer_group);\n\t\t\tthis.make_app();\n\t\t});\n\t}\n\n\tset_opening_entry_status() {\n\t\tthis.page.set_title_sub(\n\t\t\t`<span class=\"indicator orange\">\n\t\t\t\t<a class=\"text-muted\" href=\"#Form/POS%20Opening%20Entry/${this.pos_opening}\">\n\t\t\t\t\tOpened at ${moment(this.pos_opening_time).format(\"Do MMMM, h:mma\")}\n\t\t\t\t</a>\n\t\t\t</span>`);\n\t}\n\n\tmake_app() {\n\t\tthis.prepare_dom();\n\t\tthis.prepare_components();\n\t\tthis.prepare_menu();\n\t\tthis.make_new_invoice();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<div class=\"point-of-sale-app\"></div>`\n\t\t);\n\n\t\tthis.$components_wrapper = this.wrapper.find('.point-of-sale-app');\n\t}\n\n\tprepare_components() {\n\t\tthis.init_item_selector();\n\t\tthis.init_item_details();\n\t\tthis.init_item_cart();\n\t\tthis.init_payments();\n\t\tthis.init_recent_order_list();\n\t\tthis.init_order_summary();\n\t}\n\n\tprepare_menu() {\n\t\tthis.page.clear_menu();\n\n\t\tthis.page.add_menu_item(__(\"Open Form View\"), this.open_form_view.bind(this), false, 'Ctrl+F');\n\n\t\tthis.page.add_menu_item(__(\"Toggle Recent Orders\"), this.toggle_recent_order.bind(this), false, 'Ctrl+O');\n\n\t\tthis.page.add_menu_item(__(\"Save as Draft\"), this.save_draft_invoice.bind(this), false, 'Ctrl+S');\n\n\t\tthis.page.add_menu_item(__('Close the POS'), this.close_pos.bind(this), false, 'Shift+Ctrl+C');\n\t}\n\n\topen_form_view() {\n\t\tfrappe.model.sync(this.frm.doc);\n\t\tfrappe.set_route(\"Form\", this.frm.doc.doctype, this.frm.doc.name);\n\t}\n\n\ttoggle_recent_order() {\n\t\tconst show = this.recent_order_list.$component.is(':hidden');\n\t\tthis.toggle_recent_order_list(show);\n\t}\n\n\tsave_draft_invoice() {\n\t\tif (!this.$components_wrapper.is(\":visible\")) return;\n\n\t\tif (this.frm.doc.items.length == 0) {\n\t\t\tfrappe.show_alert({\n\t\t\t\tmessage: __(\"You must add atleast one item to save it as draft.\"),\n\t\t\t\tindicator:'red'\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\treturn;\n\t\t}\n\n\t\tthis.frm.save(undefined, undefined, undefined, () => {\n\t\t\tfrappe.show_alert({\n\t\t\t\tmessage: __(\"There was an error saving the document.\"),\n\t\t\t\tindicator: 'red'\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t}).then(() => {\n\t\t\tfrappe.run_serially([\n\t\t\t\t() => frappe.dom.freeze(),\n\t\t\t\t() => this.make_new_invoice(),\n\t\t\t\t() => frappe.dom.unfreeze(),\n\t\t\t]);\n\t\t});\n\t}\n\n\tclose_pos() {\n\t\tif (!this.$components_wrapper.is(\":visible\")) return;\n\n\t\tlet voucher = frappe.model.get_new_doc('POS Closing Entry');\n\t\tvoucher.pos_profile = this.frm.doc.pos_profile;\n\t\tvoucher.user = frappe.session.user;\n\t\tvoucher.company = this.frm.doc.company;\n\t\tvoucher.pos_opening_entry = this.pos_opening;\n\t\tvoucher.period_end_date = frappe.datetime.now_datetime();\n\t\tvoucher.posting_date = frappe.datetime.now_date();\n\t\tfrappe.set_route('Form', 'POS Closing Entry', voucher.name);\n\t}\n\n\tinit_item_selector() {\n\t\tthis.item_selector = new erpnext.PointOfSale.ItemSelector({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tpos_profile: this.pos_profile,\n\t\t\tsettings: this.settings,\n\t\t\tevents: {\n\t\t\t\titem_selected: args => this.on_cart_update(args),\n\n\t\t\t\tget_frm: () => this.frm || {}\n\t\t\t}\n\t\t})\n\t}\n\n\tinit_item_cart() {\n\t\tthis.cart = new erpnext.PointOfSale.ItemCart({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tsettings: this.settings,\n\t\t\tevents: {\n\t\t\t\tget_frm: () => this.frm,\n\n\t\t\t\tcart_item_clicked: (item) => {\n\t\t\t\t\tconst item_row = this.get_item_from_frm(item);\n\t\t\t\t\tthis.item_details.toggle_item_details_section(item_row);\n\t\t\t\t},\n\n\t\t\t\tnumpad_event: (value, action) => this.update_item_field(value, action),\n\n\t\t\t\tcheckout: () => this.payment.checkout(),\n\n\t\t\t\tedit_cart: () => this.payment.edit_cart(),\n\n\t\t\t\tcustomer_details_updated: (details) => {\n\t\t\t\t\tthis.customer_details = details;\n\t\t\t\t\t// will add/remove LP payment method\n\t\t\t\t\tthis.payment.render_loyalty_points_payment_mode();\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t}\n\n\tinit_item_details() {\n\t\tthis.item_details = new erpnext.PointOfSale.ItemDetails({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tsettings: this.settings,\n\t\t\tevents: {\n\t\t\t\tget_frm: () => this.frm,\n\n\t\t\t\ttoggle_item_selector: (minimize) => {\n\t\t\t\t\tthis.item_selector.resize_selector(minimize);\n\t\t\t\t\tthis.cart.toggle_numpad(minimize);\n\t\t\t\t},\n\n\t\t\t\tform_updated: (item, field, value) => {\n\t\t\t\t\tconst item_row = frappe.model.get_doc(item.doctype, item.name);\n\t\t\t\t\tif (item_row && item_row[field] != value) {\n\t\t\t\t\t\tconst args = {\n\t\t\t\t\t\t\tfield,\n\t\t\t\t\t\t\tvalue,\n\t\t\t\t\t\t\titem: this.item_details.current_item\n\t\t\t\t\t\t};\n\t\t\t\t\t\treturn this.on_cart_update(args);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t},\n\n\t\t\t\thighlight_cart_item: (item) => {\n\t\t\t\t\tconst cart_item = this.cart.get_cart_item(item);\n\t\t\t\t\tthis.cart.toggle_item_highlight(cart_item);\n\t\t\t\t},\n\n\t\t\t\titem_field_focused: (fieldname) => {\n\t\t\t\t\tthis.cart.toggle_numpad_field_edit(fieldname);\n\t\t\t\t},\n\t\t\t\tset_value_in_current_cart_item: (selector, value) => {\n\t\t\t\t\tthis.cart.update_selector_value_in_cart_item(selector, value, this.item_details.current_item);\n\t\t\t\t},\n\t\t\t\tclone_new_batch_item_in_frm: (batch_serial_map, item) => {\n\t\t\t\t\t// called if serial nos are 'auto_selected' and if those serial nos belongs to multiple batches\n\t\t\t\t\t// for each unique batch new item row is added in the form & cart\n\t\t\t\t\tObject.keys(batch_serial_map).forEach(batch => {\n\t\t\t\t\t\tconst item_to_clone = this.frm.doc.items.find(i => i.name == item.name);\n\t\t\t\t\t\tconst new_row = this.frm.add_child(\"items\", { ...item_to_clone });\n\t\t\t\t\t\t// update new serialno and batch\n\t\t\t\t\t\tnew_row.batch_no = batch;\n\t\t\t\t\t\tnew_row.serial_no = batch_serial_map[batch].join(`\\n`);\n\t\t\t\t\t\tnew_row.qty = batch_serial_map[batch].length;\n\t\t\t\t\t\tthis.frm.doc.items.forEach(row => {\n\t\t\t\t\t\t\tif (item.item_code === row.item_code) {\n\t\t\t\t\t\t\t\tthis.update_cart_html(row);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t},\n\t\t\t\tremove_item_from_cart: () => this.remove_item_from_cart(),\n\t\t\t\tget_item_stock_map: () => this.item_stock_map,\n\t\t\t\tclose_item_details: () => {\n\t\t\t\t\tthis.item_details.toggle_item_details_section(null);\n\t\t\t\t\tthis.cart.prev_action = null;\n\t\t\t\t\tthis.cart.toggle_item_highlight();\n\t\t\t\t},\n\t\t\t\tget_available_stock: (item_code, warehouse) => this.get_available_stock(item_code, warehouse)\n\t\t\t}\n\t\t});\n\t}\n\n\tinit_payments() {\n\t\tthis.payment = new erpnext.PointOfSale.Payment({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tevents: {\n\t\t\t\tget_frm: () => this.frm || {},\n\n\t\t\t\tget_customer_details: () => this.customer_details || {},\n\n\t\t\t\ttoggle_other_sections: (show) => {\n\t\t\t\t\tif (show) {\n\t\t\t\t\t\tthis.item_details.$component.is(':visible') ? this.item_details.$component.css('display', 'none') : '';\n\t\t\t\t\t\tthis.item_selector.$component.css('display', 'none');\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.item_selector.$component.css('display', 'flex');\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\tsubmit_invoice: () => {\n\t\t\t\t\tthis.frm.savesubmit()\n\t\t\t\t\t\t.then((r) => {\n\t\t\t\t\t\t\tthis.toggle_components(false);\n\t\t\t\t\t\t\tthis.order_summary.toggle_component(true);\n\t\t\t\t\t\t\tthis.order_summary.load_summary_of(this.frm.doc, true);\n\t\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\t\tindicator: 'green',\n\t\t\t\t\t\t\t\tmessage: __('POS invoice {0} created succesfully', [r.doc.name])\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tinit_recent_order_list() {\n\t\tthis.recent_order_list = new erpnext.PointOfSale.PastOrderList({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tevents: {\n\t\t\t\topen_invoice_data: (name) => {\n\t\t\t\t\tfrappe.db.get_doc('POS Invoice', name).then((doc) => {\n\t\t\t\t\t\tthis.order_summary.load_summary_of(doc);\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\treset_summary: () => this.order_summary.toggle_summary_placeholder(true)\n\t\t\t}\n\t\t})\n\t}\n\n\tinit_order_summary() {\n\t\tthis.order_summary = new erpnext.PointOfSale.PastOrderSummary({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tevents: {\n\t\t\t\tget_frm: () => this.frm,\n\n\t\t\t\tprocess_return: (name) => {\n\t\t\t\t\tthis.recent_order_list.toggle_component(false);\n\t\t\t\t\tfrappe.db.get_doc('POS Invoice', name).then((doc) => {\n\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t() => this.make_return_invoice(doc),\n\t\t\t\t\t\t\t() => this.cart.load_invoice(),\n\t\t\t\t\t\t\t() => this.item_selector.toggle_component(true)\n\t\t\t\t\t\t]);\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tedit_order: (name) => {\n\t\t\t\t\tthis.recent_order_list.toggle_component(false);\n\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t() => this.frm.refresh(name),\n\t\t\t\t\t\t() => this.frm.call('reset_mode_of_payments'),\n\t\t\t\t\t\t() => this.cart.load_invoice(),\n\t\t\t\t\t\t() => this.item_selector.toggle_component(true)\n\t\t\t\t\t]);\n\t\t\t\t},\n\t\t\t\tdelete_order: (name) => {\n\t\t\t\t\tfrappe.model.delete_doc(this.frm.doc.doctype, name, () => {\n\t\t\t\t\t\tthis.recent_order_list.refresh_list();\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tnew_order: () => {\n\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t() => frappe.dom.freeze(),\n\t\t\t\t\t\t() => this.make_new_invoice(),\n\t\t\t\t\t\t() => this.item_selector.toggle_component(true),\n\t\t\t\t\t\t() => frappe.dom.unfreeze(),\n\t\t\t\t\t]);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t}\n\n\ttoggle_recent_order_list(show) {\n\t\tthis.toggle_components(!show);\n\t\tthis.recent_order_list.toggle_component(show);\n\t\tthis.order_summary.toggle_component(show);\n\t}\n\n\ttoggle_components(show) {\n\t\tthis.cart.toggle_component(show);\n\t\tthis.item_selector.toggle_component(show);\n\n\t\t// do not show item details or payment if recent order is toggled off\n\t\t!show ? (this.item_details.toggle_component(false) || this.payment.toggle_component(false)) : '';\n\t}\n\n\tmake_new_invoice() {\n\t\treturn frappe.run_serially([\n\t\t\t() => frappe.dom.freeze(),\n\t\t\t() => this.make_sales_invoice_frm(),\n\t\t\t() => this.set_pos_profile_data(),\n\t\t\t() => this.set_pos_profile_status(),\n\t\t\t() => this.cart.load_invoice(),\n\t\t\t() => frappe.dom.unfreeze()\n\t\t]);\n\t}\n\n\tmake_sales_invoice_frm() {\n\t\tconst doctype = 'POS Invoice';\n\t\treturn new Promise(resolve => {\n\t\t\tif (this.frm) {\n\t\t\t\tthis.frm = this.get_new_frm(this.frm);\n\t\t\t\tthis.frm.doc.items = [];\n\t\t\t\tthis.frm.doc.is_pos = 1\n\t\t\t\tresolve();\n\t\t\t} else {\n\t\t\t\tfrappe.model.with_doctype(doctype, () => {\n\t\t\t\t\tthis.frm = this.get_new_frm();\n\t\t\t\t\tthis.frm.doc.items = [];\n\t\t\t\t\tthis.frm.doc.is_pos = 1\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tget_new_frm(_frm) {\n\t\tconst doctype = 'POS Invoice';\n\t\tconst page = $('<div>');\n\t\tconst frm = _frm || new frappe.ui.form.Form(doctype, page, false);\n\t\tconst name = frappe.model.make_new_doc_and_get_name(doctype, true);\n\t\tfrm.refresh(name);\n\n\t\treturn frm;\n\t}\n\n\tasync make_return_invoice(doc) {\n\t\tfrappe.dom.freeze();\n\t\tthis.frm = this.get_new_frm(this.frm);\n\t\tthis.frm.doc.items = [];\n\t\tconst res = await frappe.call({\n\t\t\tmethod: \"erpnext.accounts.doctype.pos_invoice.pos_invoice.make_sales_return\",\n\t\t\targs: {\n\t\t\t\t'source_name': doc.name,\n\t\t\t\t'target_doc': this.frm.doc\n\t\t\t}\n\t\t});\n\t\tfrappe.model.sync(res.message);\n\t\tawait this.set_pos_profile_data();\n\t\tfrappe.dom.unfreeze();\n\t}\n\n\tset_pos_profile_data() {\n\t\tif (this.company && !this.frm.doc.company) this.frm.doc.company = this.company;\n\t\tif (this.pos_profile && !this.frm.doc.pos_profile) this.frm.doc.pos_profile = this.pos_profile;\n\t\tif (!this.frm.doc.company) return;\n\n\t\treturn this.frm.trigger(\"set_pos_data\");\n\t}\n\n\tset_pos_profile_status() {\n\t\tthis.page.set_indicator(this.pos_profile, \"blue\");\n\t}\n\n\tasync on_cart_update(args) {\n\t\tfrappe.dom.freeze();\n\t\tlet item_row = undefined;\n\t\ttry {\n\t\t\tlet { field, value, item } = args;\n\t\t\titem_row = this.get_item_from_frm(item);\n\t\t\tconst item_row_exists = !$.isEmptyObject(item_row);\n\n\t\t\tconst from_selector = field === 'qty' && value === \"+1\";\n\t\t\tif (from_selector)\n\t\t\t\tvalue = flt(item_row.qty) + flt(value);\n\n\t\t\tif (item_row_exists) {\n\t\t\t\tif (field === 'qty')\n\t\t\t\t\tvalue = flt(value);\n\n\t\t\t\tif (['qty', 'conversion_factor'].includes(field) && value > 0 && !this.allow_negative_stock) {\n\t\t\t\t\tconst qty_needed = field === 'qty' ? value * item_row.conversion_factor : item_row.qty * value;\n\t\t\t\t\tawait this.check_stock_availability(item_row, qty_needed, this.frm.doc.set_warehouse);\n\t\t\t\t}\n\n\t\t\t\tif (this.is_current_item_being_edited(item_row) || from_selector) {\n\t\t\t\t\tawait frappe.model.set_value(item_row.doctype, item_row.name, field, value);\n\t\t\t\t\tthis.update_cart_html(item_row);\n\t\t\t\t}\n\n\t\t\t} else {\n\t\t\t\tif (!this.frm.doc.customer)\n\t\t\t\t\treturn this.raise_customer_selection_alert();\n\n\t\t\t\tconst { item_code, batch_no, serial_no, rate } = item;\n\n\t\t\t\tif (!item_code)\n\t\t\t\t\treturn;\n\n\t\t\t\tconst new_item = { item_code, batch_no, rate, [field]: value };\n\n\t\t\t\tif (serial_no) {\n\t\t\t\t\tawait this.check_serial_no_availablilty(item_code, this.frm.doc.set_warehouse, serial_no);\n\t\t\t\t\tnew_item['serial_no'] = serial_no;\n\t\t\t\t}\n\n\t\t\t\tif (field === 'serial_no')\n\t\t\t\t\tnew_item['qty'] = value.split(`\\n`).length || 0;\n\n\t\t\t\titem_row = this.frm.add_child('items', new_item);\n\n\t\t\t\tif (field === 'qty' && value !== 0 && !this.allow_negative_stock)\n\t\t\t\t\tawait this.check_stock_availability(item_row, value, this.frm.doc.set_warehouse);\n\n\t\t\t\tawait this.trigger_new_item_events(item_row);\n\n\t\t\t\tthis.update_cart_html(item_row);\n\n\t\t\t\tif (this.item_details.$component.is(':visible'))\n\t\t\t\t\tthis.edit_item_details_of(item_row);\n\n\t\t\t\tif (this.check_serial_batch_selection_needed(item_row))\n\t\t\t\t\tthis.edit_item_details_of(item_row);\n\t\t\t}\n\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t} finally {\n\t\t\tfrappe.dom.unfreeze();\n\t\t\treturn item_row;\n\t\t}\n\t}\n\n\traise_customer_selection_alert() {\n\t\tfrappe.dom.unfreeze();\n\t\tfrappe.show_alert({\n\t\t\tmessage: __('You must select a customer before adding an item.'),\n\t\t\tindicator: 'orange'\n\t\t});\n\t\tfrappe.utils.play_sound(\"error\");\n\t}\n\n\tget_item_from_frm({ name, item_code, batch_no, uom, rate }) {\n\t\tlet item_row = null;\n\t\tif (name) {\n\t\t\titem_row = this.frm.doc.items.find(i => i.name == name);\n\t\t} else {\n\t\t\t// if item is clicked twice from item selector\n\t\t\t// then \"item_code, batch_no, uom, rate\" will help in getting the exact item\n\t\t\t// to increase the qty by one\n\t\t\tconst has_batch_no = batch_no;\n\t\t\titem_row = this.frm.doc.items.find(\n\t\t\t\ti => i.item_code === item_code\n\t\t\t\t\t&& (!has_batch_no || (has_batch_no && i.batch_no === batch_no))\n\t\t\t\t\t&& (i.uom === uom)\n\t\t\t\t\t&& (i.rate == rate)\n\t\t\t);\n\t\t}\n\n\t\treturn item_row || {};\n\t}\n\n\tedit_item_details_of(item_row) {\n\t\tthis.item_details.toggle_item_details_section(item_row);\n\t}\n\n\tis_current_item_being_edited(item_row) {\n\t\treturn item_row.name == this.item_details.current_item.name;\n\t}\n\n\tupdate_cart_html(item_row, remove_item) {\n\t\tthis.cart.update_item_html(item_row, remove_item);\n\t\tthis.cart.update_totals_section(this.frm);\n\t}\n\n\tcheck_serial_batch_selection_needed(item_row) {\n\t\t// right now item details is shown for every type of item.\n\t\t// if item details is not shown for every item then this fn will be needed\n\t\tconst serialized = item_row.has_serial_no;\n\t\tconst batched = item_row.has_batch_no;\n\t\tconst no_serial_selected = !item_row.serial_no;\n\t\tconst no_batch_selected = !item_row.batch_no;\n\n\t\tif ((serialized && no_serial_selected) || (batched && no_batch_selected) ||\n\t\t\t(serialized && batched && (no_batch_selected || no_serial_selected))) {\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tasync trigger_new_item_events(item_row) {\n\t\tawait this.frm.script_manager.trigger('item_code', item_row.doctype, item_row.name);\n\t\tawait this.frm.script_manager.trigger('qty', item_row.doctype, item_row.name);\n\t}\n\n\tasync check_stock_availability(item_row, qty_needed, warehouse) {\n\t\tconst available_qty = (await this.get_available_stock(item_row.item_code, warehouse)).message;\n\n\t\tfrappe.dom.unfreeze();\n\t\tconst bold_item_code = item_row.item_code.bold();\n\t\tconst bold_warehouse = warehouse.bold();\n\t\tconst bold_available_qty = available_qty.toString().bold()\n\t\tif (!(available_qty > 0)) {\n\t\t\tfrappe.model.clear_doc(item_row.doctype, item_row.name);\n\t\t\tfrappe.throw({\n\t\t\t\ttitle: __(\"Not Available\"),\n\t\t\t\tmessage: __('Item Code: {0} is not available under warehouse {1}.', [bold_item_code, bold_warehouse])\n\t\t\t})\n\t\t} else if (available_qty < qty_needed) {\n\t\t\tfrappe.show_alert({\n\t\t\t\tmessage: __('Stock quantity not enough for Item Code: {0} under warehouse {1}. Available quantity {2}.', [bold_item_code, bold_warehouse, bold_available_qty]),\n\t\t\t\tindicator: 'orange'\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t}\n\t\tfrappe.dom.freeze();\n\t}\n\n\tasync check_serial_no_availablilty(item_code, warehouse, serial_no) {\n\t\tconst method = \"erpnext.stock.doctype.serial_no.serial_no.get_pos_reserved_serial_nos\";\n\t\tconst args = {filters: { item_code, warehouse }}\n\t\tconst res = await frappe.call({ method, args });\n\n\t\tif (res.message.includes(serial_no)) {\n\t\t\tfrappe.throw({\n\t\t\t\ttitle: __(\"Not Available\"),\n\t\t\t\tmessage: __('Serial No: {0} has already been transacted into another POS Invoice.', [serial_no.bold()])\n\t\t\t});\n\t\t}\n\t}\n\n\tget_available_stock(item_code, warehouse) {\n\t\tconst me = this;\n\t\treturn frappe.call({\n\t\t\tmethod: \"erpnext.accounts.doctype.pos_invoice.pos_invoice.get_stock_availability\",\n\t\t\targs: {\n\t\t\t\t'item_code': item_code,\n\t\t\t\t'warehouse': warehouse,\n\t\t\t},\n\t\t\tcallback(res) {\n\t\t\t\tif (!me.item_stock_map[item_code])\n\t\t\t\t\tme.item_stock_map[item_code] = {}\n\t\t\t\tme.item_stock_map[item_code][warehouse] = res.message;\n\t\t\t}\n\t\t});\n\t}\n\n\tupdate_item_field(value, field_or_action) {\n\t\tif (field_or_action === 'checkout') {\n\t\t\tthis.item_details.toggle_item_details_section(null);\n\t\t} else if (field_or_action === 'remove') {\n\t\t\tthis.remove_item_from_cart();\n\t\t} else {\n\t\t\tconst field_control = this.item_details[`${field_or_action}_control`];\n\t\t\tif (!field_control) return;\n\t\t\tfield_control.set_focus();\n\t\t\tvalue != \"\" && field_control.set_value(value);\n\t\t}\n\t}\n\n\tremove_item_from_cart() {\n\t\tfrappe.dom.freeze();\n\t\tconst { doctype, name, current_item } = this.item_details;\n\n\t\tfrappe.model.set_value(doctype, name, 'qty', 0)\n\t\t\t.then(() => {\n\t\t\t\tfrappe.model.clear_doc(doctype, name);\n\t\t\t\tthis.update_cart_html(current_item, true);\n\t\t\t\tthis.item_details.toggle_item_details_section(null);\n\t\t\t\tfrappe.dom.unfreeze();\n\t\t\t})\n\t\t\t.catch(e => console.log(e));\n\t}\n};\n"],"names":["onScan","module","attachTo","oDomElement","oOptions","undefined","scannerDetectionData","Error","oDefaults","sScanned","iQty","onScanError","oDebug","onKeyProcess","sChar","oEvent","onKeyDetect","iKeyCode","onPaste","sPasted","keyCodeMapper","decodeKeyEvent","onScanButtonLongPress","scanButtonKeyCode","scanButtonLongPressTime","timeBeforeScanTest","avgTimeByChar","minLength","suffixKeyCodes","prefixKeyCodes","ignoreIfFocusOn","stopPropagation","preventDefault","captureEvents","reactToKeydown","reactToPaste","singleScanQty","this","_mergeOptions","options","vars","firstCharTime","lastCharTime","accumulatedString","testTimer","longPressTimeStart","longPressed","addEventListener","_handlePaste","_handleKeyUp","_handleKeyDown","detachFrom","removeEventListener","getOptions","setOptions","_reinitialize","iCode","_getNormalizedKeyNum","key","sDecoded","String","fromCharCode","shiftKey","toLowerCase","toUpperCase","simulate","mStringOrArray","Array","isArray","forEach","mKey","oEventProps","keyCode","parseInt","KeyboardEvent","document","dispatchEvent","_validateScanCode","oVars","_isFocusOnIgnoredElement","ignoreSelectors","oFocused","activeElement","i","length","matches","sScanCode","oScannerData","iSingleScanQty","iFirstCharTime","iLastCharTime","oScanError","message","call","CustomEvent","detail","scanCode","qty","scanDuration","prop","oExtended","Object","prototype","hasOwnProperty","e","which","bScanFinished","indexOf","stopImmediatePropagation","character","Date","now","clearTimeout","setTimeout","longPressTimer","sPasteString","event","clipboardData","window","getData","isScanInProgressFor","isAttachedTo","erpnext","PointOfSale","ItemSelector","[object Object]","ref","wrapper","events","pos_profile","hide_images","settings","auto_add_item","auto_add_item_to_cart","inti_component","prepare_dom","make_search_bar","load_items_data","bind_events","attach_shortcuts","append","$component","find","$items_container","item_group","const","res","frappe","db","get_value","lft","is_group","parent_item_group","name","price_list","selling_price_list","get_items","then","render_item_list","items","doc","get_frm","method","freeze","args","start","page_length","search_term","html","item","item_html","get_item_html","me","indicator_color","actual_qty","precision","flt","price_list_rate","qty_to_display","Math","round","toFixed","escape","item_code","serial_no","batch_no","stock_uom","item_image","get_abbr","item_name","ellipsis","format_currency","currency","$img","item_abbr","$","attr","parent","replaceWith","search_field","ui","form","make_control","df","label","__","fieldtype","placeholder","render_input","item_group_field","onchange","value","filter_items","get_query","query","filters","toggle_label","$input","val","trigger","sScancode","is","set_focus","set_search_value","barcode_scanned","on","$item","unescape","uom","rate","item_selected","field","last_search","target","ctrl_label","utils","is_mac","keys","add_shortcut","shortcut","action","condition","description","ignore_inputs","page","cur_page","click","play_sound","show_alert","indicator","search_index","add_filtered_item_to_cart","barcode","minimize","css","show","ItemCart","customer_info","allowed_customer_groups","customer_groups","allow_rate_change","allow_discount_change","init_component","init_child_components","init_customer_selector","init_cart_components","$customer_section","make_customer_selector","set_value","customer_field","$cart_container","make_cart_totals_section","make_cart_items_section","make_cart_numpad","$cart_header","$cart_items_wrapper","make_no_items_placeholder","$totals_section","get_discount_icon","$add_discount_elem","$numpad_section","number_pad","NumberPad","numpad_event","on_numpad_event","bind","cols","css_classes","fieldnames_map","Quantity","Discount","prepend","reset_customer_selector","toggle_customer_info","closest","$cart_item","toggle_item_highlight","item_row_name","cart_item_clicked","numpad_value","checkout","toggle_checkout_btn","removeClass","edit_cart","can_edit_discount","discount_field","show_discount_control","frm","update_totals_section","let","btn","shortcut_key","scrub","fieldname","fieldnames","shortcut_label","split","map","to_title_case","join","replace","item_is_selected","row","item_cart_visible","checkout_btn_invisible","item_is_highlighted","not","allowed_customer_group","customer_group","dom","model","doctype","script_manager","run_serially","fetch_customer_details","customer_details_updated","update_customer_section","unfreeze","customer","Promise","resolve","loyalty_program","silent","callback","r","exc","loyalty_points","conversion_factor","padding","border","discount","additional_discount_percentage","input_class","hide_discount_control","bold","get_customer_image","email_id","mobile_no","image","render_net_total","net_total","grand_total","cint","sys_defaults","disable_rounded_total","rounded_total","render_grand_total","render_taxes","taxes","taxes_html","t","test","tax_amount_after_discount_amount","item_selector","remove_item","get_cart_item","next","remove","item_row","get_item_from_frm","render_cart_item","no_of_cart_items","highlight_checkout_btn","update_empty_cart_section","item_data","$item_to_update","text","error","amount","rate_cols","from","max_width","reduce","elm","width","set_dynamic_rate_header_width","selector","show_checkout","toggle","background-color","$no_item_element","$btn","current_action","action_is_field_edit","includes","action_is_allowed","action_is_pressed_twice","prev_action","first_click_event","field_to_edit_changed","slice","highlight_numpad_btn","curr_action","curr_action_is_highlighted","hasClass","curr_action_is_action","addClass","reset_numpad","height","padding-top","render_customer_fields","fetch_customer_transactions","$customer_form","dfs","read_only","handle_customer_field_change","current_value","current_customer","get_list","docstatus","fields","limit","transaction_container","elapsed_time","moment","posting_date","posting_time","fromNow","invoice","posting_datetime","format","Paid","Draft","Return","Consolidated","status","off","update_item_html","attach_refresh_field_event","toggle_component","ItemDetails","current_item","$item_name","$item_description","$item_price","$item_image","$form_container","$dicount_section","current_item_changed","compare_with_current_item","hide_item_details","Boolean","toggle_item_selector","item_meta","get_meta","render_dom","render_discount_dom","render_form","highlight_cart_item","validate_serial_batch_item","serialized","has_serial_no","batched","has_batch_no","no_serial_selected","no_batch_selected","remove_item_from_cart","substr","discount_percentage","fields_to_display","get_form_fields","idx","field_meta","form_updated","make_auto_serial_selection_btn","bind_custom_control_change_event","push","rate_control","get_doc","refresh","discount_percentage_control","warehouse_control","reqd","item_stock_map","get_item_stock_map","available_qty","get_available_stock","bold_item_code","bold_warehouse","throw","actual_qty_control","company","serial_no_control","async","auto_update_batch_no","batch_no_control","warehouse","uom_control","conversion_factor_control","field_control","cur_pos","update_cart_html","selected_serial_nos","filter","s","batch_serial_map","acc","batch_serial_nos","serial_nos_belongs_to_other_batch","qty_control","clone_new_batch_item_in_frm","bind_auto_serial_fetch_event","bind_fields_to_numpad_fields","close_item_details","last_field_focused","item_field_focused","expiry_date","numbers","batch_nos","for_doctype","data","auto_fetched_serial_numbers","records_length","msgprint","a","a2","number","j","Payment","initialize_numpad","$payment_modes","$totals","$numpad","$invoice_fields_section","invoice_fields","$invoice_fields","df_events","has_handlers","docname","on_numpad_clicked","button_value","selected_mode","get","focus","mode_clicked","scrollLeft","offset","left","animate","mode","auto_set_remaining_amount","contact","contact_mobile","request_button","request_for_payment_field","setup_listener_for_payments","paid_amount","submit_invoice","is_cash_shortcuts_invisible","attach_cash_shortcuts","render_payment_mode_dom","formatted_currency","loyalty_amount","cdt","cdn","default_mop","locals","mode_of_payment","realtime","title","success","cur_frm","reload_doc","failure_message","remaining_amount","payment_is_visible","active_mode","mode_of_payments","m","mode_index","next_mode_index","next_mode_to_be_clicked","make_invoice_fields_control","focus_on_default_mop","toggle_other_sections","render_payment_section","$remarks","payments","p","payment_type","type","render_loyalty_points_payment_mode","default","shortcuts","get_cash_shortcuts","shortcuts_html","after","steps","digits","x","finalArr","nearest_x","ceil","get_nearest","get_customer_details","max_redeemable_amount","children","redeem_loyalty_points","remaining","change","change_amount","PastOrderList","make_filter_section","$invoices_container","refresh_list","status_field","invoice_name","open_invoice_data","reset_summary","response","invoice_html","get_invoice_html","PastOrderSummary","init_email_print_dialog","$summary_wrapper","$summary_container","$upper_section","$totals_container","$payment_container","$summary_btns","email_dialog","Dialog","primary_action","send_email","primary_action_label","print_dialog","print_receipt","in_list","discount_amount","payment","process_return","edit_order","delete_order","show_summary_placeholder","new_order","fields_dict","customer_email","print","pos_print_format","letter_head","language","boot","lang","recipients","get_values","print_format","subject","meta","sender_full_name","user","full_name","_lang","escape_html","hide","visible_btns","b","class_name","last","after_submission","is_return","toggle_summary_placeholder","attach_document_info","attach_items_info","attach_totals_info","attach_payments_info","condition_btns_map","get_condition_btn_map","add_summary_btns","upper_section_dom","get_upper_section_html","item_dom","payment_dom","get_payment_html","net_total_dom","get_net_total_html","taxes_dom","get_taxes_html","discount_dom","get_discount_html","grand_total_dom","get_grand_total_html","Controller","check_opening_entry","session","fetch_opening_entry","prepare_app_defaults","create_opening_voucher","table_fields","in_list_view","dialog","balance_details","some","d","opening_amount","grid","static","defaults","get_default","pos_profile_query","pay","cannot_add_rows","in_place_edit","pos_opening","pos_opening_time","period_start_date","allow_negative_stock","profile","assign","group","make_app","set_title_sub","prepare_components","prepare_menu","make_new_invoice","$components_wrapper","init_item_selector","init_item_details","init_item_cart","init_payments","init_recent_order_list","init_order_summary","clear_menu","add_menu_item","open_form_view","toggle_recent_order","save_draft_invoice","close_pos","sync","set_route","recent_order_list","toggle_recent_order_list","save","voucher","get_new_doc","pos_opening_entry","period_end_date","datetime","now_datetime","now_date","on_cart_update","cart","item_details","toggle_item_details_section","update_item_field","details","customer_details","resize_selector","toggle_numpad","cart_item","toggle_numpad_field_edit","set_value_in_current_cart_item","update_selector_value_in_cart_item","batch","item_to_clone","new_row","add_child","savesubmit","toggle_components","order_summary","load_summary_of","make_return_invoice","load_invoice","delete_doc","make_sales_invoice_frm","set_pos_profile_data","set_pos_profile_status","get_new_frm","is_pos","with_doctype","_frm","Form","make_new_doc_and_get_name","source_name","target_doc","set_indicator","item_row_exists","isEmptyObject","from_selector","qty_needed","check_stock_availability","set_warehouse","is_current_item_being_edited","raise_customer_selection_alert","new_item","check_serial_no_availablilty","trigger_new_item_events","edit_item_details_of","check_serial_batch_selection_needed","console","log","bold_available_qty","toString","clear_doc","field_or_action","catch"],"mappings":"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"}